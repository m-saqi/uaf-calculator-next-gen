<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>UAF CGPA Calculator - M Saqlain | Automatic & Accurate</title>
  <meta name="description" content="The Best UAF CGPA Calculator. Automatically fetches results from UAF LMS & Attendance System to calculate your exact CGPA and percentage." />
  <meta name="application-name" content="UAF CGPA Calculator (M Saqlain)"/>
  <meta name="keywords" content="UAF CGPA Calculator, uaf cgpa calculator, cgpa calculator uaf, uaf gpa calculator, university of agriculture faisalabad cgpa calculator, uaf lms cgpa calculator, uaf cgpa calculator saqlain, uaf result calculator, uaf cgpa calculator by registration number, calculate uaf cgpa" />
  <meta name="author" content="Muhammad Saqlain - developer UAF CGPA Calculator" />
  <link rel="canonical" href="https://uafcgpacalculator.vercel.app/" />
  <meta name="google-site-verification" content="google3e44586abf077c1e" />
  <meta name="google-site-verification" content="zClcBWKWCeJyEGq-plDV2JvodudE4m_t8OK4sBMj8aw" />
  <meta name="seobility" content="cd77ca0904bfbf84899beb294c0d8179">

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#7a6ad8">

  <meta property="og:title" content="UAF CGPA Calculator - M Saqlain | Automatic & Accurate" />
  <meta property="og:description" content="The Best UAF CGPA Calculator - Enter your registration number to automatically fetch and calculate your University of Agriculture Faisalabad (UAF) CGPA, GPA, and percentage. Download PDF transcript instantly." />
  <meta property="og:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="og:site_name" content="UAF CGPA Calculator by M Saqlain" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="en_PK" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta name="twitter:title" content="UAF CGPA Calculator by M Saqlain - Instant GPA & Percentage" />
  <meta name="twitter:description" content="Calculate your CGPA automatically by registration number. The best tool by M Saqlain for the University of Agriculture Faisalabad (UAF) students. Instant results with PDF download." />
  <meta name="twitter:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />
  <meta name="twitter:creator" content="M Saqlain" />

  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MJW7HPPS');</script>

  <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "UAF CGPA Calculator - M Saqlain",
  "url": "https://uafcgpacalculator.vercel.app/",
  "applicationCategory": "EducationalApplication",
  "description": "The best UAF CGPA Calculator for University of Agriculture Faisalabad (UAF) students. Automatically fetch results by registration number and calculate CGPA, GPA, and percentage.",
  "operatingSystem": "Web Browser",
  "browserRequirements": "Requires a modern web browser with JavaScript enabled.",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "PKR"
  },
  "screenshot": "https://uafcgpacalculator.vercel.app/uafcgpacalculator.png",
  "featureList": [
    "Automatic result fetching by registration number",
    "CGPA, GPA abd marks percentage calculation",
    "Semester-wise grade analysis",
    "PDF transcript download",
    "LMS & Attendance System integration",
    "Multiple profile management",
    "Local Profile Backup System integration",
    "Dark mode support"
  ],
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.9",
    "ratingCount": "1450",
    "bestRating": "5",
    "worstRating": "1"
  },
  "creator": {
    "@type": "Person",
    "name": "Muhammad Saqlain",
    "alternateName": "M Saqlain",
    "url": "https://uafcgpacalculator.vercel.app",
    "image": "https://uafcgpacalculator.vercel.app/assets/images/developer-uaf-cgpa-calculator-m-saqlain.webp",
    "jobTitle": "Developer & Chemistry Graduate",
    "worksFor": {
      "@type": "Organization",
      "name": "UAF CGPA Calculator by M Saqlain"
    },
    "alumniOf": {
      "@type": "Organization",
      "name": "University of Agriculture Faisalabad (UAF)",
      "sameAs": "https://uaf.edu.pk"
    },
    "sameAs": [
      "httpsM_Saqlain_Akbar",
      "https://www.linkedin.com/in/muhammad-saqlain-akbar/"
    ],
    "knowsAbout": [
      "UAF CGPA Calculator",
      "University of Agriculture Faisalabad (UAF) Grading System",
      "Quality Points Calculator",
      "Academic GPA Calculation"
    ]
  },
  "provider": {
    "@type": "Organization",
    "name": "UAF CGPA Calculator by M Saqlain",
    "url": "https://uafcgpacalculator.vercel.app",
    "logo": "https://uafcgpacalculator.vercel.app/uafcgpacalculator.png",
    "sameAs": [
      "https://www.facebook.com/UAFChemist.Rustam",
      "https://x.com/M_Saqlain_Akbar",
      "https://www.linkedin.com/in/muhammad-saqlain-akbar/"
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "Developer Support",
      "url": "https://uafcgpacalculator.vercel.app#contact-us"
    }
  },
  "mainEntity": [
    {
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "How does the UAF CGPA Calculator work?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The UAF CGPA Calculator by Saqlain securely connects to the public UAF LMS & Attendance System portal using your registration number. It fetches your official results, processes the grades and credit hours according to the official UAF grading formula, and instantly calculates your precise Semester GPA and Cumulative GPA (CGPA)."
          }
        },
        {
          "@type": "Question",
          "name": "Is it safe to use my registration number?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes, it is completely safe. The calculator only requires your registration number, not your password. Your information is used only for fetching your result for the current session and is never stored or shared. The connection is secure and private."
          }
        },
        {
          "@type": "Question",
          "name": "Can I use this calculator for other universities?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "This calculator is specifically designed for the students of the University of Agriculture Faisalabad (UAF). It uses UAF's unique grading system and connects directly to the UAF LMS, so it will not work for other universities."
          }
        }
      ]
    },
    {
      "@type": "HowTo",
      "name": "How to Use the UAF CGPA Calculator?",
      "step": [
        {
          "@type": "HowToStep",
          "text": "Enter your full registration number (e.g., 2020-ag-1234) into the input field.",
          "name": "Enter Registration Number"
        },
        {
          "@type": "HowToStep",
          "text": "Click the 'Fetch Result' button to securely connect to the UAF LMS and retrieve your academic records.",
          "name": "Fetch Your Results"
        },
        {
          "@type": "HowToStep",
          "text": "View your automatically calculated CGPA, percentage, and detailed semester-wise results.",
          "name": "View Your CGPA"
        },
        {
          "@type": "HowToStep",
          "text": "Optionally, download a premium PDF of your transcript or use the forecast feature to plan for future semesters.",
          "name": "Download or Forecast"
        }
      ]
    }
  ]
}
</script>
  
  <script src="https://analytics.ahrefs.com/analytics.js" data-key="CWWh1lx4Kz/fCxT0UN7M0w" async></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- Google Font Import --- */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

    /*
    ============================================================
    PART 1: ROOT VARIABLES & CORE THEMES
    ============================================================
    */
    :root {
      --font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      
      /* --- Light Theme --- */
      --brand-primary: #7a6ad8;
      --brand-secondary: #6b5fca;
      --brand-gradient: linear-gradient(135deg, #7a6ad8 0%, #6b5fca 100%);
      --brand-gradient-hover: linear-gradient(135deg, #8a7ce8 0%, #7b6fda 100%);

      --accent-primary: #ff6b6b;
      --accent-gradient: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      
      --success-primary: #10ac84;
      --success-gradient: linear-gradient(135deg, #10ac84 0%, #0d916b 100%);
      
      --info-primary: #3498db;
      --info-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      
      --danger-primary: #e74c3c;
      --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);

      --text-primary: #1b1f24;    /* Deep black for headings */
      --text-secondary: #4b5563; /* Softer black for body text */
      --text-muted: #6b7280;     /* Muted text */
      --text-on-brand: #ffffff;  /* Text on purple buttons */

      --bg-primary: #f8f9ff;     /* Main page background */
      --bg-secondary: #ffffffc7;   /* Card background */
      --bg-glass: rgba(255, 255, 255, 0.6); /* Glass card background */
      --border-color: rgba(122, 106, 216, 0.2); /* Light purple border */

      --shadow-color: 17, 24, 39;
      --shadow-sm: 0 4px 10px rgba(var(--shadow-color), 0.05);
      --shadow-md: 0 10px 30px rgba(var(--shadow-color), 0.1);
      --shadow-lg: 0 15px 40px rgba(var(--shadow-color), 0.15);
      
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-full: 9999px;
    }

    [data-theme="dark"] {
      --brand-primary: #8a7ce8;
      --brand-secondary: #7b6fda;
      --brand-gradient: linear-gradient(135deg, #8a7ce8 0%, #7b6fda 100%);
      --brand-gradient-hover: linear-gradient(135deg, #9a8cff 0%, #8b7feA 100%);

      --accent-primary: #ff8e8e;
      --accent-gradient: linear-gradient(135deg, #ff8e8e 0%, #ff6b6b 100%);

      --success-primary: #12c29a;
      --success-gradient: linear-gradient(135deg, #12c29a 0%, #0fa57c 100%);
      
      --info-primary: #5dade2;
      --info-gradient: linear-gradient(135deg, #5dade2 0%, #3498db 100%);

      --danger-primary: #ff6b6b;
      --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);

      --text-primary: #f8f9ff;    /* Bright white for headings */
      --text-secondary: #d1d5db; /* Softer white for body */
      --text-muted: #9ca3af;     /* Muted gray */
      --text-on-brand: #ffffff;  /* Text on purple buttons */

      --bg-primary: #0b0e13;     /* Deep space black */
      --bg-secondary: #1a1e29;   /* Dark card background */
      --bg-glass: rgba(26, 30, 41, 0.6); /* Dark glass card */
      --border-color: rgba(138, 124, 232, 0.2); /* Purple border */
      
      --shadow-color: 138, 124, 232; /* Purple shadow for dark mode */
      --shadow-sm: 0 4px 10px rgba(var(--shadow-color), 0.05);
      --shadow-md: 0 10px 30px rgba(var(--shadow-color), 0.1);
      --shadow-lg: 0 15px 40px rgba(var(--shadow-color), 0.15);
    }

    /*
    ============================================================
    PART 2: BASE STYLES & FUTURISTIC BACKGROUND
    ============================================================
    */

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-primary);
      color: var(--text-secondary);
      transition: background-color 0.3s ease, color 0.3s ease;
      overflow-x: hidden;
      position: relative;
    }

    /* --- Animated Aurora Background --- */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -2;
      pointer-events: none;
      background: radial-gradient(at 20% 20%, hsla(270, 80%, 70%, 0.15) 0px, transparent 50%),
                  radial-gradient(at 80% 20%, hsla(210, 80%, 70%, 0.15) 0px, transparent 50%),
                  radial-gradient(at 20% 80%, hsla(320, 80%, 70%, 0.15) 0px, transparent 50%),
                  radial-gradient(at 80% 80%, hsla(190, 80%, 70%, 0.15) 0px, transparent 50%);
      animation: aurora-flow 20s linear infinite;
    }

    [data-theme="dark"] body::before {
      background: radial-gradient(at 20% 20%, hsla(270, 80%, 70%, 0.25) 0px, transparent 50%),
                  radial-gradient(at 80% 20%, hsla(210, 80%, 70%, 0.25) 0px, transparent 50%),
                  radial-gradient(at 20% 80%, hsla(320, 80%, 70%, 0.25) 0px, transparent 50%),
                  radial-gradient(at 80% 80%, hsla(190, 80%, 70%, 0.25) 0px, transparent 50%);
      animation: aurora-flow 15s linear infinite;
    }

    @keyframes aurora-flow {
      0% { transform: rotate(0deg) scale(1.5); }
      50% { transform: rotate(180deg) scale(2); }
      100% { transform: rotate(360deg) scale(1.5); }
    }

    /* --- Custom Scrollbar --- */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--brand-primary);
      border-radius: var(--radius-full);
      border: 2px solid var(--bg-primary);
    }
    [data-theme="dark"] ::-webkit-scrollbar-thumb {
      background-color: var(--brand-primary);
      border-color: var(--bg-primary);
    }

    /* --- General Typography --- */
    h1, h2, h3, h4, h5, h6 {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .gradient-text {
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* --- Cursor Dot (Preserved) --- */
    .cursor-dot {
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--brand-primary);
      pointer-events: none;
      transform: translate(-50%, -50%);
      opacity: .7;
      z-index: 9999;
      transition: all 0.1s ease;
      mix-blend-mode: multiply;
      display: none; /* Re-enable for desktop only */
    }
    [data-theme="dark"] .cursor-dot {
      mix-blend-mode: screen;
    }
    @media (min-width: 992px) {
      .cursor-dot {
        display: block;
      }
    }





    /*
    ============================================================
    PART 3: UTILITY & ANIMATION CLASSES
    ============================================================
    */

    .container {
      max-width: 1140px;
    }

    /* --- Fade-in Animation (Preserved from original) --- */
    .fade-in-on-scroll {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .fade-in-on-scroll.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* --- Back to Top Button (Preserved) --- */
    #backToTop {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: var(--radius-full);
      background: var(--brand-gradient);
      color: var(--text-on-brand);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
      z-index: 1000;
      border: 2px solid var(--bg-primary);
    }
    #backToTop.visible {
      opacity: 1;
      visibility: visible;
    }
    #backToTop:hover {
      background: var(--brand-gradient-hover);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    [data-theme="dark"] #backToTop {
      border-color: var(--bg-secondary);
    }

    /*
    ============================================================
    PART 4: FUTURISTIC GLASS CARDS
    ============================================================
    */
    .card-glass {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      overflow: hidden; /* Important for card structure */
    }

    .card-glass:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: rgba(122, 106, 216, 0.4);
    }

    .card-glass .card-header {
      background: linear-gradient(135deg, rgba(122, 106, 216, 0.1), rgba(122, 106, 216, 0.05));
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }
    
    .card-glass .card-body {
      padding: 1.5rem;
    }
    
    .card-glass .card-footer {
      background: rgba(122, 106, 216, 0.05);
      border-top: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }
    
    [data-theme="dark"] .card-glass .card-header {
      background: linear-gradient(135deg, rgba(138, 124, 232, 0.15), rgba(138, 124, 232, 0.05));
    }

    /*
    ============================================================
    PART 5: PREMIUM BUTTON STYLES
    ============================================================
    */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 0.95rem;
      border: 0;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      text-decoration: none;
      white-space: nowrap;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .btn:active {
      transform: translateY(0px);
      box-shadow: var(--shadow-sm);
    }
    .btn i {
      font-size: 0.9em;
    }
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    .btn-lg {
      padding: 1rem 2rem;
      font-size: 1.1rem;
    }
    .btn.rounded-pill {
        border-radius: var(--radius-full); /* Ensure it's always pill-shaped */
    }

    /* --- Primary Action Button (Brand) --- */
    .btn-primary-action {
      background: var(--brand-gradient);
      color: var(--text-on-brand);
      box-shadow: 0 6px 20px rgba(122, 106, 216, 0.3);
    }
    .btn-primary-action:hover {
      background: var(--brand-gradient-hover);
      color: var(--text-on-brand);
      box-shadow: var(--shadow-lg);
    }

    /* --- Secondary Action Button (Ghost/Glass) --- */
    .btn-secondary-action {
      background: var(--bg-glass);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }
    .btn-secondary-action:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--brand-primary);
    }
    [data-theme="dark"] .btn-secondary-action {
      background: var(--bg-glass);
      color: var(--text-primary);
    }

    /* --- Other Color Buttons --- */
    .btn-success-action {
      background: var(--success-gradient);
      color: var(--text-on-brand);
      box-shadow: 0 6px 20px rgba(16, 172, 132, 0.2);
    }
    .btn-info-action {
      background: var(--info-gradient);
      color: var(--text-on-brand);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.2);
    }
    .btn-danger-action {
      background: var(--danger-gradient);
      color: var(--text-on-brand);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.2);
    }

    /*
    ============================================================
    PART 6: MODERN FORM STYLES
    ============================================================
    */
    .form-control,
    .form-select {
      background: var(--bg-glass);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .form-control:focus,
    .form-select:focus {
      background: var(--bg-secondary);
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 4px rgba(122, 106, 216, 0.2);
      outline: none;
    }
    .form-control::placeholder {
      color: var(--text-muted);
    }
    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    .form-text {
      color: var(--text-muted);
    }
    .input-group {
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }
    .input-group .form-control {
      border-radius: var(--radius-md) 0 0 var(--radius-md);
    }
    .input-group-text {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-right: 0;
      color: var(--brand-primary);
      border-radius: var(--radius-md) 0 0 var(--radius-md);
    }
    .input-group .btn {
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
      z-index: 10;
    }

    /* --- Custom Checkbox/Switch --- */
    .form-check-input {
      border-color: var(--border-color);
      background-color: var(--bg-glass);
    }
    .form-check-input:checked {
      background-color: var(--brand-primary);
      border-color: var(--brand-primary);
    }
    .form-switch .form-check-input {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%236b7280'/%3e%3c/svg%3e");
      background-position: left center;
      transition: background-position 0.15s ease-in-out;
    }
    [data-theme="dark"] .form-switch .form-check-input {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23d1d5db'/%3e%3c/svg%3e");
    }
    .form-switch .form-check-input:checked {
      background-position: right center;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23ffffff'/%3e%3c/svg%3e");
    }



/*
    ============================================================
    PART 7: FUTURISTIC HEADER (NAVBAR)
    ============================================================
    */
    .navbar-v2 {
      position: sticky;
      top: 1rem; /* Stick 1rem from the top */
      margin: 0 auto;
      width: clamp(300px, 95%, 700px); /* Responsive width */
      z-index: 1050;
      border-radius: var(--radius-full);
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    
    .navbar-v2 .container-fluid {
      display: flex;
      justify-content: center; /* Center the nav items wrapper */
    }

    .navbar-v2 .navbar-nav {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .navbar-v2 .nav-item {
      flex: 1; /* Make items grow to fill space */
      text-align: center;
    }

    .navbar-v2 .nav-link {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.9rem;
      border-radius: var(--radius-full);
      padding: 0.75rem 0.5rem; /* Vertical padding, minimal horizontal */
      position: relative;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.1rem;
    }
    .navbar-v2 .nav-link i {
      font-size: 1rem;
      line-height: 1;
    }
    .navbar-v2 .nav-link span {
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* --- Active/Hover State --- */
    .navbar-v2 .nav-link.active {
      color: #fff;
      background: #7a6ad8e5;
      box-shadow: var(--shadow-sm);
    }

    .navbar-v2 .nav-link:hover {
      color: #234;
      background: #fff;
      box-shadow: var(--shadow-sm);
    }
    
    [data-theme="dark"] .navbar-v2 .nav-link:hover,
    [data-theme="dark"] .navbar-v2 .nav-link.active {
       background: var(--bg-glass);
    }

    /* --- Theme Toggle --- */
    .theme-toggle-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.75rem 0.5rem;
      border-radius: var(--radius-full);
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.1rem;
      transition: all 0.3s ease;
    }
    .theme-toggle-btn:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
      box-shadow: var(--shadow-sm);
    }
    .theme-toggle-btn i {
      font-size: 1rem;
      line-height: 1;
    }
    .theme-toggle-btn span {
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Hide the <span> text on mobile */
    @media (max-width: 576px) {
      .navbar-v2 {
        padding: 0.25rem 0.5rem;
        width: calc(100% - 2rem); /* Add some side margin */
      }
      .navbar-v2 .nav-link {
        padding: 0.75rem 0.25rem;
      }
      .navbar-v2 .nav-link span,
      .theme-toggle-btn span {
        display: none;
      }
      .navbar-v2 .nav-link i,
      .theme-toggle-btn i {
        font-size: 1.2rem;
      }
    }

    /*
    ============================================================
    PART 8: HERO SECTION
    ============================================================
    */
    .hero-section {
      padding: 6rem 0 4rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .hero-section .badge {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      color: var(--brand-primary);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .hero-section h1 {
      font-size: clamp(2.5rem, 4vw, 4.5rem);
      font-weight: 800;
      line-height: 1.2;
      margin-top: 1rem;
      color: var(--text-primary);
    }
    .hero-section h1 .gradient-text {
      display: inline-block; /* Fixes wrap issues */
    }

    .hero-section .lead {
      font-size: clamp(1rem, 2.5vw, 1.25rem);
      color: var(--text-secondary);
      max-width: 700px;
      margin: 1.5rem auto 2rem;
    }
    
    .hero-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* --- Hero Feature Card (Right Side) --- */
    .hero-feature-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(20px);
      text-align: left;
      padding: 1.5rem;
    }
    
    .hero-feature-card .card-header-icon {
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      border-radius: var(--radius-md);
      background: var(--brand-gradient);
      color: var(--text-on-brand);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .hero-feature-card hr {
      border-color: var(--border-color);
      opacity: 0.5;
    }
    
    .hero-feature-card .list-unstyled li {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    .hero-feature-card .list-unstyled li i {
      color: var(--success-primary);
      margin-top: 0.25rem;
    }

    @media (max-width: 991.98px) {
      .hero-section {
        padding: 8rem 0 3rem;
      }
      .hero-feature-card {
        margin-top: 2rem;
      }
    }


    @media (max-width: 576px) {
  .hero-section {
    padding: 5rem 0 3rem;
  }
}
    
    
    /*
    ============================================================
    PART 9: ANNOUNCEMENT BAR (Preserved)
    ============================================================
    */
    .announcement-bar {
      background: var(--brand-gradient);
      color: white;
      padding: 0.75rem 0;
      overflow: hidden;
      white-space: nowrap;
      box-shadow: var(--shadow-sm);
    }
    .announcement-track {
      display: inline-block;
      animation: scroll-left 30s linear infinite;
    }
    .announcement-text {
      display: inline-block;
      font-weight: 500;
      margin: 0 2.5rem;
      opacity: 0.9;
    }
    @keyframes scroll-left {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-50%); }
    }
    
    /*
    ============================================================
    PART 10: CALCULATOR INPUT SECTION
    ============================================================
    */
    .calculator-section {
      padding: 3rem 0;
      position: relative;
    }

    .calculator-section .section-header {
      text-align: center;
      margin-bottom: 2rem;
      margin-top: 25px;
    }
    .calculator-section .section-header h2 {
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      font-weight: 800;
    }
    
    /* --- Main Search Input --- */
    .search-and-profiles-container {
      max-width: 650px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
    }
    
    .modern-search-wrapper {
      position: relative;
      width: 100%;
    }
    
    .modern-search-input {
      font-size: 1.1rem;
      font-weight: 500;
      padding: 1.15rem 1.5rem;
      padding-right: 180px; /* Space for button */
      border-radius: var(--radius-full);
      border: 1px solid var(--border-color);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-sm);
    }
    
    .modern-search-button {
      position: absolute;
      top: 40%;
      right: 8px;
      transform: translateY(-35%);
      font-size: 1rem;
    }
    
    /* --- Profile & Data Buttons --- */
    .profile-data-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }
    .profile-data-buttons .btn {
      font-size: 0.9rem;
      padding: 0.6rem 1.25rem;
    }

    /* --- Profile Switcher --- */
    #profileManagement {
      width: 100%;
    }
    #profileManagement .input-group {
      border-radius: var(--radius-full);
      border: 1px solid var(--border-color);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    #profileManagement .input-group-text,
    #profileManagement .form-select,
    #profileManagement .btn {
      border: none;
      background: transparent;
      backdrop-filter: none;
    }
    #profileManagement .input-group-text {
      color: var(--brand-primary);
      padding-left: 1.25rem;
    }
    #profileManagement .form-select {
      color: var(--text-primary);
      font-weight: 500;
      box-shadow: none;
    }
    #profileManagement .btn {
      border-radius: 0 var(--radius-full) var(--radius-full) 0;
      background: var(--brand-gradient);
      color: var(--text-on-brand);
      padding-left: 1.25rem;
      padding-right: 1.25rem;
    }
    #profileManagement .btn:hover {
      background: var(--brand-gradient-hover);
      box-shadow: none;
      transform: none;
    }
    
    /* --- Responsive Search Input and Profile Data button--- */
    @media (max-width: 576px) {
      .modern-search-input {
        padding-right: 75px; /* Space for icon-only button */
        font-size: 1rem;
      }
      .modern-search-button {
        width: 50px;
        height: 50px;
        padding: 0;
      }
      .modern-search-button span {
        display: none;
      }
      .modern-search-button i {
        font-size: 1.1rem;
      }
      .profile-data-buttons .btn {
         font-size: .75rem;
         padding: 0.5rem 1rem;
      }
    }


/*
    ============================================================
    PART 11: LOADING & STATUS INDICATORS
    ============================================================
    */

    /* --- Loading Container --- */
    .loading-container {
      margin-top: 1.5rem;
      text-align: center;
      padding: 3rem 2rem;
      border-radius: var(--radius-lg);
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      display: none;
      backdrop-filter: blur(10px);
    }
    .loading-stage {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* --- New Pulsar Animation --- */
    .loading-animation {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      position: relative;
    }
    .pulsar {
      width: 80px;
      height: 80px;
      position: relative;
    }
    .pulsar .ring {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 4px solid var(--brand-primary);
      border-radius: 50%;
      opacity: 0;
      animation: pulsar-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }
    .pulsar .ring:nth-child(2) {
      animation-delay: 0.5s;
    }
    .pulsar .dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      background: var(--brand-primary);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px var(--brand-primary);
    }
    @keyframes pulsar-ring {
      0% {
        transform: scale(0.1);
        opacity: 0;
      }
      70% {
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 0;
      }
    }
    
    /* --- Checkmark Animation --- */
    .loading-complete .checkmark {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loading-complete .checkmark-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--success-primary);
      animation: check-pop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }
    .loading-complete .checkmark-icon {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f00c";
      font-size: 2.5rem;
      color: white;
      position: absolute;
      opacity: 0;
      transform: scale(0.5);
      animation: check-icon 0.5s 0.2s ease-out forwards;
    }
    @keyframes check-pop {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }
    @keyframes check-icon {
      0% { opacity: 0; transform: scale(0.5); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .loading-text {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .loading-subtext {
      color: var(--text-muted);
      font-size: 0.9rem;
      max-width: 400px;
      margin: 0 auto;
    }

    /* --- Server Status Indicator (Preserved) --- */
    .server-status-indicator {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      display: flex;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-full);
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      font-size: 0.8rem;
      font-weight: 600;
      z-index: 10;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .status-dot.online {
      background-color: var(--success-primary);
      box-shadow: 0 0 8px var(--success-primary);
      animation: pulse-green 1.5s infinite;
    }
    .status-dot.offline {
      background-color: var(--danger-primary);
      box-shadow: 0 0 8px var(--danger-primary);
      animation: pulse-red 1.5s infinite;
    }
    .status-info-icon {
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .status-info-icon:hover { color: var(--brand-primary); }
    
    .status-content-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-label { display: none; } /* Hide label by default */
    .infinity-loader {
      width: 28px;
      height: 12px;
      position: relative;
    }
    .infinity-loader::before,
    .infinity-loader::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--text-muted);
      animation: infinity-spin 1.8s infinite ease-in-out;
    }
    .infinity-loader::after {
      left: auto;
      right: 0;
      animation-delay: -0.9s;
    }
    @keyframes infinity-spin {
      0%, 100% { transform: scale(0.8); opacity: 0.7; }
      50% { transform: scale(1); opacity: 1; }
    }
    
    .status-item.status-loaded .infinity-loader { display: none; }
    .status-item.status-loaded .status-label { display: inline; }
    
    @keyframes pulse-green {
      0% { box-shadow: 0 0 5px rgba(16, 172, 132, 0.7); }
      50% { box-shadow: 0 0 12px rgba(16, 172, 132, 1); }
      100% { box-shadow: 0 0 5px rgba(16, 172, 132, 0.7); }
    }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.7); }
      50% { box-shadow: 0 0 12px rgba(231, 76, 60, 1); }
      100% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.7); }
    }
    
    @media (max-width: 576px) {
      .server-status-indicator {
        top: 0.5rem;
        right: 0.5rem;
      }
      .status-label { display: none; } /* Always hide label on mobile */
      .status-item.status-loaded .infinity-loader { display: none; }
    }

    /*
    ============================================================
    PART 12: TOAST NOTIFICATIONS (Preserved)
    ============================================================
    */
    #toast-container {
      position: fixed;
      top: 6rem; /* Position below new navbar */
      right: 1.5rem;
      z-index: 9999;
      display: flex;
      flex-direction: column-reverse;
      gap: 1rem;
    }
    .toast {
      background: var(--bg-glass);
      border-radius: var(--radius-md);
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(120%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast-success { border-left: 4px solid var(--success-primary); }
    .toast-error { border-left: 4px solid var(--danger-primary); }
    .toast-warning { border-left: 4px solid #f39c12; }
    .toast-info { border-left: 4px solid var(--info-primary); }

    .toast-content { display: flex; align-items: center; width: 100%; }
    .toast-icon { margin-right: 1rem; font-size: 1.25rem; }
    .toast-success .toast-icon { color: var(--success-primary); }
    .toast-error .toast-icon { color: var(--danger-primary); }
    .toast-warning .toast-icon { color: #f39c12; }
    .toast-info .toast-icon { color: var(--info-primary); }

    .toast-message {
      flex: 1;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    [data-theme="dark"] .toast-message { color: var(--text-secondary); }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 100%;
      background: rgba(0, 0, 0, 0.1);
      transform: scaleX(1);
      transform-origin: left;
      animation: toastProgress 3s linear forwards;
    }
    .toast-success .toast-progress { background: var(--success-primary); }
    .toast-error .toast-progress { background: var(--danger-primary); }
    .toast-warning .toast-progress { background: #f39c12; }
    .toast-info .toast-progress { background: var(--info-primary); }
    @keyframes toastProgress {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }
    @media (max-width: 576px) {
      #toast-container {
        top: 5.5rem;
        right: 1rem;
        left: 1rem;
        width: auto;
      }
      .toast {
        min-width: 0;
        width: 100%;
      }
    }

    /*
    ============================================================
    PART 13: RESULTS DISPLAY SECTION
    ============================================================
    */
    .result-container {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    /* --- Premium CGPA Display (Preserved & Enhanced) --- */
    .gpa-result-card-premium {
      background: var(--bg-glass);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
      margin-top: 2rem;
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
      position: relative;
    }
    .student-info-header {
      text-align: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }
    .student-info-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .student-info-header p {
      color: var(--text-muted);
      font-weight: 500;
    }
    .cgpa-dashboard {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    .cgpa-progress-circle {
      width: 180px;
      height: 180px;
      position: relative;
    }
    .cgpa-progress-circle svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }
    .cgpa-progress-circle .circle-bg {
      fill: none;
      stroke: var(--border-color);
      stroke-width: 4;
    }
    .cgpa-progress-circle .circle {
      fill: none;
      stroke: var(--brand-primary);
      stroke-width: 3.6;
      stroke-linecap: round;
      transition: stroke-dasharray 1s cubic-bezier(0.215, 0.61, 0.355, 1);
    }
    .cgpa-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .cgpa-progress-text .cgpa-value {
      font-size: 2.25rem;
      font-weight: 800;
      line-height: 1;
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .cgpa-progress-text .cgpa-label {
      display: block;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    .secondary-stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
    }
    .stat-item {
      text-align: center;
    }
    .stat-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      display: block;
      margin-bottom: 0.5rem;
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .stat-sub-value {
      font-size: 1rem;
      color: var(--text-muted);
    }
    .stat-divider {
      width: 1px;
      background: var(--border-color);
    }

    @media (max-width: 576px) {
      .gpa-result-card-premium { padding: 1.5rem; }
      .cgpa-progress-circle { width: 150px; height: 150px; }
      .cgpa-progress-text .cgpa-value { font-size: 1.8rem; }
      .secondary-stats { gap: 1rem; }
      .stat-value { font-size: 1.25rem; }
    }


/*
    ============================================================
    PART 14: RESULT ACTION BUTTONS & TABS
    ============================================================
    */

    /* --- "Fetch Attendance" Button Container --- */
    .attendance-fetch-container {
      margin-top: 1.5rem;
      text-align: center;
    }
    .attendance-fetch-container p {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    /* --- Main Action Buttons (PDF, Forecast) --- */
    .action-buttons-aligned {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }

    /* --- B.Ed. Tabs (Preserved & Enhanced) --- */
    #bedTab {
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1.5rem;
      margin-top: 48px;
    }
    #bedTab .nav-link {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-muted);
      border: none;
      border-bottom: 3px solid transparent;
      padding: 0.75rem 1rem 1rem 1rem;
      transition: all 0.3s ease;
    }
    #bedTab .nav-link.active {
      color: var(--brand-primary);
      border-bottom-color: var(--brand-primary);
      background-color: transparent;
    }
    #bedTab .nav-link:hover:not(.active) {
      color: var(--text-primary);
      border-bottom-color: var(--border-color);
    }
    @media (max-width: 420px) {
      #bedTab .nav-link {
        font-size: 0.9rem;
        padding-left: 0.4rem;
        padding-right: 0.4rem;
        margin-top: -16px;
      }
      #bedTab .nav-link i {
        margin-right: 0.2rem;
      }
    }

    /*
    ============================================================
    PART 15: COLLAPSIBLE CONTAINERS (CHART & LOG)
    ============================================================
    */
    .collapsible-card-header a {
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-decoration: none;
      color: var(--text-primary);
    }
    .collapsible-card-header a h4 {
      margin-bottom: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .collapsible-card-header a i {
      color: var(--text-primary);
    }
    .collapsible-card-header .chevron-icon {
      transition: transform 0.3s ease-in-out;
    }
    .collapsible-card-header a[aria-expanded="true"] .chevron-icon {
      transform: rotate(180deg);
    }
    
    /* --- Status Log Specifics (Preserved) --- */
    .status-log {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.05);
      border-radius: var(--radius-md);
      padding: 1rem;
      font-family: monospace;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    [data-theme="dark"] .status-log {
      background: rgba(0, 0, 0, 0.2);
    }
    .status-line {
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      word-break: break-word;
    }
    .status-line:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }
    .status-success { color: var(--success-primary); }
    .status-error { color: var(--danger-primary); }
    .status-warning { color: #f39c12; }
    .status-info { color: var(--info-primary); }


    .d-block {  display: flex !important; }


    /*
    ============================================================
    PART 16: SEMESTER RESULTS GRID & CARDS
    ============================================================
    */
    .semester-results-container {
      width: 100%;
    }
    .semester-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      width: 100%;
    }
    @media (min-width: 992px) {
      .semester-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* --- Semester Card --- */
    .semester-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      position: relative;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .semester-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: rgba(122, 106, 216, 0.4);
    }
    
    .semester-card h5 {
      font-weight: 700;
      color: var(--text-primary);
    }
    .semester-card .gpa-display {
      text-align: right;
      flex-shrink: 0;
    }
    .semester-card .gpa-display .gpa-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--brand-primary);
      margin-top: 30px;
    }
    .semester-card .gpa-display .gpa-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0;
    }

    /* --- Card Action Icons --- */
    .semester-card-actions {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      gap: 0.25rem;
      z-index: 10;
    }
    .semester-card-actions .action-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    .semester-card-actions .action-icon:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      transform: scale(1.1);
    }
    .semester-card-actions .action-icon.delete-semester:hover {
      color: var(--danger-primary);
      border-color: var(--danger-primary);
    }
    .semester-card-actions .action-icon.add-course-btn:hover {
      color: var(--success-primary);
      border-color: var(--success-primary);
    }
    .semester-card-actions .action-icon.edit-semester-name:hover {
      color: var(--info-primary);
      border-color: var(--info-primary);
    }

    /* --- Custom Course Button (in card) --- */
    .custom-course-btn {
      background: var(--bg-glass);
      color: var(--brand-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 1rem;
    }
    .custom-course-btn:hover {
      background: var(--brand-gradient);
      color: var(--text-on-brand);
      border-color: transparent;
    }

    /*
    ============================================================
    PART 17: UNDO NOTIFICATION & IMAGE LIGHTBOX
    ============================================================
    */

    /* --- Undo Notification (Preserved) --- */
    .undo-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 10000;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      width: calc(100% - 40px);
      max-width: 400px;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .undo-btn {
      padding: 0.35rem 0.75rem;
      font-size: 0.85rem;
      background: var(--brand-gradient);
      color: var(--text-on-brand);
    }
    
    @media (max-width: 576px) {
      .undo-notification {
        bottom: 70px; /* Raise above mobile browser UI */
      }
    }

    /* --- Image Lightbox (Preserved & Enhanced) --- */
    .zoomable-image-container {
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md);
      display: block;
      line-height: 0;
      cursor: pointer;
    }
    .zoomable-image-container img {
      width: 100%;
      height: auto;
      border-radius: var(--radius-md);
    }
    .zoomable-image-container::after {
      content: '\f00e'; /* zoom-in */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 0.5rem 0.6rem;
      border-radius: var(--radius-sm);
      font-size: 1.1rem;
      z-index: 5;
      pointer-events: none;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    .zoomable-image-container:hover::after {
      opacity: 1;
    }

    .image-lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1070;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      overflow: hidden;
    }
    .image-lightbox.show {
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }
    .lightbox-content {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .lightbox-content img {
      display: block;
      max-width: 95%;
      max-height: 95%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: var(--radius-sm);
      cursor: grab;
      transition: transform 0.15s ease-out;
      touch-action: none;
      user-select: none;
      -webkit-user-drag: none;
      transform-origin: center center;
    }
    .lightbox-content.desktop-zoom-active img {
      cursor: crosshair;
    }
    .lightbox-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1071;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .lightbox-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }


/*
    ============================================================
    PART 18: COURSE TABLE (Inside Semester Card)
    ============================================================
    */
    .course-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 0.5rem; /* Space between rows */
      margin-top: 1rem;
    }
    .course-table th {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      padding: 0 0.5rem 0.25rem;
      text-align: left;
      border: none;
    }
    .course-table th:nth-child(n+2) {
      text-align: center;
    }
    
    .course-table tr[draggable="true"] {
      cursor: grab;
    }
    .course-table tr[draggable="true"]:active {
      cursor: grabbing;
    }
    
    .course-table tbody tr {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease-out;
      border: 1px solid var(--border-color);
    }
    .course-table tbody tr:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
      z-index: 5;
      position: relative;
    }
    .course-table tbody tr.dragging {
      opacity: 0.5;
      background: var(--brand-gradient);
    }

    .course-table td {
      padding: 0.75rem;
      text-align: left;
      vertical-align: middle;
      border: none;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .course-table td:first-child {
      border-top-left-radius: var(--radius-md);
      border-bottom-left-radius: var(--radius-md);
      font-weight: 600;
      color: var(--text-primary);
    }
    .course-table td:last-child {
      border-top-right-radius: var(--radius-md);
      border-bottom-right-radius: var(--radius-md);
    }
    .course-table td:nth-child(n+2) {
      text-align: center;
    }
    
    /* --- Deleted/Restored Rows --- */
    .course-table tr.table-danger {
      background: rgba(231, 76, 60, 0.1);
      border-color: rgba(231, 76, 60, 0.2);
    }
    [data-theme="dark"] .course-table tr.table-danger {
      background: rgba(231, 76, 60, 0.15);
      border-color: rgba(231, 76, 60, 0.3);
    }
    .course-table tr.table-danger .course-code {
      text-decoration: line-through;
    }

    /* --- Grade Badge (Preserved & Enhanced) --- */
    .grade-badge {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 0.8rem;
    }
    .grade-A { background-color: rgba(22, 160, 133, 0.1); color: #16a085; }
    .grade-B { background-color: rgba(41, 128, 185, 0.1); color: #2980b9; }
    .grade-C { background-color: rgba(243, 156, 18, 0.1); color: #f39c12; }
    .grade-D { background-color: rgba(211, 84, 0, 0.1); color: #d35400; }
    .grade-F { background-color: rgba(192, 57, 43, 0.1); color: #c0392b; }
    .grade-P { background-color: rgba(22, 160, 133, 0.1); color: #16a085; }
    
    [data-theme="dark"] .grade-A { background-color: rgba(26, 188, 156, 0.15); color: #1abc9c; }
    [data-theme="dark"] .grade-B { background-color: rgba(52, 152, 219, 0.15); color: #3498db; }
    [data-theme="dark"] .grade-C { background-color: rgba(241, 196, 15, 0.15); color: #f1c40f; }
    [data-theme="dark"] .grade-D { background-color: rgba(230, 126, 34, 0.15); color: #e67e22; }
    [data-theme="dark"] .grade-F { background-color: rgba(231, 76, 60, 0.15); color: #e74c3c; }
    [data-theme="dark"] .grade-P { background-color: rgba(26, 188, 156, 0.15); color: #1abc9c; }

    .extra-enrolled,
    .course-table .course-code-container sup {
      padding: 2px 5px;
      border-radius: var(--radius-sm);
      font-size: 0.65rem;
      font-weight: 700;
      vertical-align: super;
      margin-left: 2px;
      background-color: rgba(243, 156, 18, 0.1);
      color: #f39c12;
    }
    [data-theme="dark"] .extra-enrolled,
    [data-theme="dark"] .course-table .course-code-container sup {
      background-color: rgba(241, 196, 15, 0.15);
      color: #f1c40f;
    }
    
    /* --- Course Action Icons (Delete/Restore) --- */
    .course-actions i {
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    .delete-course { color: var(--text-muted); }
    .delete-course:hover {
      background-color: rgba(231, 76, 60, 0.1);
      color: var(--danger-primary);
    }
    .restore-course { color: var(--text-muted); }
    .restore-course:hover {
      background-color: rgba(16, 172, 132, 0.1);
      color: var(--success-primary);
    }
    
    /* --- Drag & Drop Cues (Preserved) --- */
    @media (min-width: 992px) {
      .semester-card.drag-over {
        border: 2px dashed var(--brand-primary);
        transform: scale(1.02);
        background: rgba(122, 106, 216, 0.1);
      }
      [data-theme="dark"] .semester-card.drag-over {
        background: rgba(122, 106, 216, 0.15);
      }
    }

    /* --- Responsive Table --- */
    @media (max-width: 576px) {
      .course-table {
        font-size: 0.8rem;
        border-spacing: 0 0.25rem;
      }
      .course-table th {
        font-size: 0.65rem;
        padding: 0 0.25rem 0.25rem;
      }
      .course-table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }
      .course-table td:nth-child(2), .course-table th:nth-child(2) { /* Hrs */
        padding: 0.5rem 0.1rem;
        text-align: center;
      }
      .grade-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.35rem;
      }
      .course-code-container .fa-info-circle {
        display: none; /* Hide info icon on mobile */
      }
    }

    /*
    ============================================================
    PART 19: MODAL STYLES (ALL)
    ============================================================
    */
    .modal-backdrop.show {
      opacity: 0.5;
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      overflow: hidden;
    }
    .modal-header {
      background: linear-gradient(135deg, rgba(122, 106, 216, 0.1), rgba(122, 106, 216, 0.05));
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }
    .modal-header .modal-title {
      color: var(--text-primary);
      font-weight: 700;
    }
    .modal-header .btn-close {
      filter: invert(0.5);
    }
    [data-theme="dark"] .modal-header .btn-close {
      filter: invert(1);
    }
    .modal-body {
      padding: 1.5rem;
    }
    .modal-footer {
      border-top: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }
    
    /* --- Confirmation Modal (Preserved) --- */
    .confirmation-modal .modal-body {
      text-align: center;
    }
    .confirmation-modal .modal-body .fa-triangle-exclamation {
      font-size: 2.5rem;
      color: #f39c12;
    }
    .confirmation-modal .modal-footer {
      justify-content: center;
    }

    /* --- Profile Manager Modal (Preserved & Enhanced) --- */
    #profileManagerModal.blur-backdrop {
      filter: blur(4px);
      transition: filter 0.15s linear;
    }
    .profile-manager-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }
    .profile-manager-stats {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .profile-manager-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .profile-list {
      list-style: none;
      padding: 0;
      max-height: 50vh;
      overflow-y: auto;
    }
    .profile-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      background-color: var(--bg-secondary);
      margin-bottom: 0.75rem;
    }
    .profile-item:hover {
      background-color: var(--bg-primary);
      border-color: var(--brand-primary);
      box-shadow: var(--shadow-sm);
    }
    [data-theme="dark"] .profile-item:hover {
      background-color: var(--bg-glass);
    }
    .profile-item .form-check-input {
      margin-top: 0;
      transform: scale(1.2);
    }
    .profile-item-details {
      flex-grow: 1;
      margin-left: 1rem;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0 1rem;
    }
    .profile-item-name {
      grid-column: 1 / -1;
      font-weight: 600;
      color: var(--text-primary);
    }
    .profile-item-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .profile-item-actions {
      display: flex;
      gap: 0.5rem;
    }
    /* Make action buttons smaller */
    .profile-item-actions .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      border-radius: var(--radius-sm);
      background: var(--bg-glass);
      color: var(--text-muted);
    }
    .profile-item-actions .btn:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
      border-color: var(--border-color);
    }
    .profile-item-actions .btn.action-delete:hover {
      color: var(--danger-primary);
    }

    /* --- Attendance Import Modal (Preserved & Enhanced) --- */
    .attendance-course-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }
    .attendance-course-item:last-child {
      border-bottom: none;
    }
    .attendance-course-item:hover {
      background-color: rgba(122, 106, 216, 0.05);
    }
    .attendance-course-item .form-check {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .attendance-course-item .form-check-label {
      line-height: 1.3;
      color: var(--text-primary);
    }
    .attendance-course-item .form-check-label small {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .attendance-course-item .import-ch-select {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .attendance-course-item .import-ch-select .form-select {
      width: 80px;
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
    }



/*
    ============================================================
    PART 20: CONTENT SECTIONS (FEATURES, FAQ, ETC.)
    ============================================================
    */
    .content-section {
      padding: 4rem 0;
      position: relative;
    }
    .section-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    .section-header h2 {
      font-size: clamp(2rem, 5vw, 2.8rem);
      font-weight: 800;
      line-height: 1.2;
    }
    .section-header .lead {
      font-size: clamp(1rem, 2.5vw, 1.2rem);
      color: var(--text-secondary);
      max-width: 600px;
      margin: 1rem auto 0;
    }
    
    /* --- Feature Card (Why Choose) --- */
    .feature-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 2rem;
      height: 100%;
      text-align: center;
      transition: all 0.3s ease;
    }
    .feature-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-md);
      border-color: rgba(122, 106, 216, 0.4);
    }
    .feature-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      background: var(--brand-gradient);
      color: white;
      font-size: 1.5rem;
      transition: all 0.3s ease;
    }
    .feature-card:hover .feature-icon {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 0 20px var(--brand-primary);
    }
    .feature-card h5 {
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    .feature-card p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    /* --- How-to Card --- */
    .how-to-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 2rem;
      height: 100%;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }
    .how-to-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }
    .how-to-icon {
      font-size: 2.5rem;
      color: var(--brand-primary);
      margin-bottom: 1rem;
    }
    .how-to-card h4 {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    /* --- FAQ Accordion --- */
    .accordion-item {
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md) !important; /* Override bootstrap */
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
    }
    .accordion-header {
      border: none;
    }
    .accordion-button {
      background: transparent;
      border: none;
      box-shadow: none;
      color: var(--text-primary);
      font-weight: 600;
      border-radius: var(--radius-md) !important;
    }
    .accordion-button:not(.collapsed) {
      background: rgba(122, 106, 216, 0.1);
      color: var(--brand-primary);
    }
    .accordion-button::after {
      filter: grayscale(1) brightness(1.5);
    }
    [data-theme="dark"] .accordion-button::after {
      filter: grayscale(1) invert(1) brightness(1.5);
    }
    .accordion-body {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }
    
    /* --- Testimonial Card --- */
    .testimonial-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 2rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-sm);
    }
    .testimonial-card .stars {
      color: #f1c40f;
      margin-bottom: 1rem;
    }
    .testimonial-card p {
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-style: italic;
      flex-grow: 1;
    }
    .testimonial-card .author {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .testimonial-card .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--brand-gradient);
      color: var(--text-on-brand);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }
    .testimonial-card .author-name {
      font-weight: 600;
      color: var(--text-primary);
    }
    .testimonial-card .author-title {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* --- Contact Form --- */
    #contact-form {
      background: var(--bg-glass);
      padding: 2rem;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }

    /*
    ============================================================
    PART 21: PREMIUM FOOTER
    ============================================================
    */
    .premium-footer {
      background-color: transparent; /* Blends with aurora */
      border-top: 1px solid var(--border-color);
      padding-top: 4rem;
      color: var(--text-muted);
      margin-top: 3rem;
    }
    .footer-logo {
      font-weight: 800;
      font-size: 1.25rem;
      margin-bottom: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }
    .footer-logo .badge {
      padding: 0.4em 0.6em;
      font-size: 0.8rem;
      border-radius: var(--radius-sm);
      background: var(--brand-gradient);
      color: var(--text-on-brand);
    }
    .footer-description {
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 350px;
    }
    .social-links {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }
    .social-links a {
      font-size: 1rem;
      color: var(--text-muted);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-glass);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .social-links a:hover {
      color: var(--brand-primary);
      background: var(--bg-secondary);
      border-color: var(--brand-primary);
      transform: translateY(-2px);
    }
    .footer-heading {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
    }
    .footer-links {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .footer-links li {
      margin-bottom: 1rem;
    }
    .footer-links a {
      color: var(--text-muted);
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
    }
    .footer-links a:hover {
      color: var(--brand-primary);
      padding-left: 8px;
    }
    .footer-bottom-bar {
      padding: 1.5rem 0;
      margin-top: 3rem;
      border-top: 1px solid var(--border-color);
    }
    .footer-copyright {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-align: center;
    }
    .footer-copyright p {
      margin-bottom: 0.25rem;
    }
    .footer-copyright a {
      font-weight: 600;
      color: var(--brand-primary);
      text-decoration: none;
    }
    .footer-copyright a:hover {
      text-decoration: underline;
    }
    .footer-disclaimer {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-style: italic;
      padding-top: 10px;
    }

    /*
    ============================================================
    PART 22: FINAL RESPONSIVE FIXES
    ============================================================
    */
    @media (max-width: 991.98px) {
      .why-choose-section,
      #testimonials {
        display: none; /* Hide complex sections on mobile for performance */
      }
      .content-section {
        padding: 3rem 0;
      }
    }
    
    @media (max-width: 767.98px) {
      .footer-heading {
        margin-top: 2rem;
      }
      .action-buttons-aligned {
        flex-direction: row;
        margin-bottom: 12px;
      }
      .action-buttons-aligned .btn {
        width: 100%;
        max-width: 210px;
      }
    }

    @media (max-width: 462px) {
  .action-buttons-aligned .btn {
    font-size: 12px;
    max-width: 154px;
    gap: 0rem;
    padding: 9px;
  }
}
    </style>
</head>

<body>

  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MJW7HPPS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <div class="cursor-dot" id="cursorDot"></div>

  <div id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </div>
  
  <div id="toast-container"></div>
  
  <div id="undo-notification-placeholder"></div>


  <div class="modal fade course-details-modal" id="courseDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="courseDetailsModalTitle">Course Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="courseDetailsModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Add Custom Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCourseForm">
            <input type="hidden" id="addCourseSemester" value="">
            <div class="mb-3">
              <label for="courseCode" class="form-label">Course Code</label>
              <input type="text" class="form-control" id="courseCode" placeholder="e.g., CHEM-101" required>
            </div>
            <div class="mb-3">
              <label for="courseTitle" class="form-label">Course Title</label>
              <input type="text" class="form-control" id="courseTitle" placeholder="e.g., Inorganic Chemistry" required>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label for="creditHours" class="form-label">Credit Hours</label>
                <select class="form-select" id="creditHours" required>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                </select>
              </div>
              <div class="col-6 mb-3">
                <label for="courseMarks" class="form-label">Marks Obtained</label>
                <input type="number" class="form-control" id="courseMarks" min="0" max="100" placeholder="e.g., 75" required>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action" id="saveCourseBtn">Add Course</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="renameProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg"> <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Rename Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="renameProfileForm">
            <div class="mb-3">
              <label for="newProfileName" class="form-label">Profile Name</label>
              <input type="text" class="form-control" id="newProfileName" required>
              <div class="form-text">Give this profile a unique name (e.g., "My Final Year Forecast").</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action" id="saveProfileNameBtn">Save Name</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="renameSemesterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Rename Semester</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="renameSemesterForm">
            <div class="mb-3">
              <label for="newSemesterName" class="form-label">Semester Name</label>
              <input type="text" class="form-control" id="newSemesterName" required>
              <div class="form-text">Give this semester a unique name (e.g., "Final Year - Spring").</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action" id="saveSemesterNameBtn">Save Name</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="attendanceImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-between align-items-center w-100">
          <h5 class="modal-title mb-0" id="attendanceModalTitle"><i class="fa-solid fa-clipboard-user me-2"></i>Import Courses</h5>
          <div class="d-flex align-items-center gap-3">
            <span id="attendanceCourseCount" class="small text-muted"></span>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleAllCourses" role="switch">
              <label class="form-check-label small" for="toggleAllCourses">Show All</label>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body">
          <p class="text-muted small" id="attendanceModalDescription">The following courses were found in the  but not in your main LMS results. Select courses to import and set their credit hours.</p>
          
          <div class="d-flex justify-content-between align-items-center py-2 px-3 rounded mb-2" style="background-color: rgba(122, 106, 216, 0.05);">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="toggleSelectAllCourses">
              <label class="form-check-label fw-medium" for="toggleSelectAllCourses">Select All Visible</label>
            </div>
            <span id="attendanceSelectedCount" class="small fw-medium" style="color: var(--brand-primary);">0 Selected</span>
          </div>

          <div id="attendanceCourseList">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action" id="importAttendanceCoursesBtn">Import Selected Courses</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="profileManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-users-gear me-2"></i>Profile Manager</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="profile-manager-header">
                    <h6 class="mb-0">Manage Your Saved Profiles</h6>
                    <div class="profile-manager-stats">
                        <span id="profileCountStat">0 Profiles</span> |
                        <span id="lastBackupStat">Last Backup: Never</span>
                    </div>
                </div>
                <div class="profile-manager-toolbar">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllProfiles">
                        <label class="form-check-label" for="selectAllProfiles">Select All</label>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-secondary-action btn-sm" type="button" id="bulkActionsBtn" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                            Bulk Actions
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="bulkActionsBtn">
                            <li><a class="dropdown-item text-danger" href="#" id="deleteSelectedBtn"><i class="fa-solid fa-trash-can me-2"></i>Delete Selected</a></li>
                        </ul>
                    </div>
                    <div class="ms-auto d-flex gap-2">
                         <button class="btn btn-success-action btn-sm" id="importProfilesBtnModal"><i class="fa-solid fa-upload me-2"></i>Import</button>
                         <button class="btn btn-info-action btn-sm" id="exportProfilesBtnModal"><i class="fa-solid fa-download me-2"></i>Export</button>
                    </div>
                </div>
                <ul class="profile-list" id="profileManagerList">
                    </ul>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade confirmation-modal" id="bedConfirmationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <i class="fa-solid fa-graduation-cap mb-3" style="font-size: 2.5rem; color: var(--brand-primary);"></i>
          <h5 class="modal-title mb-2">B.Ed. Courses Detected</h5>
          <p class="text-muted small">We found courses related to the B.Ed. (Bachelor of Education) program in your results.</p>
          <p class="mb-0"><strong>Have you enrolled in the B.Ed. program?</strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" id="bedConfirmNo">No, Show All</button>
          <button type="button" class="btn btn-primary-action" id="bedConfirmYes">Yes, Separate B.Ed.</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade confirmation-modal" id="confirmationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-body">
          <i class="fa-solid fa-triangle-exclamation mb-3"></i>
          <h5 class="modal-title mb-2" id="confirmationModalTitle">Are you sure?</h5>
          <p id="confirmationModalBody" class="text-muted small">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal" id="confirmationCancelBtn">Cancel</button>
          <button type="button" class="btn btn-danger-action" id="confirmationConfirmBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="imageLightbox" class="image-lightbox">
    <button id="lightboxClose" class="lightbox-close-btn" title="Close"><i class="fa-solid fa-times"></i></button>
    <div id="lightboxContent" class="lightbox-content"></div>
  </div>


<nav class="navbar-v2" id="Home" aria-label="Main navigation">
    <div class="container-fluid">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" href="#Home">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#Auto-Calculator">
            <i class="fa-solid fa-calculator"></i>
            <span>Calculator</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#features">
            <i class="fa-solid fa-star"></i>
            <span>Features</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#faq">
            <i class="fa-solid fa-circle-question"></i>
            <span>FAQ</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#contact-us">
            <i class="fa-solid fa-envelope"></i>
            <span>Contact</span>
          </a>
        </li>
        <li class="nav-item">
          <button id="themeToggleBtn" class="theme-toggle-btn" type="button" aria-label="Toggle dark mode">
            <i class="fa-solid fa-moon"></i>
            <span>Theme</span>
          </button>
          <input type="checkbox" id="themeToggleInput" class="d-none">
        </li>
      </ul>
    </div>
  </nav>

  <main>

    <section class="hero-section">
      <div class="container">
        <div class="row align-items-center g-4">
          <div class="col-lg-7">
            <span class="badge mb-3 fade-in-on-scroll is-visible">
              University of Agriculture Faisalabad (UAF)
            </span>
            <h1 class="fade-in-on-scroll is-visible" style="transition-delay: 0.1s;">
              The Next Gen <span class="gradient-text">UAF CGPA</span> Calculator
            </h1>
            <p class="lead mb-4 fade-in-on-scroll is-visible" style="transition-delay: 0.2s;">
              Built by <strong>M Saqlain</strong>. Instantly fetch results from <strong>LMS &amp; Attendance System</strong>. Forecast your CGPA, download PDF transcripts, and manage your complete academic profile with a futuristic, 100% accurate tool.
            </p>
            <div class="hero-actions fade-in-on-scroll is-visible" style="transition-delay: 0.3s;">
              <a href="#Auto-Calculator" class="btn btn-primary-action btn-lg">
                <i class="fa-solid fa-bolt me-2"></i>Try It Now
              </a>
              <a href="#features" class="btn btn-secondary-action btn-lg">
                <i class="fa-solid fa-star me-2"></i>Features
              </a>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="hero-feature-card fade-in-on-scroll is-visible" style="transition-delay: 0.4s;">
              <div class="d-flex align-items-center gap-3">
                <div class="card-header-icon">
                  <i class="fa-solid fa-award"></i>
                </div>
                <div>
                  <h5 class="mb-0 fw-bold">Trusted by 50,000+ Students</h5>
                  <p class="mb-0 text-muted small">The #1 Choice for UAF Students</p>
                </div>
              </div>
              <hr class="my-3" />
              <ul class="list-unstyled m-0">
                <li class="mb-2">
                  <i class="fa-solid fa-check"></i>
                  <div>
                    <strong>Instant & Automatic:</strong> Fetches from LMS &amp; Attendance System.
                  </div>
                </li>
                <li class="mb-2">
                  <i class="fa-solid fa-check"></i>
                  <div>
                    <strong>100% Accurate:</strong> Correctly handles repeated courses.
                  </div>
                </li>
                <li class="mb-2">
                  <i class="fa-solid fa-check"></i>
                  <div>
                    <strong>Forecast & Edit:</strong> Plan future semesters or add custom courses.
                  </div>
                </li>
                <li>
                  <i class="fa-solid fa-check"></i>
                  <div>
                    <strong>Premium PDF:</strong> Download a professional-style transcript.
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="announcement-bar">
      <div class="announcement-track">
          <span class="announcement-text">
              <i class="fa-solid fa-circle-info me-2"></i>
               Only the highest marks in a repeated course are counted towards your CGPA.
          </span>
          <span class="announcement-text">
              <i class="fa-solid fa-wand-magic-sparkles me-2"></i>
               Use the 'Forecast Semester' button to plan your future grades.
          </span>
          <span class="announcement-text">
              <i class="fa-solid fa-arrows-up-down-left-right me-2"></i>
               On desktop, you can drag & drop courses between semesters.
          </span>
        <span class="announcement-text">
              <i class="fa-solid fa-circle-info me-2"></i>
               Only the highest marks in a repeated course are counted towards your CGPA.
          </span>
          <span class="announcement-text">
              <i class="fa-solid fa-wand-magic-sparkles me-2"></i>
               Use the 'Forecast Semester' button to plan your future grades.
          </span>
          <span class="announcement-text">
              <i class="fa-solid fa-arrows-up-down-left-right me-2"></i>
               On desktop, you can drag & drop courses between semesters.
          </span>
      </div>
    </div>

    <section class="calculator-section" id="Auto-Calculator">
      <div class="container">
        
        <div class="server-status-indicator">
          <i class="fa-solid fa-circle-info status-info-icon"
             tabindex="0"
             data-bs-toggle="popover"
             data-bs-trigger="hover focus"
             data-bs-placement="bottom"
             data-bs-title="Server Status"
             data-bs-content="<p><strong>LMS:</strong> Main results portal</p><p><strong>ATS:</strong> Old results portal</p><hr><p class='mb-0'><i class='fa-solid fa-circle text-success me-2'></i><strong>Green:</strong> Online</p><p class='mb-0'><i class='fa-solid fa-circle text-danger me-2'></i><strong>Red:</strong> Offline/Error</p>"
             data-bs-html="true">
          </i>
          <div class="status-item" id="lms-status-item">
            <div class="status-content-wrapper">
              <div class="infinity-loader"></div>
              <span class="status-label">LMS</span>
            </div>
            <div class="status-dot" id="lms-status-dot"></div>
          </div>
          <div class="status-item" id="attnd-status-item">
            <div class="status-content-wrapper">
              <div class="infinity-loader"></div>
              <span class="status-label">ATS</span>
            </div>
            <div class="status-dot" id="attnd-status-dot"></div>
          </div>
        </div>

        <div class="section-header">
          <h2 class="gradient-text">UAF CGPA Calculator</h2>
          <p class="lead">Enter a registration number or select a saved profile.</p>
        </div>
        
        <form id="resultForm">
          <div class="search-and-profiles-container">
            <div class="modern-search-wrapper">
              <input
                type="text"
                class="form-control modern-search-input"
                id="registrationNumber"
                placeholder="e.g., 2020-ag-1234"
                required
              />
              <button type="submit" class="btn btn-primary-action modern-search-button">
                <i class="fa-solid fa-cloud-arrow-down"></i>
                <span class="d-none d-md-inline ms-2">Fetch Result</span>
              </button>
            </div>

            <p class="text-muted small text-center" style="margin: 0.5rem 0 auto;">
              Manage your saved data locally in your browser.
            </p>
            <div class="profile-data-buttons">
                <button class="btn btn-success-action btn-sm" type="button" id="importProfilesBtn"><i class="fa-solid fa-upload me-2"></i>Import Profiles</button>
                <button class="btn btn-info-action btn-sm" type="button" id="exportProfilesBtn"><i class="fa-solid fa-download me-2"></i>Export Profiles</button>
            </div>

            <div id="profileManagement" class="modern-profiles-wrapper" style="display: none;">
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fa-solid fa-user-check"></i>
                </span>
                <select class="form-select" id="profileSwitcher" aria-label="Select saved profile"></select>
                <button class="btn" type="button" id="openProfileManagerBtn" title="Manage All Profiles">
                  <i class="fa-solid fa-users-gear"></i>
                  <span class="d-none d-sm-inline ms-1">Manage</span>
                </button>
              </div>
            </div>
          </div>
        </form>

        <div class="loading-container" id="loadingContainer">
          <div class="loading-stage" id="connectingStage">
            <div class="loading-animation"><div class="pulsar"><div class="ring"></div><div class="ring"></div><div class="dot"></div></div></div>
            <p class="loading-text">Connecting to UAF LMS</p>
            <p class="loading-subtext">Establishing secure connection to UAF servers...</p>
          </div>
          <div class="loading-stage" id="fetchingStage">
            <div class="loading-animation"><div class="pulsar"><div class="ring"></div><div class="ring"></div><div class="dot"></div></div></div>
            <p class="loading-text">Fetching Your Results</p>
            <p class="loading-subtext">Retrieving your academic records from the database...</p>
          </div>
          <div class="loading-stage" id="processingStage">
            <div class="loading-animation"><div class="pulsar"><div class="ring"></div><div class="ring"></div><div class="dot"></div></div></div>
            <p class="loading-text">Processing Data</p>
            <p class="loading-subtext">Analyzing your grades and calculating CGPA...</p>
          </div>
          <div class="loading-stage" id="completeStage">
            <div class="loading-animation loading-complete">
              <div class="checkmark-circle"><i class="fa-solid fa-check checkmark-icon"></i></div>
            </div>
            <p class="loading-text">Results Ready!</p>
            <p class="loading-subtext">Your CGPA has been calculated successfully.</p>
          </div>
        </div>

</form> <div id="resultContainer" class="result-container">
          <div class="gpa-result-card-premium fade-in-on-scroll">
            <div class="student-info-header">
              <h2 class="mb-0 fw-bold" id="studentName"><i class="fa-solid fa-user-graduate me-2"></i>Student Name</h2>
              <p class="mb-0 text-muted" id="studentReg">Registration Number</p>
            </div>
            <div class="cgpa-dashboard">
              <div class="cgpa-progress-circle">
                <svg viewBox="0 0 36 36">
                  <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                  <path id="cgpaCircle" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
                <div class="cgpa-progress-text">
                  <span id="totalCgpa" class="cgpa-value">0.00</span>
                  <span class="cgpa-label">CGPA</span>
                </div>
              </div>
            </div>
            <div class="secondary-stats">
                <div class="stat-item">
                    <span class="stat-label">Percentage</span>
                    <span class="stat-value" id="totalPercentage">0.00%</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Total Marks</span>
                    <span class="stat-value">
                        <span id="totalMarksObtained">0</span><span id="totalMaxMarks" class="stat-sub-value">/ 0</span>
                    </span>
                </div>
            </div>
          </div>

          <div class="attendance-fetch-container text-center fade-in-on-scroll">
            <p class="text-muted">If some courses are not in LMS, you can find them in the Attendance System.</p>
            <button id="fetchAttendanceBtn" class="btn btn-success-action">
              <i class="fa-solid fa-clipboard-user me-2"></i>
              </button>
          </div>            

          <div class="card card-glass mt-4 fade-in-on-scroll" id="gpaChartContainer" style="display: none;">
            <div class="card-header collapsible-card-header p-0">
              <a href="#gpaChartCollapse" class="d-block text-decoration-none p-3" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="gpaChartCollapse">
                <h4><i class="fa-solid fa-chart-line gradient-text"></i>GPA Trend</h4>
                <i class="fa-solid fa-chevron-down chevron-icon" id="gpaChartChevron"></i>
              </a>
            </div>
            <div class="collapse" id="gpaChartCollapse">
              <div class="card-body">
                <canvas id="gpaTrendChart"></canvas>
              </div>
            </div>
          </div>

          <div class="action-buttons-aligned w-100 fade-in-on-scroll">
            <button id="downloadPdfBtn" class="btn btn-danger-action"><i class="fa-solid fa-file-pdf me-2"></i>Download PDF</button>
            <button id="addForecastSemesterBtn" class="btn btn-info-action"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Forecast Semester</button>
          </div>

          <div class="semester-results-container">
            <div id="semesterResults" class="semester-grid"></div>
          </div>
        </div>

        <div id="bedResultContainer" style="display: none;">
          <nav class="nav nav-tabs nav-fill" id="bedTab" role="tablist">
            <a class="nav-link active" id="bed-tab" data-bs-toggle="tab" href="#bed-tab-content" role="tab" aria-controls="bed-tab-content" aria-selected="true">
              <i class="fa-solid fa-graduation-cap me-2"></i>B.Ed. Program
            </a>
            <a class="nav-link" id="other-tab" data-bs-toggle="tab" href="#other-tab-content" role="tab" aria-controls="other-tab-content" aria-selected="false">
              <i class="fa-solid fa-book me-2"></i>Other Program
            </a>
          </nav>

          <div class="tab-content" id="bedTabContent">
            <div class="tab-pane fade show active" id="bed-tab-content" role="tabpanel" aria-labelledby="bed-tab">
              
              <div class="gpa-result-card-premium fade-in-on-scroll is-visible">
                <div class="student-info-header">
                  <h2 class="mb-0 fw-bold" id="bed-studentName"><i class="fa-solid fa-user-graduate me-2"></i>Student Name</h2>
                  <p class="mb-0 text-muted" id="bed-studentReg">Registration Number</p>
                </div>
                <div class="cgpa-dashboard">
                  <div class="cgpa-progress-circle">
                    <svg viewBox="0 0 36 36">
                      <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                      <path id="bed-cgpaCircle" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="cgpa-progress-text">
                      <span id="bed-totalCgpa" class="cgpa-value">0.00</span>
                      <span class="cgpa-label">B.Ed. CGPA</span>
                    </div>
                  </div>
                </div>
                <div class="secondary-stats">
                  <div class="stat-item">
                    <span class="stat-label">Percentage</span>
                    <span class="stat-value" id="bed-totalPercentage">0.00%</span>
                  </div>
                  <div class="stat-divider"></div>
                  <div class="stat-item">
                    <span class="stat-label">Total Marks</span>
                    <span class="stat-value">
                      <span id="bed-totalMarksObtained">0</span><span id="bed-totalMaxMarks" class="stat-sub-value">/ 0</span>
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="attendance-fetch-container text-center fade-in-on-scroll">
                <button id="bed-fetchAttendanceBtn" class="btn btn-success-action">
                  <i class="fa-solid fa-clipboard-user me-2"></i>
                </button>
              </div>

              <div class="card card-glass mt-4 fade-in-on-scroll" id="bedGpaChartContainer" style="display: none;">
                <div class="card-header collapsible-card-header p-0">
                  <a href="#bedGpaChartCollapse" class="d-block text-decoration-none p-3" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="bedGpaChartCollapse">
                    <h4><i class="fa-solid fa-chart-line gradient-text"></i>B.Ed. GPA Trend</h4>
                    <i class="fa-solid fa-chevron-down chevron-icon" id="bedGpaChartChevron"></i>
                  </a>
                </div>
                <div class="collapse" id="bedGpaChartCollapse">
                  <div class="card-body">
                    <canvas id="bedGpaTrendChart"></canvas>
                  </div>
                </div>
              </div>

              <div class="action-buttons-aligned justify-content-between w-100 fade-in-on-scroll">
                <button id="bed-downloadPdfBtn" class="btn btn-danger-action"><i class="fa-solid fa-file-pdf me-2"></i>Download PDF</button>
                <button id="bed-addForecastSemesterBtn" class="btn btn-info-action"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Forecast Semester</button>
              </div>

              <div class="semester-results-container">
                <div id="bed-semesterResults" class="semester-grid"></div>
              </div>
            </div>

            <div class="tab-pane fade" id="other-tab-content" role="tabpanel" aria-labelledby="other-tab">
              <div class="gpa-result-card-premium fade-in-on-scroll is-visible">
                <div class="student-info-header">
                  <h2 class="mb-0 fw-bold" id="other-studentName"><i class="fa-solid fa-user-graduate me-2"></i>Student Name</h2>
                  <p class="mb-0 text-muted" id="other-studentReg">Registration Number</p>
                </div>
                <div class="cgpa-dashboard">
                  <div class="cgpa-progress-circle">
                    <svg viewBox="0 0 36 36">
                      <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                      <path id="other-cgpaCircle" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="cgpa-progress-text">
                      <span id="other-totalCgpa" class="cgpa-value">0.00</span>
                      <span class="cgpa-label">CGPA</span>
                    </div>
                  </div>
                </div>
                <div class="secondary-stats">
                  <div class="stat-item">
                    <span class="stat-label">Percentage</span>
                    <span class="stat-value" id="other-totalPercentage">0.00%</span>
                  </div>
                  <div class="stat-divider"></div>
                  <div class="stat-item">
                    <span class="stat-label">Total Marks</span>
                    <span class="stat-value">
                      <span id="other-totalMarksObtained">0</span><span id="other-totalMaxMarks" class="stat-sub-value">/ 0</span>
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="attendance-fetch-container text-center fade-in-on-scroll">
                <button id="other-fetchAttendanceBtn" class="btn btn-success-action">
                  <i class="fa-solid fa-clipboard-user me-2"></i>
                </button>
              </div>

              <div class="card card-glass mt-4 fade-in-on-scroll" id="otherGpaChartContainer" style="display: none;">
                <div class="card-header collapsible-card-header p-0">
                  <a href="#otherGpaChartCollapse" class="d-block text-decoration-none p-3" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="otherGpaChartCollapse">
                    <h4><i class="fa-solid fa-chart-line" style="color: var(--accent-primary);"></i>GPA Trend</h4>
                    <i class="fa-solid fa-chevron-down chevron-icon" id="otherGpaChartChevron"></i>
                  </a>
                </div>
                <div class="collapse" id="otherGpaChartCollapse">
                  <div class="card-body">
                    <canvas id="otherGpaTrendChart"></canvas>
                  </div>
                </div>
              </div>

              <div class="action-buttons-aligned justify-content-between w-100 fade-in-on-scroll">
                <button id="other-downloadPdfBtn" class="btn btn-danger-action"><i class="fa-solid fa-file-pdf me-2"></i>Download PDF</button>
                <button id="other-addForecastSemesterBtn" class="btn btn-info-action"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Forecast Semester</button>
              </div>

              <div class="semester-results-container">
                <div id="other-semesterResults" class="semester-grid"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card card-glass mt-4 fade-in-on-scroll">
            <div class="card-header collapsible-card-header p-0">
                <a href="#statusLogCollapse" class="d-block text-decoration-none p-3" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="statusLogCollapse">
                    <h4><i class="fa-solid fa-terminal gradient-text"></i>Status Log</h4>
                    <i class="fa-solid fa-chevron-down chevron-icon status-log-chevron"></i>
                </a>
            </div>
            <div class="collapse" id="statusLogCollapse">
                <div class="card-body p-4">
                    <div class="status-log" id="statusLog">
                        <div class="status-line status-info">Ready to fetch your results. Enter your registration number and click "Fetch Result".</div>
                    </div>
                    <div class="log-section center-buttons d-flex justify-content-center gap-2 mt-3">
                        <button id="downloadLogBtn" class="btn btn-secondary-action"><i class="fa-solid fa-file-lines me-2"></i>Download Log</button>
                        <button id="clearLogBtn" class="btn btn-danger-action"><i class="fa-solid fa-trash me-2"></i>Clear Log</button>
                    </div>
                </div>
            </div>
        </div>



</div> </section> <section class="content-section" id="features">
      <div class="container">
        <div class="section-header fade-in-on-scroll">
          <h2 class="fw-bold">Why Choose Our <span class="gradient-text">CGPA Calculator</span></h2>
          <p class="lead">The most advanced and feature-rich calculation tool for UAF students.</p>
        </div>
        <div class="row g-4">
          <div class="col-md-6 col-lg-3">
            <div class="feature-card fade-in-on-scroll">
              <div class="feature-icon"><i class="fas fa-robot"></i></div>
              <h5>Instant & Automatic</h5>
              <p>Enter your registration number to get your complete, calculated academic record from the UAF portal in seconds. No manual entry needed.</p>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="feature-card fade-in-on-scroll" style="transition-delay: 0.1s;">
              <div class="feature-icon"><i class="fas fa-edit"></i></div>
              <h5>Forecast & Edit</h5>
              <p>Accurately forecast your CGPA by adding custom courses, deleting semesters, or simply dragging-and-dropping subjects.</p>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="feature-card fade-in-on-scroll" style="transition-delay: 0.2s;">
              <div class="feature-icon"><i class="fas fa-file-pdf"></i></div>
              <h5>Premium PDF Export</h5>
              <p>Generate a beautifully designed, professional transcript of your results with a single click. Perfect for your personal academic records.</p>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="feature-card fade-in-on-scroll" style="transition-delay: 0.3s;">
              <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
              <h5>Secure & Personal</h5>
              <p>Requires no password and saves all profiles securely in *your* browser, not on our servers. Enjoy a modern interface with dark mode.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="how-it-works" style="background: var(--bg-secondary);">
      <div class="container">
        <div class="section-header fade-in-on-scroll">
          <h2 class="fw-bold">How to Use <span class="gradient-text">This Calculator</span></h2>
          <p class="lead">Calculate your University of Agriculture Faisalabad (UAF) CGPA in 4 simple steps.</p>
        </div>
        <div class="row g-4">
          <div class="col-md-3">
            <div class="how-to-card fade-in-on-scroll">
              <div class="how-to-icon"><i class="fas fa-id-card"></i></div>
              <h4 class="fw-bold">Step 1: Enter ID</h4>
              <p>Enter your UAF registration number (e.g., 2020-ag-1234) in the input field.</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="how-to-card fade-in-on-scroll" style="transition-delay: 0.1s;">
              <div class="how-to-icon"><i class="fas fa-cloud-download-alt"></i></div>
              <h4 class="fw-bold">Step 2: Fetch Results</h4>
              <p>Click "Fetch Result" to automatically connect to UAF LMS and Attendance System.</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="how-to-card fade-in-on-scroll" style="transition-delay: 0.2s;">
              <div class="how-to-icon"><i class="fas fa-calculator"></i></div>
              <h4 class="fw-bold">Step 3: View CGPA</h4>
              <p>Instantly view your calculated CGPA, GPA, percentage, and semester-wise breakdown.</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="how-to-card fade-in-on-scroll" style="transition-delay: 0.3s;">
              <div class="how-to-icon"><i class="fas fa-edit"></i></div>
              <h4 class="fw-bold">Step 4: Edit & Forecast</h4>
              <p>Easily edit CGPA by importing from Attendance, adding custom courses, or forecasting future grades.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="uaf-grading-info">
      <div class="container">
        <div class="section-header fade-in-on-scroll">
          <h2 class="fw-bold">The <span class="gradient-text">UAF Grading System</span> Explained</h2>
          <p class="lead">A clear, precise breakdown of how your CGPA is calculated.</p>
        </div>

        <div class="row g-4 g-lg-5 justify-content-center">
          <div class="col-lg-6">
            <div class="card-glass h-100 fade-in-on-scroll">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-center mb-3">
                  <div class="feature-icon" style="width: 50px; height: 50px; font-size: 1.2rem; margin: 0 1rem 0 0;">
                    <i class="fa-solid fa-calculator"></i>
                  </div>
                  <h4 class="fw-bold mb-0">The Core CGPA Formula</h4>
                </div>
                <p class="text-secondary">This calculator uses the <strong>official UAF 4.0 grading scale</strong>. Your CGPA is determined by a simple, powerful formula:</p>
                
                <div class="alert text-center" style="background-color: rgba(122, 106, 216, 0.05); border-color: var(--border-color); color: var(--text-primary);">
                  <strong class="d-block" style="font-size: 1.1rem; color: var(--brand-primary);">CGPA = Total Quality Points  Total Credit Hours</strong>
                </div>
                
                <hr style="border-color: var(--border-color); opacity: 0.5;" class="my-4">

                <h5 class="fw-bold mb-3">How are <span class="gradient-text">Quality Points</span> Calculated?</h5>
                <p class="text-secondary mb-0">For each course, the grade (A, B, C, D, F) you receive is converted into Grade Points (from 4.0 to 0.0). These are then multiplied by the course's credit hours to find the Quality Points (QP) for that single course.</p>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card-glass h-100 fade-in-on-scroll" style="transition-delay: 0.1s;">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-center mb-3">
                  <div class="feature-icon" style="width: 50px; height: 50px; font-size: 1.2rem; margin: 0 1rem 0 0;">
                    <i class="fa-solid fa-star"></i>
                  </div>
                  <h4 class="fw-bold mb-0">Key Calculation Features</h4>
                </div>
                <p class="text-secondary">Our tool automates the most complex parts of the UAF grading policy for you:</p>
                
                <ul class="list-unstyled m-0">
                  <li class="d-flex align-items-start gap-3 mb-3">
                    <i class="fa-solid fa-check-circle fa-lg mt-1" style="color: var(--success-primary);"></i>
                    <div>
                      <strong class="d-block">Repeated Courses Handled</strong>
                      <span class="text-secondary small">Only the <strong>highest grade attempt</strong> for any repeated course is included in the final CGPA calculation. All other attempts are automatically excluded.</span>
                    </div>
                  </li>
                  <li class="d-flex align-items-start gap-3 mb-3">
                    <i class="fa-solid fa-check-circle fa-lg mt-1" style="color: var(--success-primary);"></i>
                    <div>
                      <strong class="d-block">Comprehensive System Sync</strong>
                      <span class="text-secondary small">Pulls data from both the <strong>UAF LMS</strong> and the <strong>Attendance System</strong> to build the most complete picture of your academic record.</span>
                    </div>
                  </li>
                  <li class="d-flex align-items-start gap-3">
                    <i class="fa-solid fa-check-circle fa-lg mt-1" style="color: var(--success-primary);"></i>
                    <div>
                      <strong class="d-block">Works for All Faculties</strong>
                      <span class="text-secondary small">The calculation logic is standard across all UAF departments, from Agriculture and Sciences to Engineering and Veterinary Sciences.</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="col-md-10">
              <div class="card-glass fade-in-on-scroll h-100" style="transition-delay: 0.2s;">
                <div class="card-body p-4">
                  <h4 class="fw-bold mb-3 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-table me-1" style="color: var(--brand-primary);"></i>
                    Official UAF Quality Point Table
                  </h4>
                  <p class="text-secondary mb-3">
                    Refer to the official UAF Quality Point Table below to understand how marks are converted into quality points and grades. Click or tap the image to zoom in and drag for details.
                  </p>
                  <div class="zoomable-image-container" id="qpTableContainer">
                    <img src="/assets/images/quality-point-table-uaf-cgpa-calculator-saqlain.webp" 
                         id="qpTableImage"
                         alt="Official UAF Quality Point Table by M Saqlain showing mark ranges, grades (A, B+, B, C+, C, D, F), and corresponding quality points for various course credit hours (0.5 to 4.0). Designed by M Saqlain, a UAF alumni and developer of UAF CGPA Calculator."
                         title="UAF Quality Point Table by M Saqlain">
                  </div>
                  <p class="text-muted small mt-3 mb-0">
                      *Table developed by M Saqlain based on official UAF academic regulations.
                  </p>
                </div>
              </div>
            </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="faq" style="background: var(--bg-secondary);">
      <div class="container">
        <div class="section-header fade-in-on-scroll">
          <h2 class="fw-bold">Frequently Asked Questions</h2>
          <p class="lead">Everything you need to know about UAF CGPA Calculator.</p>
        </div>
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="accordion" id="faqAccordion">
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingOne">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    How does the UAF CGPA Calculator work?
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    <strong>Our CGPA Calculator</strong> securely connects to the public UAF LMS portal using your registration number. It fetches your official results, processes the grades and credit hours according to the official UAF grading formula, and instantly calculates your precise Semester GPA and Cumulative GPA (CGPA).
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingTwo">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Is it safe to use my registration number?
                  </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    <strong>Yes, This CGPA Calculator by M Saqlain is completely safe.</strong> The calculator only requires your registration number, not your password. Your information is used only for fetching your result for the current session and is never stored or shared. The connection is secure and private.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingThree">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Can I use this calculator for other universities?
                  </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    This calculator is specifically designed for the students of the <strong>University of Agriculture Faisalabad (UAF)</strong>. It uses UAF's unique grading system and connects directly to the UAF LMS, so it will not work for other universities.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                    How do I calculate my UAF CGPA automatically?
                  </button>
                </h2>
                <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Simply enter your <strong>UAF registration number</strong> (e.g., 2020-ag-1234) in the calculator above and click "Fetch Result". Our system will automatically retrieve your results from UAF LMS and calculate your CGPA, GPA, and percentage using the official UAF grading formula.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive">
                    What is the UAF CGPA formula used by this calculator?
                  </button>
                </h2>
                <div id="collapseFive" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Our calculator uses the <strong>official UAF CGPA formula</strong>: CGPA = (Total Quality Points from all semesters)  (Total Credit Hours from all semesters). Quality points are calculated by multiplying your grade points with credit hours for each course, following UAF's 4.0 grading scale.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix">
                    Does this work for all UAF departments and programs?
                  </button>
                </h2>
                <div id="collapseSix" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    <strong>Yes!</strong> This UAF CGPA calculator works for all departments including Agriculture, Sciences, Engineering, Veterinary, and all degree programs (BS, MS, PhD) at the University of Agriculture Faisalabad (UAF).
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeven">
                    Can I calculate UAF CGPA without my registration number?
                  </button>
                </h2>
                <div id="collapseSeven" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    While automatic fetching requires your registration number, you can manually add your semester GPAs and credit hours to calculate your CGPA. However, using your registration number provides the most accurate results as it fetches data directly from UAF's system.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTen">
                    How to use the UAF CGPA Calculator by M Saqlain?
                  </button>
                </h2>
                <div id="collapseTen" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Using <strong>M Saqlain's UAF CGPA Calculator</strong> is simple: (1) Enter your UAF registration number, (2) Click "Fetch Result", (3) View your automatic CGPA, GPA, and percentage calculation, (4) Optionally import missing courses from Attendance System, (5) Download your professional PDF transcript. The entire process takes less than 2 minutes!
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEleven">
                    Is Muhammad Saqlain's UAF calculator more accurate than others?
                  </button>
                </h2>
                <div id="collapseEleven" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Yes! <strong>M Saqlain's calculator</strong> is 100% accurate because: (1) It uses the official UAF quality point formula, (2) It correctly handles repeated courses by counting only the highest grade, (3) It fetches data from both LMS and Attendance System, (4) It's developed by a UAF alumnus who deeply understands the grading system, (5) It's tested and trusted by 50,000+ students.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwelve">
                    Can I forecast my future UAF CGPA with Saqlain's calculator?
                  </button>
                </h2>
                <div id="collapseTwelve" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Absolutely! The <strong>UAF CGPA Calculator by M Saqlain</strong> is the ONLY calculator that lets you forecast future semesters. Click "Forecast Semester", add custom courses with expected grades, and see how your CGPA will change. This feature helps you plan your academic goals and target specific CGPA milestones.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThirteen">
                    What is the difference between UAF LMS and Attendance System?
                  </button>
                </h2>
                <div id="collapseThirteen" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    UAF has two systems: (1) <strong>LMS (new)</strong> - contains most course results, (2) <strong>Attendance System (old)</strong> - contains additional courses that teachers upload separately. <b>Mr. Saqlain's calculator</b> is unique because it automatically fetches from BOTH portals, ensuring you never miss any courses in your CGPA calculation. Other calculators only check LMS.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEight">
                    How accurate is this UAF CGPA calculator?
                  </button>
                </h2>
                <div id="collapseEight" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Our calculator is <strong>100% accurate</strong> as it follows the official UAF grading system and quality point calculation method. It fetches data directly from UAF LMS and uses the same formulas as the university's official calculation system.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-glass mb-3 fade-in-on-scroll">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNine">
                    Who created this UAF CGPA Calculator?
                  </button>
                </h2>
                <div id="collapseNine" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    This calculator was developed by <strong>Muhammad Saqlain</strong>, a UAF BS Chemistry graduate (2020-2024). It's designed specifically for UAF students to make CGPA/GPA calculation easy and accurate. For any queries, you can contact through the form below.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="testimonials">
      <div class="container">
        <div class="section-header fade-in-on-scroll">
          <h2 class="fw-bold">What UAF Students Say About <span class="gradient-text">M Saqlain's Calculator</span></h2>
          <p class="lead">Trusted by over 50,000 students across all UAF departments.</p>
        </div>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="testimonial-card fade-in-on-scroll">
              <div class="stars">
                <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
              </div>
              <p>"The <strong>best UAF CGPA calculator</strong> I've used! <strong>Saqlain's tool</strong> saved me hours of manual calculation. The attendance system integration is a game-changer!"</p>
              <div class="author">
                <div class="author-avatar">AA</div>
                <div>
                  <div class="author-name">Ahmad Ali</div>
                  <div class="author-title">BS Agriculture, Batch 2021</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="testimonial-card fade-in-on-scroll" style="transition-delay: 0.1s;">
              <div class="stars">
                <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
              </div>
              <p>"Finally, a <strong>UAF calculator</strong> that handles repeated courses correctly! <strong>M Saqlain</strong> really understood our needs. The PDF download feature is amazing!"</p>
              <div class="author">
                <div class="author-avatar">SF</div>
                <div>
                  <div class="author-name">Sarah Fatima</div>
                  <div class="author-title">BS Chemistry, Batch 2020</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="testimonial-card fade-in-on-scroll" style="transition-delay: 0.2s;">
              <div class="stars">
                <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
              </div>
              <p>"I've recommended <strong>UAF CGPA Calculator Saqlain</strong> to my entire batch! It's accurate, fast, and the forecasting feature helps me plan my grades perfectly."</p>
              <div class="author">
                <div class="author-avatar">MH</div>
                <div>
                  <div class="author-name">Muhammad Hamza</div>
                  <div class="author-title">BS Engineering, Batch 2022</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="about-developer-premium" style="background: var(--bg-secondary);">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <div class="card-glass p-4 p-md-5 fade-in-on-scroll">
              <div class="text-center mb-4">
                <img src="assets/images/developer-uaf-cgpa-calculator-m-saqlain.webp" 
                     alt="Muhammad Saqlain - Developer of UAF CGPA Calculator" 
                     class="rounded-circle mb-3" 
                     width="120" 
                     height="120" />
                <h2 class="fw-bold">About Muhammad Saqlain (M Saqlain)</h2>
                <p class="text-muted mb-0">Developer of UAF CGPA Calculator</p>
              </div>
              
              <div class="text-start">
                <p class="lead mb-4" style="font-size: 1.1rem; color: var(--text-secondary);">
                  <b>Mr. Muhammad Saqlain</b> is a BS Chemistry graduate from <b>University of Agriculture Faisalabad - UAF</b> (2020-2024) and the developer behind the most trusted and features rich <strong>UAF CGPA Calculator</strong>.
                </p>
                
                <h3 class="h5 fw-bold mb-3">Why M Saqlain Created This Calculator?</h3>
                <p class="text-secondary">
                  As a UAF student, <b>Mr. Saqlain</b> experienced firsthand the challenges of manually calculating CGPA, dealing with repeated courses, and tracking results from both the LMS and Attendance System. This inspired him to create the <strong>UAF CGPA Calculator by Saqlain</strong> - a comprehensive, automatic solution that has now helped over <strong>50,000 UAF students</strong>.
                </p>
                
                <h3 class="h5 fw-bold mb-3 mt-4">What Makes M Saqlain's Calculator Different</h3>
                <ul class="list-unstyled text-secondary">
                  <li class="mb-2"><i class="fa-solid fa-check-circle me-2" style="color: var(--success-primary);"></i><strong>Built by a UAF Alumnus:</strong> Deep understanding of UAF's grading system.</li>
                  <li class="mb-2"><i class="fa-solid fa-check-circle me-2" style="color: var(--success-primary);"></i><strong>Most Accurate:</strong> Uses official UAF quality point formula with repeated course handling.</li>
                  <li class="mb-2"><i class="fa-solid fa-check-circle me-2" style="color: var(--success-primary);"></i><strong>Most Features:</strong> Only calculator with LMS + Attendance System integration.</li>
                  <li class="mb-2"><i class="fa-solid fa-check-circle me-2" style="color: var(--success-primary);"></i><strong>Regular Updates:</strong> Continuously improved based on student feedback.</li>
                  <li class="mb-2"><i class="fa-solid fa-check-circle me-2" style="color: var(--success-primary);"></i><strong>Trusted by 50,000+:</strong> The #1 choice among UAF students since 2024.</li>
                </ul>
                
                <div class="alert mt-4 d-flex align-items-center" style="background-color: rgba(122, 106, 216, 0.05); border-color: var(--border-color);">
                  <i class="fa-solid fa-lightbulb fa-2x me-3" style="color: var(--brand-primary);"></i>
                  <div>
                    <strong>Pro Tip from M Saqlain:</strong> Always check the Attendance System for any missing courses that might not appear in your LMS results. This calculator makes it easy to import them!
                  </div>
                </div>
                
                <div class="text-center mt-4">
                  <p class="mb-2"><strong>Connect with Muhammad Saqlain:</strong></p>
                  <div class="d-flex justify-content-center gap-3">
                    <a href="https://www.facebook.com/UAFChemist.Rustam" target="_blank" class="btn btn-secondary-action">
                      <i class="fa-brands fa-facebook me-2"></i>Facebook
                    </a>
                    <a href="https://x.com/M_Saqlain_Akbar" target="_blank" class="btn btn-secondary-action">
                      <i class="fa-brands fa-x-twitter me-2"></i>Twitter (X)
                    </a>
                    <a href="https://www.linkedin.com/in/muhammad-saqlain-akbar/" target="_blank" class="btn btn-secondary-action">
                      <i class="fa-brands fa-linkedin me-2"></i>LinkedIn
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="contact-us">
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-6 fade-in-on-scroll">
            <h3 class="fw-bold mb-2">Contact</h3>
            <p class="text-secondary">Questions or suggestions? Send a message.</p>
            <form id="contact-form" action="https://formspree.io/f/xblrolwp" method="post" class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-md-6"><label class="form-label" for="name">Your Name</label><input class="form-control" id="name" name="name" placeholder="e.g., Ali Raza" required /><div class="invalid-feedback">Please enter your name.</div></div>
                <div class="col-md-6"><label class="form-label" for="email">Email</label><input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required /><div class="invalid-feedback">Enter a valid email.</div></div>
                <div class="col-12"><label class="form-label" for="message">Message</label><textarea class="form-control" id="message" name="message" rows="4" placeholder="Write your message..." required></textarea><div class="invalid-feedback">Please write a message.</div></div>
                <div class="col-12"><button class="btn btn-primary-action" type="submit"><i class="fa-solid fa-paper-plane me-2"></i>Send Message</button></div>
                <div id="contact-form-status" class="mt-2 small"></div>
              </div>
            </form>
          </div>
          <div class="col-lg-6 fade-in-on-scroll" style="transition-delay: 0.1s;">
            <div class="h-100 p-4 p-lg-5 card-glass">
              <h5 class="fw-bold">Developer</h5>
              <div class="d-flex align-items-center gap-3 mt-2">
                <img src="assets/images/developer-uaf-cgpa-calculator-m-saqlain.webp" alt="Muhammad Saqlain - Developer of UAF CGPA Calculator" class="rounded-circle" width="86" height="86" />
                <div>
                  <div class="fw-semibold text-primary">Muhammad Saqlain</div><div class="text-secondary small">BS Chemistry (20202024)</div>
                  <div class="d-flex gap-3 mt-2">
                    <a class="text-decoration-none text-muted" href="https://www.facebook.com/UAFChemist.Rustam" target="_blank"><i class="fa-brands fa-facebook"></i></a>
                    <a class="text-decoration-none text-muted" href="https://x.com/M_Saqlain_Akbar" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
                    <a class="text-decoration-none text-muted" href="https://www.linkedin.com/in/muhammad-saqlain-akbar/" target="_blank"><i class="fa-brands fa-linkedin"></i></a>
                  </div>
                </div>
              </div>
              <hr class="my-4" style="border-color: var(--border-color); opacity: 0.5;"/>
              <p class="mb-0 small text-secondary">Share this tool with your friends to support the project. </p>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="premium-footer">
    <div class="container">
      <div class="row">

        <div class="col-lg-4 col-md-6">
          <a class="footer-logo" href="/">
            <span class="badge">UAF</span>
            <span class="gradient-text">CGPA Calculator</span>
          </a>
          <p class="footer-description">
            The #1 automatic cgpa calculator for University of Agriculture Faisalabad (UAF) students. Developed by M Saqlain to be accurate, fast, and free.
          </p>
          <div class="social-links">
            <a href="https://www.facebook.com/UAFChemist.Rustam" target="_blank" title="Facebook"><i class="fa-brands fa-facebook"></i></a>
            <a href="https://x.com/M_Saqlain_Akbar" target="_blank" title="Twitter/X"><i class="fa-brands fa-x-twitter"></i></a>
            <a href="https://www.linkedin.com/in/muhammad-saqlain-akbar/" target="_blank" title="LinkedIn"><i class="fa-brands fa-linkedin"></i></a>
          </div>
        </div>

        <div class="col-lg-2 col-md-3 col-6">
          <h5 class="footer-heading">Quick Links</h5>
          <ul class="footer-links">
            <li><a href="#Home">Home</a></li>
            <li><a href="#Auto-Calculator">Calculator</a></li>
            <li><a href="#features">Features</a></li>
            <li><a href="#faq">FAQ</a></li>
          </ul>
        </div>

        <div class="col-lg-2 col-md-3 col-6">
          <h5 class="footer-heading">About</h5>
          <ul class="footer-links">
            <li><a href="#about-developer-premium">About M Saqlain</a></li>
            <li><a href="#contact-us">Contact Developer</a></li>
            <li><a href="#uaf-grading-info">Grading System</a></li>
            <li><a href="#testimonials">Testimonials</a></li>
          </ul>
        </div>

        <div class="col-lg-4 col-md-12 mt-4 mt-lg-0">
          <h5 class="footer-heading">Disclaimer</h5>
          <p class="footer-disclaimer">
            This is an unofficial, third-party tool developed by a UAF alumnus. It is not affiliated with, endorsed, or supported by the University of Agriculture Faisalabad (UAF). Always verify your official results with the university.
          </p>
        </div>

      </div>

      <div class="footer-bottom-bar">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="footer-copyright">
                <p class="mb-1"> 2025 Muhammad Saqlain. All rights reserved.</p>
                <p class="mb-0">Trusted by 50,000+ UAF Students | Developed by <a href="#about-developer-premium">M Saqlain</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
        document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const resultForm = document.getElementById('resultForm');
      const registrationNumber = document.getElementById('registrationNumber');
      const resultContainer = document.getElementById('resultContainer');
      const statusLog = document.getElementById('statusLog');
      
      /* --- MODIFICATION: Find new theme toggle button --- */
      /* We now have two: one for desktop, one for mobile. initTheme() handles both. */
      const themeToggleBtn = document.getElementById('themeToggleBtn');
      const themeToggleInput = document.getElementById('themeToggleInput');
      /* --- End Modification --- */

      const cursorDot = document.getElementById('cursorDot');
      const contactForm = document.getElementById('contact-form');
      const downloadLogBtn = document.getElementById('downloadLogBtn');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const semesterResults = document.getElementById('semesterResults');
      const studentName = document.getElementById('studentName');
      const studentReg = document.getElementById('studentReg');
      const totalCgpa = document.getElementById('totalCgpa');
      const totalPercentage = document.getElementById('totalPercentage');
      const totalMarksObtained = document.getElementById('totalMarksObtained');
      const totalMaxMarks = document.getElementById('totalMaxMarks');
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      const courseDetailsModal = new bootstrap.Modal(document.getElementById('courseDetailsModal'));
      const addCourseModal = new bootstrap.Modal(document.getElementById('addCourseModal'));
      const saveCourseBtn = document.getElementById('saveCourseBtn');
      const addCourseForm = document.getElementById('addCourseForm');
      const loadingContainer = document.getElementById('loadingContainer');
      const backToTopButton = document.getElementById('backToTop');
      const addForecastSemesterBtn = document.getElementById('addForecastSemesterBtn');
      const gpaChartContainer = document.getElementById('gpaChartContainer');
      const gpaTrendChartCanvas = document.getElementById('gpaTrendChart').getContext('2d');
      const profileManagementDiv = document.getElementById('profileManagement');
      const profileSwitcher = document.getElementById('profileSwitcher');
      const renameProfileModal = new bootstrap.Modal(document.getElementById('renameProfileModal'));
      const saveProfileNameBtn = document.getElementById('saveProfileNameBtn');

      let renameSemesterModal; // Will be initialized in init()
      let saveSemesterNameBtn; // Will be initialized in init()

      // NEW Attendance System Elements
      let fetchAttendanceBtn = document.getElementById('fetchAttendanceBtn');
      let bedFetchAttendanceBtn = document.getElementById('bed-fetchAttendanceBtn');
      let otherFetchAttendanceBtn = document.getElementById('other-fetchAttendanceBtn');
      const attendanceImportModal = new bootstrap.Modal(document.getElementById('attendanceImportModal'));
      const importAttendanceCoursesBtn = document.getElementById('importAttendanceCoursesBtn');

      // Profile Manager Elements
      const openProfileManagerBtn = document.getElementById('openProfileManagerBtn');
      const profileManagerModal = new bootstrap.Modal(document.getElementById('profileManagerModal'));
      const profileManagerModalEl = document.getElementById('profileManagerModal'); // Get the element
      const renameProfileModalEl = document.getElementById('renameProfileModal'); // Get the element
      const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      const confirmationModalEl = document.getElementById('confirmationModal'); // Get the element
      const attendanceImportModalEl = document.getElementById('attendanceImportModal'); // Get the element

      // Import/Export buttons
      const importProfilesBtn = document.getElementById('importProfilesBtn');
      const exportProfilesBtn = document.getElementById('exportProfilesBtn');
      const importProfilesBtnModal = document.getElementById('importProfilesBtnModal'); // In modal
      const exportProfilesBtnModal = document.getElementById('exportProfilesBtnModal'); // In modal

      // State
      let allLogs = [];
      let processedData = null;
      let deletedSemesters = {};
      let gpaChart = null;
      let bedGpaChart = null;
      let otherGpaChart = null;
      let isInitialLoad = true;
      let confirmationCallback = null;
      let importedAttendanceCourses = []; // Tracks courses from the last import

      // --- NEW B.Ed. Variables ---
      const BED_COURSES = new Set([
        'EDU-501', 'EDU-503', 'EDU-505', 'EDU-507', 'EDU-509', 'EDU-511', 'EDU-513',
        'EDU-502', 'EDU-504', 'EDU-506', 'EDU-508', 'EDU-510', 'EDU-512', 'EDU-516',
        'EDU-601', 'EDU-604', 'EDU-605', 'EDU-607', 'EDU-608', 'EDU-623'
      ]);
      let bedConfirmationModal; // Will be initialized in init()
      let bedModeActive = false;
      // --- End of NEW B.Ed. Variables ---

      const API_ENDPOINT = `/api/result-scraper?action=scrape_single`;
      const ATTENDANCE_API_ENDPOINT = `/api/result-scraper?action=scrape_attendance`; // NEW API Endpoint

          
          // NEW FUNCTION to auto-collapse mobile menu
function initMenuAutoCollapse() {
  /* --- MODIFICATION: Find new nav links --- */
  const navLinks = document.querySelectorAll('.navbar-v2 .nav-link');
  /* --- This is a conceptual addition, as the new navbar is not a Bootstrap collapse --- */
  /* --- For the new UI, this function isn't strictly necessary as the nav is always open --- */
  /* --- We will keep it in case you revert to a collapsible mobile nav --- */
}
      
          // NEW updated init() function
function init() {
  try {
    migrateOldProfiles(); 
    initCustomCursor();
    initTheme();
    
    renameSemesterModal = new bootstrap.Modal(document.getElementById('renameSemesterModal'));
    saveSemesterNameBtn = document.getElementById('saveSemesterNameBtn');
    saveSemesterNameBtn.addEventListener('click', renameSemester); 
    
    initContactForm();
    
    /* --- MODIFICATION: Toast container is now in HTML --- */
    // createToastContainer(); 
    if (!document.getElementById('toast-container')) {
        console.error("Toast container not found!");
    }
    
    initBackToTop();
    initScrollAnimations();
    loadProfiles(); 
    initModalZIndexHandlers(); 
    
    initMenuAutoCollapse();

    // --- NEW B.Ed. Modal Init ---
    const bedModalEl = document.getElementById('bedConfirmationModal');
    if (bedModalEl) {
        bedConfirmationModal = new bootstrap.Modal(bedModalEl);
        document.getElementById('bedConfirmYes').addEventListener('click', () => {
          console.log("B.Ed. Yes clicked");
          // The handler is now attached in fetchResult() to pass the data
        });
        document.getElementById('bedConfirmNo').addEventListener('click', () => {
           console.log("B.Ed. No clicked");
           // The handler is now attached in fetchResult()
        });
    } else {
        console.warn("B.Ed. confirmation modal HTML not found.");
    }

  } catch (error) { 
      console.error("Initialization failed:", error);
      try {
          /* --- MODIFICATION: Check if container exists --- */
          if (document.getElementById('toast-container')) {
              showToast("Error initializing application. Saved data may be corrupted.", "error");
          }
      } catch (toastError) {
          console.error("Could not show initialization error toast:", toastError);
      }
  }
}


      function setupAttendanceButton() {
        // We now have three buttons to update
        const buttons = [
            { el: fetchAttendanceBtn, id: 'fetchAttendanceBtn' },
            { el: bedFetchAttendanceBtn, id: 'bed-fetchAttendanceBtn' },
            { el: otherFetchAttendanceBtn, id: 'other-fetchAttendanceBtn' }
        ];

        buttons.forEach(btnInfo => {
            if (!btnInfo.el) {
                btnInfo.el = document.getElementById(btnInfo.id);
                if (!btnInfo.el) {
                    return; // Skip if still not found
                }
            }

            // Remove existing listener to avoid stacking
            const newBtn = btnInfo.el.cloneNode(true);
            btnInfo.el.parentNode.replaceChild(newBtn, btnInfo.el);
            btnInfo.el = newBtn; // Re-assign the variable
            
            // Re-assign global variables
            if (btnInfo.id === 'fetchAttendanceBtn') fetchAttendanceBtn = newBtn;
            else if (btnInfo.id === 'bed-fetchAttendanceBtn') bedFetchAttendanceBtn = newBtn;
            else if (btnInfo.id === 'other-fetchAttendanceBtn') otherFetchAttendanceBtn = newBtn;

            if (importedAttendanceCourses.length > 0) {
                newBtn.innerHTML = '<i class="fa-solid fa-rotate-left me-2"></i>Revert Import';
                newBtn.className = 'btn btn-danger-action'; // Use danger for revert
                newBtn.addEventListener('click', (e) => revertAttendanceImport(e.currentTarget));
                newBtn.disabled = false; // Ensure it's enabled
            } else {
                newBtn.innerHTML = '<i class="fa-solid fa-clipboard-user me-2"></i>Attendance System';
                newBtn.className = 'btn btn-success-action';
                newBtn.addEventListener('click', (e) => fetchAttendanceData(e.currentTarget));
                newBtn.disabled = !processedData;
            }
        });
      }

      function revertAttendanceImport() {
        if (importedAttendanceCourses.length === 0) return;

        let revertedCount = 0;
        importedAttendanceCourses.forEach(imported => {
            const semester = processedData.semesters[imported.semester];
            if (semester) {
                const initialLength = semester.courses.length;
                semester.courses = semester.courses.filter(c => 
                    !(c.isCustom && c.source === 'attendance' && c.code === imported.code)
                );
                if (semester.courses.length < initialLength) {
                    revertedCount++;
                }
            }
        });
        
        showToast(`Reverted ${revertedCount} imported course(s)`, 'success');
        addStatusMessage(`Reverted import of ${revertedCount} courses`, 'info');
        
        importedAttendanceCourses = []; // Clear the list
        recalculateAndDisplay(); // This saves the profile
        setupAttendanceButton(); // Reset the button
      }

      function updateAttendanceCounts() {
        const listEl = document.getElementById('attendanceCourseList');
        const selectAllCheckbox = document.getElementById('toggleSelectAllCourses');
        const selectedCountEl = document.getElementById('attendanceSelectedCount');
        if (!listEl || !selectAllCheckbox || !selectedCountEl) return;

        const allVisibleCheckboxes = listEl.querySelectorAll('.attendance-course-item:not([style*="display: none"]) .form-check-input:not(:disabled)');
        const allVisibleChecked = listEl.querySelectorAll('.attendance-course-item:not([style*="display: none"]) .form-check-input:checked:not(:disabled)');

        const selected = allVisibleChecked.length;
        const totalVisible = allVisibleCheckboxes.length;
        
        selectedCountEl.textContent = `${selected} Selected`;

        if (totalVisible === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.disabled = true;
        } else {
            selectAllCheckbox.disabled = false;
            if (selected === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selected === totalVisible) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
      }
      
      

      // --- Handle modal stacking/blur visual effects ---
      function initModalZIndexHandlers() {
        // When Rename modal shows, blur Profile Manager
        renameProfileModalEl.addEventListener('show.bs.modal', function () {
            profileManagerModalEl.classList.add('blur-backdrop');
        });
        // When Rename modal hides, remove blur from Profile Manager
        renameProfileModalEl.addEventListener('hide.bs.modal', function () {
            profileManagerModalEl.classList.remove('blur-backdrop');
        });
        // When Confirmation modal shows, blur Profile Manager
        confirmationModalEl.addEventListener('show.bs.modal', function () {
            profileManagerModalEl.classList.add('blur-backdrop');
        });
        // When Confirmation modal hides, remove blur from Profile Manager
        confirmationModalEl.addEventListener('hide.bs.modal', function () {
            profileManagerModalEl.classList.remove('blur-backdrop');
        });
        
        /* --- MODIFICATION: Blur main content, not just hero/calc --- */
        attendanceImportModalEl.addEventListener('show.bs.modal', function () {
            document.querySelector('main').style.filter = 'blur(4px)';
            document.querySelector('footer').style.filter = 'blur(4px)';
        });
        attendanceImportModalEl.addEventListener('hide.bs.modal', function () {
            document.querySelector('main').style.filter = 'none';
            document.querySelector('footer').style.filter = 'none';
        });
      }

      function migrateOldProfiles() {
          const oldProfilesData = localStorage.getItem('uafCalculatorProfiles');
          if (oldProfilesData) {
              try {
                  const oldProfiles = JSON.parse(oldProfilesData);
                  const newProfiles = getProfiles();
                  let migratedCount = 0;

                  Object.keys(oldProfiles).forEach(oldId => {
                      const oldProfile = oldProfiles[oldId];
                      const alreadyExists = Object.values(newProfiles).some(
                          p => p.studentInfo.registration === oldProfile.studentInfo.registration
                      );

                      if (!alreadyExists && oldProfile.studentInfo) {
                          const newProfile = {
                              ...oldProfile,
                              displayName: `${oldProfile.studentInfo.name} (${oldProfile.studentInfo.registration})`,
                              createdAt: new Date().toISOString(),
                              lastModified: new Date().toISOString()
                          };
                          const newId = `profile_${Date.now()}_${migratedCount}`;
                          newProfiles[newId] = newProfile;
                          migratedCount++;
                      }
                  });

                  if (migratedCount > 0) {
                      saveProfiles(newProfiles);
                      showToast(`${migratedCount} profile(s) from a previous version were successfully migrated!`, 'success');
                  }

                  localStorage.removeItem('uafCalculatorProfiles'); // Remove old data after migration
              } catch (e) {
                  console.error("Failed to migrate old profiles:", e);
              }
          }
      }

      function initScrollAnimations() {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1 });
        document.querySelectorAll('.fade-in-on-scroll').forEach(el => observer.observe(el));
      }

      function getProfiles() {
        return JSON.parse(localStorage.getItem('uafCalculatorProfiles_v2') || '{}');
      }

      function saveProfiles(profiles) {
        localStorage.setItem('uafCalculatorProfiles_v2', JSON.stringify(profiles));
      }

      function getActiveProfileId() {
        return localStorage.getItem('uafCalculatorActiveProfile_v2');
      }

      function setActiveProfileId(id) {
        localStorage.setItem('uafCalculatorActiveProfile_v2', id);
      }

      function getBackupInfo() {
          return JSON.parse(localStorage.getItem('uafCalculatorBackupInfo') || '{}');
      }

      function saveBackupInfo(info) {
          localStorage.setItem('uafCalculatorBackupInfo', JSON.stringify(info));
      }

      function loadProfiles() {
        try {
          const profiles = getProfiles();
          const activeProfileId = getActiveProfileId();
          updateProfileSwitcher(profiles, activeProfileId);

          if (activeProfileId && profiles[activeProfileId]) {
            loadProfile(activeProfileId);
            addStatusMessage('Loaded active profile from session.', 'info');
          } else if (activeProfileId) {
            setActiveProfileId('');
            addStatusMessage('Cleared invalid active profile ID from session.', 'warning');
          }
        } catch (error) {
          console.error("Failed to load profiles:", error);
          showToast("Error loading saved profiles. Data might be corrupted.", "error");
          localStorage.removeItem('uafCalculatorProfiles_v2');
          localStorage.removeItem('uafCalculatorActiveProfile_v2');
          try {
              updateProfileSwitcher({}, ''); // Clear switcher
              profileManagementDiv.style.display = 'none';
              if(resultContainer) resultContainer.style.display = 'none';
          } catch (uiError) {
              console.error("Error resetting UI after profile load failure:", uiError);
          }
        }
      }

      function updateProfileSwitcher(profiles, activeProfileId) {
        const profileKeys = Object.keys(profiles);
        if (profileKeys.length > 0) {
          profileSwitcher.innerHTML = '<option value="">Select a saved profile...</option>';
          profileKeys.forEach(profileId => {
            const profile = profiles[profileId];
            if (profile && profile.studentInfo) {
                const option = document.createElement('option');
                option.value = profileId;
                option.textContent = profile.displayName || `${profile.studentInfo.name} (${profile.studentInfo.registration})`;
                if (profileId === activeProfileId) {
                  option.selected = true;
                }
                profileSwitcher.appendChild(option);
            }
          });
          profileManagementDiv.style.display = 'block';
        } else {
          profileManagementDiv.style.display = 'none';
        }
      }

      function loadProfile(profileId) {
        const profiles = getProfiles();
        if (profiles[profileId]) {
          processedData = profiles[profileId];
          isInitialLoad = true;
          bedModeActive = processedData.bedMode || false;
          renderResults(processedData); 
          registrationNumber.value = processedData.studentInfo.registration;
          setActiveProfileId(profileId);
          updateProfileSwitcher(profiles, profileId);
        }
      }

      function switchProfile(event) {
        const profileId = event.target.value;
        if (profileId) {
          loadProfile(profileId);
          showToast(`Switched to profile: ${getProfiles()[profileId].displayName}`, 'info');
        }
      }

      function saveActiveProfile() {
        const activeProfileId = getActiveProfileId();
        if (activeProfileId && processedData) {
            const profiles = getProfiles();
            if (profiles[activeProfileId]) {
                processedData.lastModified = new Date().toISOString();
                profiles[activeProfileId] = processedData;
                saveProfiles(profiles);
            }
        }
      }

      function openRenameModal(profileId) {
        const profiles = getProfiles();
        if (!profileId || !profiles[profileId]) {
            showToast('Invalid profile selected for rename.', 'warning');
            return;
        }
        document.getElementById('newProfileName').value = profiles[profileId].displayName;
        saveProfileNameBtn.dataset.profileId = profileId; // Store the ID
        renameProfileModal.show();
      }

      function renameProfile() {
          const profileId = saveProfileNameBtn.dataset.profileId;
          const newName = document.getElementById('newProfileName').value.trim();

          if (!newName) {
              showToast('Profile name cannot be empty.', 'error');
              return;
          }

          const profiles = getProfiles();
          const nameExists = Object.keys(profiles).some(currentId => 
              profiles[currentId].displayName === newName && currentId !== profileId
          );
          
          if (nameExists) {
              showToast('A profile with this name already exists.', 'error');
              return;
          }

          profiles[profileId].displayName = newName;
          profiles[profileId].lastModified = new Date().toISOString();
          saveProfiles(profiles);
          renameProfileModal.hide();
          showToast('Profile renamed successfully!', 'success');

          updateProfileSwitcher(profiles, getActiveProfileId());
          if (profileManagerModalEl.classList.contains('show')) {
              renderProfileManager();
          }
      }

      function showConfirmationModal(title, body, onConfirm) {
        document.getElementById('confirmationModalTitle').textContent = title;
        document.getElementById('confirmationModalBody').textContent = body;
        confirmationCallback = onConfirm;
        confirmationModal.show();
      }

      function handleConfirm() {
        if (typeof confirmationCallback === 'function') {
          confirmationCallback();
        }
        confirmationModal.hide();
        confirmationCallback = null;
      }

      // --- PROFILE MANAGER FUNCTIONS ---
      function renderProfileManager() {
        const profiles = getProfiles();
        const profileListEl = document.getElementById('profileManagerList');
        const profileCountStat = document.getElementById('profileCountStat');
        const lastBackupStat = document.getElementById('lastBackupStat');

        const profileKeys = Object.keys(profiles);
        profileCountStat.textContent = `${profileKeys.length} Profile${profileKeys.length !== 1 ? 's' : ''}`;

        const backupInfo = getBackupInfo();
        lastBackupStat.textContent = backupInfo.lastBackup ? `Last Backup: ${new Date(backupInfo.lastBackup).toLocaleString()}` : 'Last Backup: Never';

        if (profileKeys.length === 0) {
            profileListEl.innerHTML = '<li class="text-center text-muted p-4">No profiles saved yet.</li>';
            document.getElementById('bulkActionsBtn').disabled = true;
            document.getElementById('exportProfilesBtnModal').disabled = true;
            document.getElementById('selectAllProfiles').checked = false;
            document.getElementById('selectAllProfiles').indeterminate = false;
            return;
        }

        profileListEl.innerHTML = profileKeys.map(id => {
            const profile = profiles[id];
            const lastModified = profile.lastModified ? new Date(profile.lastModified).toLocaleString() : 'N/A';
            let detailsHtml = '';

            if (profile.bedMode) {
                const bedSemesters = filterSemesters(profile.semesters, true);
                const bedData = { ...profile, semesters: bedSemesters };
                const bedCgpa = calculateCGPA(bedData);
                const bedSemesterCount = Object.keys(bedData.semesters).length;
                const bedCourseCount = Object.values(bedData.semesters).reduce((sum, s) => sum + s.courses.length, 0);

                const otherSemesters = filterSemesters(profile.semesters, false);
                const otherData = { ...profile, semesters: otherSemesters };
                const otherCgpa = calculateCGPA(otherData);
                const otherSemesterCount = Object.keys(otherData.semesters).length;
                const otherCourseCount = Object.values(otherData.semesters).reduce((sum, s) => sum + s.courses.length, 0);

                detailsHtml = `
                  <div class="profile-item-name">${profile.displayName} <span class="badge rounded-pill" style="font-size: 0.7em; background-color: rgba(122, 106, 216, 0.1); color: var(--brand-primary);">B.Ed. Profile</span></div>
                  <div class="profile-item-meta" style="grid-column: 1 / -1;"><i class="fa-solid fa-id-card"></i> ${profile.studentInfo.registration}</div>
                  
                  <div class="profile-item-meta" style="grid-column: 1 / -1; margin-top: 5px; padding-top: 5px; border-top: 1px solid var(--border-color);">
                    <strong class="small" style="color: var(--brand-primary);">B.Ed. Program:</strong>
                  </div>
                  <div class="profile-item-meta" style="padding-left: 15px;"><i class="fa-solid fa-graduation-cap"></i> CGPA: ${bedCgpa.cgpa.toFixed(4)}</div>
                  <div class="profile-item-meta" style="padding-left: 15px;"><i class="fa-solid fa-book"></i> ${bedSemesterCount} Sem, ${bedCourseCount} Crs</div>

                  <div class="profile-item-meta" style="grid-column: 1 / -1; margin-top: 5px; padding-top: 5px; border-top: 1px solid var(--border-color);">
                    <strong class="small" style="color: var(--brand-primary);">Other Program:</strong>
                  </div>
                  <div class="profile-item-meta" style="padding-left: 15px;"><i class="fa-solid fa-graduation-cap"></i> CGPA: ${otherCgpa.cgpa.toFixed(4)}</div>
                  <div class="profile-item-meta" style="padding-left: 15px;"><i class="fa-solid fa-book"></i> ${otherSemesterCount} Sem, ${otherCourseCount} Crs</div>
                  
                  <div class="profile-item-meta" style="grid-column: 1 / -1; margin-top: 5px; padding-top: 5px; border-top: 1px solid var(--border-color);">
                    <i class="fa-solid fa-clock"></i> ${lastModified}
                  </div>
                `;

            } else {
                const cgpaData = calculateCGPA(profile);
                const semesterCount = Object.keys(profile.semesters).length;
                const courseCount = Object.values(profile.semesters).reduce((sum, s) => sum + s.courses.length, 0);
                
                detailsHtml = `
                  <div class="profile-item-name">${profile.displayName}</div>
                  <div class="profile-item-meta"><i class="fa-solid fa-id-card"></i> ${profile.studentInfo.registration}</div>
                  <div class="profile-item-meta"><i class="fa-solid fa-graduation-cap"></i> CGPA: ${cgpaData.cgpa.toFixed(4)}</div>
                  <div class="profile-item-meta"><i class="fa-solid fa-book"></i> ${semesterCount} Semesters, ${courseCount} Courses</div>
                  <div class="profile-item-meta"><i class="fa-solid fa-clock"></i> ${lastModified}</div>
                `;
            }

            return `
              <li class="profile-item" data-profile-id="${id}">
                  <input class="form-check-input profile-checkbox" type="checkbox" value="${id}">
                  <div class="profile-item-details" style="${profile.bedMode ? 'grid-template-columns: repeat(2, 1fr);' : ''}">
                      ${detailsHtml}
                  </div>
                  <div class="profile-item-actions">
                      <button class="btn btn-sm action-load" title="Load Profile"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                      <button class="btn btn-sm action-rename" title="Rename"><i class="fa-solid fa-pen"></i></button>
                      <button class="btn btn-sm action-delete" title="Delete"><i class="fa-solid fa-trash"></i></button>
                  </div>
              </li>
            `;
        }).join('');

        // --- Attach event listeners for quick actions ---
        profileListEl.querySelectorAll('.action-load').forEach(btn => btn.addEventListener('click', e => {
            loadProfile(e.currentTarget.closest('.profile-item').dataset.profileId);
            profileManagerModal.hide();
        }));
        profileListEl.querySelectorAll('.action-rename').forEach(btn => btn.addEventListener('click', e => {
            openRenameModal(e.currentTarget.closest('.profile-item').dataset.profileId);
        }));
        profileListEl.querySelectorAll('.action-delete').forEach(btn => btn.addEventListener('click', e => {
            const profileId = e.currentTarget.closest('.profile-item').dataset.profileId;
            const profileName = profiles[profileId]?.displayName || 'this profile';
            showConfirmationModal('Delete Profile?', `Are you sure you want to delete "${profileName}"?`, () => {
                deleteProfiles([profileId]);
            });
        }));

        document.getElementById('bulkActionsBtn').disabled = true;
        document.getElementById('exportProfilesBtnModal').disabled = true;
        document.getElementById('selectAllProfiles').checked = false;
        document.getElementById('selectAllProfiles').indeterminate = false;
      }

      function handleBulkAction() {
          const selectedIds = Array.from(document.querySelectorAll('.profile-checkbox:checked')).map(cb => cb.value);
          if (selectedIds.length === 0) {
              showToast('No profiles selected.', 'warning');
              return;
          }
          showConfirmationModal(`Delete ${selectedIds.length} Profiles?`, `This will permanently delete the selected profiles.`, () => {
              deleteProfiles(selectedIds);
          });
      }

      function deleteProfiles(idsToDelete) {
          const profiles = getProfiles();
          let deletedCount = 0;
          idsToDelete.forEach(id => {
              if (profiles[id]) {
                  delete profiles[id];
                  deletedCount++;
                  if (getActiveProfileId() === id) {
                      setActiveProfileId('');
                  }
              }
          });
          saveProfiles(profiles);
          showToast(`Successfully deleted ${deletedCount} profile(s).`, 'success');
          renderProfileManager();
          updateProfileSwitcher(profiles, getActiveProfileId());
          if (!getActiveProfileId()) {
              resultContainer.style.display = 'none';
              document.getElementById('bedResultContainer').style.display = 'none';
              registrationNumber.value = '';
          }
      }

      function exportSelectedProfiles() {
          const selectedIds = Array.from(document.querySelectorAll('#profileManagerList .profile-checkbox:checked')).map(cb => cb.value);
          const profiles = getProfiles();
          const profilesToExport = {};
          let exportCount = 0;
          let filename = `uaf-cgpa-profiles-backup-${new Date().toISOString().split('T')[0]}.json`;

          if (selectedIds.length === 0) {
              showToast('No profiles selected to export. Please select profiles from the list.', 'warning');
              return;
          }

          selectedIds.forEach(id => {
              if (profiles[id]) {
                  profilesToExport[id] = profiles[id];
                  exportCount++;
              }
          });

          if (exportCount === 1) {
              const singleProfileId = selectedIds[0];
              let profileName = 'profile'; 
              if (profiles[singleProfileId].displayName) {
                  profileName = profiles[singleProfileId].displayName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
              } else if (profiles[singleProfileId].studentInfo && profiles[singleProfileId].studentInfo.registration) {
                  profileName = profiles[singleProfileId].studentInfo.registration.replace(/[^a-z0-9]/gi, '_').toLowerCase();
              }
              filename = `${profileName}-profile-backup.json`;
          }

          const backupData = {
              version: '2.0.0',
              exportDate: new Date().toISOString(),
              profiles: profilesToExport
          };

          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename; 
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          saveBackupInfo({ lastBackup: new Date().toISOString() });
          showToast(`${exportCount} profile(s) exported.`, 'success');
          renderProfileManager();
      }


      function importProfiles() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = e => {
              const file = e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = event => {
                  try {
                      const importedData = JSON.parse(event.target.result);
                      
                      if (!importedData.profiles || importedData.version !== '2.0.0') {
                          throw new Error('Invalid or incompatible backup file.');
                      }

                      const existingProfiles = getProfiles();
                      let importedCount = 0, skippedCount = 0;

                      Object.keys(importedData.profiles).forEach(id => {
                          if (existingProfiles[id]) {
                              skippedCount++;
                          } else {
                              existingProfiles[id] = importedData.profiles[id];
                              importedCount++;
                          }
                      });

                      saveProfiles(existingProfiles);
                      showToast(`Import complete: ${importedCount} added, ${skippedCount} skipped.`, 'success');
                      loadProfiles(); 
                      if (profileManagerModalEl.classList.contains('show')) {
                        renderProfileManager();
                      }

                  } catch (error) {
                      showToast(`Import failed: ${error.message}`, 'error');
                      console.error('Import error:', error);
                  }
              };
              reader.onerror = event => {
                  showToast('Failed to read the file. Please check the file and try again.', 'error');
                  console.error('FileReader error:', event.target.error);
              };
              reader.readAsText(file);
          };
          input.click();
      }

      // --- END OF PROFILE MANAGER FUNCTIONS ---

      function updateTotalsDisplay() {
        const cgpaData = calculateCGPA(processedData);
        if (!cgpaData) return;

        studentName.innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${processedData.studentInfo.name}`;
        studentReg.textContent = processedData.studentInfo.registration;
        totalCgpa.textContent = formatNumber(cgpaData.cgpa).toFixed(4);
        totalPercentage.textContent = `${formatNumber(cgpaData.percentage, 2).toFixed(2)}%`;
        totalMarksObtained.textContent = cgpaData.totalMarksObtained.toFixed(0);
        totalMaxMarks.textContent = `/ ${cgpaData.totalMaxMarks.toFixed(0)}`;

        renderGpaChart();
        saveActiveProfile();
      }

      function initBackToTop() {
        window.addEventListener('scroll', () => backToTopButton.classList.toggle('visible', window.pageYOffset > 300));
        backToTopButton.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      }

      function createToastContainer() {
        if (!document.getElementById('toast-container')) {
          const toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          document.body.appendChild(toastContainer);
        }
      }

      function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.warn("Toast container not found, cannot show toast:", message);
            return;
        }
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        const icons = { success: 'fa-circle-check', error: 'fa-circle-exclamation', warning: 'fa-triangle-exclamation', info: 'fa-circle-info' };
        toast.innerHTML = `<div class="toast-content"><i class="toast-icon fa-solid ${icons[type]}"></i><span class="toast-message">${message}</span></div><div class="toast-progress"></div>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function initCustomCursor() {
        document.addEventListener('mousemove', (e) => {
          cursorDot.style.display = window.innerWidth > 992 ? 'block' : 'none';
          cursorDot.style.left = `${e.clientX}px`;
          cursorDot.style.top = `${e.clientY}px`;
        });
      }

      // NEW initTheme function
function initTheme() {
  const THEME_KEY = 'uaf-theme';
  
  // Find BOTH the new mobile input and the new desktop button
  const themeToggleInput = document.getElementById('themeToggleInput');
  const themeToggleBtn = document.getElementById('themeToggleBtn');

  const applyTheme = (theme) => {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    
    const isDark = theme === 'dark';
    
    // 1. Set the state of the mobile toggle (which is hidden but we sync it)
    if (themeToggleInput) {
        themeToggleInput.checked = isDark;
    }
    
    // 2. Set the icon for the desktop button
    if (themeToggleBtn) {
        const iconClass = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        themeToggleBtn.querySelector('i').className = iconClass;
    }
  };

  // Get the current theme and apply it
  const currentTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(currentTheme);

  // Function to handle the toggle logic
  const toggleLogic = () => {
    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    applyTheme(newTheme);
  };

  // Add event listeners to BOTH elements
  if (themeToggleInput) {
    themeToggleInput.addEventListener('change', toggleLogic);
  }
  if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', toggleLogic);
  }
}

      function initContactForm() {
        contactForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!contactForm.checkValidity()) {
            e.stopPropagation();
            contactForm.classList.add('was-validated');
            return;
          }
          const data = new FormData(contactForm);
          const statusEl = document.getElementById('contact-form-status');
          try {
            const res = await fetch(contactForm.action, { method: 'POST', body: data, headers: { 'Accept': 'application/json' } });
            if (res.ok) {
              statusEl.textContent = "Thanks! We'll get back to you soon.";
              statusEl.className = "text-success small";
              contactForm.reset();
              contactForm.classList.remove('was-validated');
              showToast('Message sent successfully!', 'success');
            } else {
              throw new Error('Form submission failed');
            }
          } catch {
            statusEl.textContent = "Oops! There was a problem. Please try again.";
            statusEl.className = "text-danger small";
            showToast('Failed to send message.', 'error');
          }
        });
      }

      function addStatusMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        allLogs.push({ timestamp, message, type });
        const messageEl = document.createElement('div');
        messageEl.className = `status-line status-${type}`;
        messageEl.textContent = `[${timestamp}] ${message}`;
        statusLog.prepend(messageEl);
        statusLog.scrollTop = 0;
      }

      function showLoadingStage(stage) {
        ['connecting', 'fetching', 'processing', 'complete'].forEach(s => {
          const el = document.getElementById(`${s}Stage`);
          if (el) el.style.display = 'none';
        });
        if (stage) {
            const el = document.getElementById(`${stage}Stage`);
            if (el) el.style.display = 'block';
        }
        loadingContainer.style.display = stage ? 'block' : 'none';
      }

      function downloadLog() {
        addStatusMessage('Preparing log file for download...', 'info');
        let logContent = "UAF CGPA Calculator - M SAQLAIN - Activity Log\n============================================\n\n";
        allLogs.forEach(log => logContent += `[${log.timestamp}] ${log.message}\n`);
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cgpa_calculator_log_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        addStatusMessage('Log file downloaded successfully', 'success');
        showToast('Log file downloaded!', 'success');
      }

      function clearLog() {
        statusLog.innerHTML = '';
        allLogs = [];
        addStatusMessage('Log cleared', 'info');
        showToast('Log cleared', 'info');
      }

      function processSemesterName(semester) {
          if (!semester) return 'Unknown Semester';

          const semesterLower = semester.toLowerCase();
          const yearRangeMatch = semesterLower.match(/(\d{4})-(\d{2,4})/);
          const singleYearMatch = semesterLower.match(/\b(\d{4})\b/);

          let season = 'Unknown';
          let year = '';

          if (semesterLower.includes('spring')) {
              season = 'Spring';
              if (yearRangeMatch) {
                  year = yearRangeMatch[2];
                  if (year.length === 2) {
                      year = `20${year}`;
                  }
              } else if (singleYearMatch) {
                  year = (parseInt(singleYearMatch[1]) + 1).toString();
              }
          } else if (semesterLower.includes('winter')) {
              season = 'Winter';
              if (yearRangeMatch) {
                  year = yearRangeMatch[1]; 
              } else if (singleYearMatch) {
                  year = singleYearMatch[1];
              }
          } else if (semesterLower.includes('summer')) {
              season = 'Summer';
              if (yearRangeMatch) {
                  year = yearRangeMatch[1];
              } else if (singleYearMatch) {
                  year = singleYearMatch[1];
              }
          } else if (semesterLower.includes('fall')) {
              season = 'Fall';
              if (yearRangeMatch) {
                  year = yearRangeMatch[1];
              } else if (singleYearMatch) {
                  year = singleYearMatch[1];
              }
          }

          if (season !== 'Unknown' && year) {
              return `${season} ${year}`;
          }
          
          const attendanceMatch = semesterLower.match(/^(winter|spring|summer|fall)(\d{2})$/);
          if (attendanceMatch) {
              const season = attendanceMatch[1].charAt(0).toUpperCase() + attendanceMatch[1].slice(1);
              const yearYY = attendanceMatch[2];
              return `${season} 20${yearYY}`;
          }

          return semester.charAt(0).toUpperCase() + semester.slice(1);
      }

      function getSemesterOrderKey(processedSemesterName) {
        if (!processedSemesterName) return '9999-9';

        const semesterLower = processedSemesterName.toLowerCase();

        if (semesterLower.startsWith('forecast')) {
            const num = parseInt(semesterLower.split(' ')[1] || '1');
            return `3000-${num.toString().padStart(2, '0')}`;
        }

        let year = 0;
        let seasonOrder = 9;

        const yearMatch = semesterLower.match(/\b(\d{4})\b/);
        if (yearMatch) {
            year = parseInt(yearMatch[1]);
        } else {
            return '9999-9';
        }

        let academicYearStart = year;

        if (semesterLower.includes('winter')) {
            seasonOrder = 1;
            academicYearStart = year;
        } else if (semesterLower.includes('spring')) {
            seasonOrder = 2;
            academicYearStart = year - 1;
        } else if (semesterLower.includes('summer')) {
            seasonOrder = 3;
            academicYearStart = year - 1;
        } else if (semesterLower.includes('fall')) {
            seasonOrder = 4;
            academicYearStart = year;
        } else {
             seasonOrder = 9;
             academicYearStart = year;
        }

        return `${academicYearStart}-${seasonOrder}`;
      }

      function processScrapedData(data) {
        if (!data || !data.resultData) return null;
        const studentInfo = { name: data.resultData[0]?.StudentName || '', registration: data.resultData[0]?.RegistrationNo || '' };
        const semesters = {};
        const courseHistory = {};
        
        let hasBedCourses = false;

        data.resultData.forEach(course => {
          const originalSemester = course.Semester || 'Unknown Semester';
          const semesterName = processSemesterName(originalSemester);
          const courseCode = (course.CourseCode || '').trim().toUpperCase();
          const historyKey = courseCode;

          const isBedCourse = BED_COURSES.has(courseCode); // <-- MODIFIED: Store this check
          if (isBedCourse) {
            hasBedCourses = true;
          }
          // --- End of NEW B.Ed. Check ---

          if (!semesters[semesterName]) {
            // Pass the *processed* semesterName to getSemesterOrderKey
            semesters[semesterName] = { 
              originalName: originalSemester, 
              sortKey: getSemesterOrderKey(semesterName), 
              courses: [],
              hasBedCourses: false,    // <-- ADD THIS
              hasOtherCourses: false   // <-- ADD THIS
            };
          }

          // --- ADD THIS BLOCK ---
          // Tag the semester with the type of course it contains
          if (isBedCourse) {
            semesters[semesterName].hasBedCourses = true;
          } else {
            semesters[semesterName].hasOtherCourses = true;
          }
          // --- END ADDED BLOCK ---

          const creditHoursStr = course.CreditHours || '0';
          const creditHours = parseInt(creditHoursStr.match(/\d+/)?.[0] || '0');
          const marks = parseFloat(course.Total || '0');
          let qualityPoints = calculateQualityPoints(marks, creditHours, course.Grade);

          if (course.Grade === 'F') {
            qualityPoints = 0;
          }

          const courseData = {
            code: courseCode,
            title: course.CourseTitle || '',
            creditHours: creditHours,
            creditHoursDisplay: creditHoursStr,
            marks: marks,
            qualityPoints: qualityPoints,
            grade: course.Grade || '',
            teacher: course.TeacherName || '',
            mid: course.Mid || '0',
            assignment: course.Assignment || '0',
            final: course.Final || '0',
            practical: course.Practical || '0',
            isExtraEnrolled: false,
            isRepeated: false,
            isDeleted: false,
            isCustom: false,
            originalSemester: originalSemester
          };

          if (!courseHistory[historyKey]) {
            courseHistory[historyKey] = [];
          }
          courseHistory[historyKey].push({ semester: semesterName, semesterSortKey: getSemesterOrderKey(semesterName), marks: marks, data: courseData });
          semesters[semesterName].courses.push(courseData);
        });

        Object.values(courseHistory).forEach(history => {
          if (history.length > 1) {
            history.sort((a, b) => a.semesterSortKey.localeCompare(b.semesterSortKey));

            const passedCourses = history.filter(item => item.data.grade !== 'F');
            let bestAttempt;

            if (passedCourses.length > 0) {
              bestAttempt = passedCourses.reduce((prev, current) => (prev.marks > current.marks) ? prev : current);
            } else {
              bestAttempt = history.reduce((prev, current) => (prev.marks > current.marks) ? prev : current);
            }

            history.forEach(item => {
              item.data.isRepeated = true;
              if (item !== bestAttempt) {
                item.data.isExtraEnrolled = true;
              } else {
                item.data.isExtraEnrolled = false;
              }
            });
          }
        });

        return { studentInfo, semesters, courseHistory, hasBedCourses };
      }

      function calculateQualityPoints(marks, creditHours, grade) {
        marks = parseFloat(marks);
        creditHours = parseInt(creditHours);
        
        grade = (grade || '').trim().toUpperCase();
        if (grade === 'P') {
            return parseFloat(creditHours) * 4.0;
        }
        if (grade === 'F') {
            return 0;
        }

        let qualityPoints = 0;
        if (creditHours === 10) {
            if (marks >= 160) qualityPoints = 40;
            else if (marks >= 100) qualityPoints = 40 - ((160 - marks) * 0.33333);
            else if (marks < 100) qualityPoints = 20 - ((100 - marks) * 0.5);
            if (marks < 80) qualityPoints = 0;
        } else if (creditHours === 9) {
            if (marks >= 144) qualityPoints = 36;
            else if (marks >= 90) qualityPoints = 36 - ((144 - marks) * 0.33333);
            else if (marks < 90) qualityPoints = 18 - ((90 - marks) * 0.5);
            if (marks < 72) qualityPoints = 0;
        } else if (creditHours === 8) {
            if (marks >= 128) qualityPoints = 32;
            else if (marks >= 80) qualityPoints = 32 - ((128 - marks) * 0.33333);
            else if (marks < 80) qualityPoints = 16 - ((80 - marks) * 0.5);
            if (marks < 64) qualityPoints = 0;
        } else if (creditHours === 7) {
            if (marks >= 112) qualityPoints = 28;
            else if (marks >= 70) qualityPoints = 28 - ((112 - marks) * 0.33333);
            else if (marks < 70) qualityPoints = 14 - ((70 - marks) * 0.5);
            if (marks < 56) qualityPoints = 0;
        } else if (creditHours === 6) {
            if (marks >= 96) qualityPoints = 24;
            else if (marks >= 60) qualityPoints = 24 - ((96 - marks) * 0.33333);
            else if (marks < 60) qualityPoints = 12 - ((60 - marks) * 0.5);
            if (marks < 48) qualityPoints = 0;
        } else if (creditHours === 5) {
            if (marks >= 80) qualityPoints = 20;
            else if (marks >= 50) qualityPoints = 20 - ((80 - marks) * 0.33333);
            else if (marks < 50) qualityPoints = 10 - ((50 - marks) * 0.5);
            if (marks < 40) qualityPoints = 0;
        } else if (creditHours === 4) {
            if (marks >= 64) qualityPoints = 16;
            else if (marks >= 40) qualityPoints = 16 - ((64 - marks) * 0.33333);
            else if (marks < 40) qualityPoints = 8 - ((40 - marks) * 0.5);
            if (marks < 32) qualityPoints = 0;
        } else if (creditHours === 3) {
            if (marks >= 48) qualityPoints = 12;
            else if (marks >= 30) qualityPoints = 12 - ((48 - marks) * 0.33333);
            else if (marks < 30) qualityPoints = 6 - ((30 - marks) * 0.5);
            if (marks < 24) qualityPoints = 0;
        } else if (creditHours === 2) {
            if (marks >= 32) qualityPoints = 8;
            else if (marks >= 20) qualityPoints = 8 - ((32 - marks) * 0.33333);
            else if (marks < 20) qualityPoints = 4 - ((20 - marks) * 0.5);
            if (marks < 16) qualityPoints = 0;
        } else if (creditHours === 1) {
            if (marks >= 16) qualityPoints = 4;
            else if (marks >= 10) qualityPoints = 4 - ((16 - marks) * 0.33333);
            else if (marks < 10) qualityPoints = 2 - ((10 - marks) * 0.5);
            if (marks < 8) qualityPoints = 0;
        }
        return parseFloat(Math.max(0, qualityPoints).toFixed(2));
      }

      function calculateCustomGrade(marks, creditHours) {
        const grading = { 10: { A: 160, B: 100, D: 80 }, 9: { A: 144, B: 90, D: 72 }, 8: { A: 128, B: 80, D: 64 }, 7: { A: 112, B: 70, D: 56 }, 6: { A: 96, B: 60, D: 48 }, 5: { A: 80, B: 50, D: 40 }, 4: { A: 64, B: 52, C: 40, D: 32 }, 3: { A: 48, B: 39, C: 30, D: 24 }, 2: { A: 32, B: 26, C: 20, D: 16 }, 1: { A: 16, B: 13, C: 10, D: 8 } };
        const scale = grading[creditHours];
        if (!scale) return 'F';
        if (marks >= scale.A) return 'A'; if (marks >= scale.B) return 'B';
        if (scale.C && marks >= scale.C) return 'C'; if (marks >= scale.D) return 'D';
        return 'F';
      }

      function calculateCGPA(data) {
        if (!data) return null;
        let totalQualityPoints = 0, totalCreditHours = 0, totalMarksObtained = 0, totalMaxMarks = 0;
        
        const courseHistory = {};
        Object.entries(data.semesters).forEach(([semesterName, semester]) => {
            semester.courses.forEach(course => {
                if (course.isDeleted) return; 
                
                const historyKey = course.code.toUpperCase().trim();
                if (!courseHistory[historyKey]) {
                    courseHistory[historyKey] = [];
                }
                courseHistory[historyKey].push({
                    semester: semesterName,
                    semesterSortKey: semester.sortKey,
                    marks: course.marks,
                    data: course
                });
            });
        });

        Object.values(courseHistory).flat().forEach(item => item.data.isExtraEnrolled = false);

        Object.values(courseHistory).forEach(history => {
            if (history.length > 1) {
                history.sort((a, b) => a.semesterSortKey.localeCompare(b.semesterSortKey));
                const passedCourses = history.filter(item => item.data.grade !== 'F');
                let bestAttempt;

                if (passedCourses.length > 0) {
                    bestAttempt = passedCourses.reduce((prev, current) => (prev.marks > current.marks) ? prev : current);
                } else {
                    bestAttempt = history.reduce((prev, current) => (prev.marks > current.marks) ? prev : current);
                }

                history.forEach(item => {
                    item.data.isRepeated = true;
                    if (item !== bestAttempt) {
                        item.data.isExtraEnrolled = true;
                    }
                });
            } else if (history.length === 1) {
                 history[0].data.isRepeated = false;
            }
        });


        Object.values(data.semesters).forEach(semester => {
            semester.totalQualityPoints = 0;
            semester.totalCreditHours = 0;
            semester.totalMarksObtained = 0;
            semester.totalMaxMarks = 0;
            semester.courses.forEach(course => {
                if (!course.isExtraEnrolled && !course.isDeleted) {
                    semester.totalQualityPoints += course.qualityPoints;
                    semester.totalCreditHours += course.creditHours;
                    semester.totalMarksObtained += course.marks;

                    let maxMarks;
                    if ((course.grade || '').trim().toUpperCase() === 'P') {
                        if (course.creditHours === 1) {
                            maxMarks = 100;
                        } else {
                            maxMarks = course.marks; 
                        }
                    } else {
                         maxMarks = { 10: 200, 9: 180, 8: 160, 7: 140, 6: 120, 5: 100, 4: 80, 3: 60, 2: 40, 1: 20 }[course.creditHours] || 0;
                    }

                    semester.totalMaxMarks += maxMarks;

                    totalQualityPoints += course.qualityPoints;
                    totalCreditHours += course.creditHours;
                    totalMarksObtained += course.marks;
                    totalMaxMarks += maxMarks;
                }
            });
            semester.gpa = semester.totalCreditHours > 0 ? (semester.totalQualityPoints / semester.totalCreditHours) : 0;
            semester.percentage = semester.totalMaxMarks > 0 ? (semester.totalMarksObtained / semester.totalMaxMarks * 100) : 0;
        });

        const cgpa = totalCreditHours > 0 ? (totalQualityPoints / totalCreditHours) : 0;
        const percentage = totalMaxMarks > 0 ? (totalMarksObtained / totalMaxMarks * 100) : 0;
        return { cgpa, percentage, totalQualityPoints, totalCreditHours, totalMarksObtained, totalMaxMarks };
      }
function formatNumber(value, places = 4) { return parseFloat(value.toFixed(places)); }

      // --- NEW Function: Renders semester cards into a specific container ---
      function displaySemesterCards(containerId, data) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';
        Object.keys(data.semesters).sort((a,b) => data.semesters[a].sortKey.localeCompare(data.semesters[b].sortKey)).forEach(semesterName => {
          const semester = data.semesters[semesterName];
          
          // const isForecastSemester = semester.isForecast === true; // <-- THIS LINE IS NO LONGER NEEDED
          
          // ---- BUG FIX ----
          // THE 'IF' BLOCK THAT HID EMPTY SEMESTERS HAS BEEN REMOVED.
          // if ((!semester.courses || semester.courses.length === 0) && !isForecastSemester) {
          //     return;
          // }
          // ---- END BUG FIX ----
          
          const semesterCard = document.createElement('div');
          
          semesterCard.dataset.semester = semesterName;

          const animationClass = isInitialLoad ? 'fade-in-on-scroll' : 'is-visible';
          semesterCard.className = `semester-card ${animationClass}`;

          semesterCard.dataset.semester = semesterName;
          
          const isForecastOrCustom = semesterName.toLowerCase().startsWith('forecast') || 
                                     !Object.values(processedData.courseHistory).flat().some(c => c.semester === semesterName && !c.data.isCustom);
          
          /* --- MODIFICATION: New Card UI --- */
          semesterCard.innerHTML = `
            <div class="semester-card-actions">
                ${isForecastOrCustom ? `<button class="action-icon edit-semester-name" title="Rename semester" data-semester="${semesterName}"><i class="fa-solid fa-pencil"></i></button>` : ''}
                <button class="action-icon add-course-btn" title="Add Custom Course" data-semester="${semesterName}"><i class="fa-solid fa-plus"></i></button>
                <button class="action-icon delete-semester" title="Delete Semester" data-semester="${semesterName}"><i class="fa-solid fa-trash"></i></button>
            </div>
            
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="mb-0 d-flex align-items-center gap-2">
                <i class="fa-solid fa-book-open" style="color: var(--brand-primary);"></i>
                <span id="semester-name-${semester.sortKey}">${semesterName}</span>
              </h5>
              <div class="gpa-display">
                <p class="gpa-value mb-0">${formatNumber(semester.gpa).toFixed(4)}</p>
                <p class="gpa-label">${formatNumber(semester.percentage, 2).toFixed(2)}%</p>
              </div>
            </div>

            <div class="table-responsive">
              <table class="course-table">
                <thead>
                  <tr>
                    <th>Course</th>
                    <th>Hrs</th>
                    <th>Marks</th>
                    <th>Grade</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>${semester.courses.map((course, index) => {
                    const courseIdentifier = `${semesterName}-${course.code}-${course.total}-${index}`;
                    const courseTitle = course.title || (course.isCustom ? 'Custom Course' : 'N/A');
                    return `
                    <tr data-course-identifier="${courseIdentifier}" draggable="true" class="${course.isExtraEnrolled ? 'table-warning' : ''} ${course.isDeleted ? 'table-danger' : ''} ${course.isCustom ? 'table-info' : ''}">
                      <td>
                        <div class="course-code-container">
                          <span class="fw-medium course-code clickable-info" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}'>
                            ${course.code}
                            <i class="fa-solid fa-info-circle ms-1 clickable-info small" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' title="${courseTitle}"></i>
                          </span>
                          ${course.isExtraEnrolled ? '<sup>Rep.</sup>' : ''}
                          ${course.isCustom && course.source === 'attendance' ? '<sup style="color: #087990; background-color: #cff4fc;">Atnd.</sup>' : ''}
                          ${course.isCustom && course.source !== 'attendance' ? '<sup>Custom</sup>' : ''}
                        </div>
                      </td>
                      <td>${course.creditHoursDisplay || course.creditHours}</td>
                      <td>${course.marks}</td>
                      <td><span class="grade-badge grade-${course.grade}">${course.grade}</span></td>
                      <td class="course-actions">
                        ${course.isDeleted 
                          ? `<i class="fa-solid fa-rotate-left restore-course" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' data-semester="${semesterName}" title="Restore"></i>` 
                          : `<i class="fa-solid fa-trash delete-course" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' data-semester="${semesterName}" title="Delete"></i>`
                        }
                      </td>
                    </tr>`;
                }).join('')}</tbody>
              </table>
            </div>
            
            <button class="custom-course-btn" data-semester="${semesterName}"><i class="fa-solid fa-plus me-1"></i> Add Custom Course</button>
          `;
          /* --- End Modification --- */

          container.appendChild(semesterCard);
        });

        isInitialLoad = false;
        // Note: We call attachResultEventListeners() *after* this function finishes
      }

      function displayCGPAResults(data, cgpaData) {
        processedData = data;
        resultContainer.style.display = 'block';

        // 1. Update the main CGPA card
        studentName.innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${data.studentInfo.name}`;
        studentReg.textContent = data.studentInfo.registration;
        totalCgpa.textContent = formatNumber(cgpaData.cgpa).toFixed(4);
        totalPercentage.textContent = `${formatNumber(cgpaData.percentage, 2).toFixed(2)}%`;
        totalMarksObtained.textContent = cgpaData.totalMarksObtained.toFixed(0);
        totalMaxMarks.textContent = `/ ${cgpaData.totalMaxMarks.toFixed(0)}`;

        const cgpaCircle = document.getElementById('cgpaCircle');
        if(cgpaCircle) {
            const cgpa = parseFloat(totalCgpa.textContent);
            const percentage = (cgpa / 4.0) * 100;
            setTimeout(() => {
                cgpaCircle.style.strokeDasharray = `${percentage}, 100`;
            }, 100);
        }

        // 2. Render the semester cards into the *standard* container
        displaySemesterCards('semesterResults', data);

        // 3. Attach listeners
        attachResultEventListeners();

        // 4. Render chart and setup buttons
        renderGpaChart();
        
        const hasAttendanceCourses = Object.values(data.semesters).some(s => s.courses.some(c => c.isCustom && c.source === 'attendance'));
        if (!hasAttendanceCourses) {
             importedAttendanceCourses = [];
        }
        importedAttendanceCourses = [];
        setupAttendanceButton();
      }

      // --- NEW Function: Renders the B.Ed. tabbed interface ---
      function displayBedResults(data) {
        processedData = data; 
        // 1. Filter for B.Ed. results
        const bedSemesters = filterSemesters(data.semesters, true);
        const bedData = { ...data, semesters: bedSemesters };
        const bedCgpa = calculateCGPA(bedData);

        // 2. Filter for "Other" results
        const otherSemesters = filterSemesters(data.semesters, false);
        const otherData = { ...data, semesters: otherSemesters };
        const otherCgpa = calculateCGPA(otherData);

        // --- Populate Student Info Headers ---
        document.getElementById('bed-studentName').innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${data.studentInfo.name}`;
        document.getElementById('bed-studentReg').textContent = data.studentInfo.registration;
        document.getElementById('other-studentName').innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${data.studentInfo.name}`;
        document.getElementById('other-studentReg').textContent = data.studentInfo.registration;

        // 3. Render the "B.Ed." tab content
        document.getElementById('bed-totalCgpa').textContent = bedCgpa.cgpa.toFixed(4);
        document.getElementById('bed-totalPercentage').textContent = `${bedCgpa.percentage.toFixed(2)}%`;
        document.getElementById('bed-totalMarksObtained').textContent = bedCgpa.totalMarksObtained.toFixed(0);
        document.getElementById('bed-totalMaxMarks').textContent = `/ ${bedCgpa.totalMaxMarks.toFixed(0)}`;
        const bedCircle = document.getElementById('bed-cgpaCircle');
        if (bedCircle) {
            const bedPercentage = (bedCgpa.cgpa / 4.0) * 100;
            setTimeout(() => bedCircle.style.strokeDasharray = `${bedPercentage}, 100`, 100);
        }
        displaySemesterCards('bed-semesterResults', bedData);

        // 4. Render the "Other" tab content
        document.getElementById('other-totalCgpa').textContent = otherCgpa.cgpa.toFixed(4);
        document.getElementById('other-totalPercentage').textContent = `${otherCgpa.percentage.toFixed(2)}%`;
        document.getElementById('other-totalMarksObtained').textContent = otherCgpa.totalMarksObtained.toFixed(0);
        document.getElementById('other-totalMaxMarks').textContent = `/ ${otherCgpa.totalMaxMarks.toFixed(0)}`;
        const otherCircle = document.getElementById('other-cgpaCircle');
        if (otherCircle) {
            const otherPercentage = (otherCgpa.cgpa / 4.0) * 100;
            setTimeout(() => otherCircle.style.strokeDasharray = `${otherPercentage}, 100`, 100);
        }
        displaySemesterCards('other-semesterResults', otherData);

        // 5. Render GPA charts
        gpaChartContainer.style.display = 'none'; 
        renderBedGpaCharts(bedData.semesters, otherData.semesters);

        // 6. Attach listeners to all new elements
        attachResultEventListeners();

        // 7. Setup attendance button
        setupAttendanceButton();
      }

      // --- NEW Function: Renders either Normal or B.Ed. UI ---
      function renderResults(data) {
        const bedResultContainer = document.getElementById('bedResultContainer');
        const standardGpaCard = document.querySelector('#resultContainer > .gpa-result-card-premium');
        const standardAttendanceBtnDiv = fetchAttendanceBtn ? fetchAttendanceBtn.parentElement : null; 
        const standardGpaChart = document.getElementById('gpaChartContainer');
        const standardActionButtons = document.querySelector('#resultContainer > .action-buttons-aligned');
        const standardSemesterContainer = document.getElementById('semesterResults') ? document.getElementById('semesterResults').parentElement : null; 

        if (bedModeActive) {
          if (standardGpaCard) standardGpaCard.style.display = 'none';
          if (standardAttendanceBtnDiv) standardAttendanceBtnDiv.style.display = 'none';
          if (standardGpaChart) standardGpaChart.style.display = 'none';
          if (standardActionButtons) standardActionButtons.style.display = 'none';
          if (standardSemesterContainer) standardSemesterContainer.style.display = 'none';

          bedResultContainer.style.display = 'block';
          displayBedResults(data);
        } else {
          if (standardGpaCard) standardGpaCard.style.display = 'block';
          if (standardAttendanceBtnDiv) standardAttendanceBtnDiv.style.display = 'block';
          if (standardGpaChart) standardGpaChart.style.display = 'block';
          if (standardActionButtons) standardActionButtons.style.display = 'flex';
          if (standardSemesterContainer) standardSemesterContainer.style.display = 'block';

          bedResultContainer.style.display = 'none';
          
          const cgpaData = calculateCGPA(data);
          displayCGPAResults(data, cgpaData);
        }
      }

      // --- NEW Function: Filters semesters into B.Ed. or Other ---
      function filterSemesters(semesters, includeBed) {
        const filteredSemesters = {};
        
        Object.entries(semesters).forEach(([semesterName, semester]) => {
          // This is the list of courses that *will be displayed* in this tab
          const newCourseList = [];
          
          // --- START FINAL FIX ---
          // Check if the identity flags exist. If not, calculate them.
          // This makes the function work for old profiles loaded from storage.
          let hasBedCourses = semester.hasBedCourses;
          let hasOtherCourses = semester.hasOtherCourses;

          if (hasBedCourses === undefined || hasOtherCourses === undefined) {
            // Flags are missing (old profile), calculate them now.
            hasBedCourses = false;
            hasOtherCourses = false;
            semester.courses.forEach(course => {
              if (BED_COURSES.has(course.code.toUpperCase().trim())) {
                hasBedCourses = true;
              } else {
                hasOtherCourses = true;
              }
            });
            // We'll also check all *other* semesters in processedData
            // in case the course was dragged to another semester
            if (processedData && processedData.semesters) {
                Object.values(processedData.semesters).forEach(s => {
                    s.courses.forEach(c => {
                        // If a course *originally* from this semester is now elsewhere
                        if (c.originalSemester === semester.originalName) {
                            if (BED_COURSES.has(c.code.toUpperCase().trim())) {
                                hasBedCourses = true;
                            } else {
                                hasOtherCourses = true;
                            }
                        }
                    });
                });
            }
          }
          // --- END FINAL FIX ---

          // Now, iterate *again* just to build the *display list*
          semester.courses.forEach(course => {
            const isBedCourse = BED_COURSES.has(course.code.toUpperCase().trim());
            
            if (includeBed && isBedCourse) {
              newCourseList.push(course); // Add to display list for B.Ed. tab
            } else if (!includeBed && !isBedCourse) {
              newCourseList.push(course); // Add to display list for Other tab
            }
          });

          const isForecast = semester.isForecast === true;
          const isBedForecast = semester.isBedForecast === true;

          let shouldBeInThisTab = false;

          if (includeBed) { // We are filtering FOR B.Ed. tab
            // Semester belongs here if it has B.Ed. courses OR is a B.Ed. forecast
            shouldBeInThisTab = hasBedCourses || (isForecast && isBedForecast);
          } else { // We are filtering FOR "Other" tab
            // Semester belongs here if it has Other courses OR is an "Other" forecast
            shouldBeInThisTab = hasOtherCourses || (isForecast && !isBedForecast);
          }
          
          // If the semester belongs in this tab (even if its newCourseList is now empty)
          if (shouldBeInThisTab) {
            filteredSemesters[semesterName] = {
                ...semester,
                courses: newCourseList // This list might be empty, which is what we want
            };
          }
        });
        return filteredSemesters;
      }

      // --- NEW Function: Handles B.Ed. Modal Choice ---
      function handleBedConfirm(isBedStudent, processed) {
        if(bedConfirmationModal) bedConfirmationModal.hide();
        bedModeActive = isBedStudent;
        processed.bedMode = isBedStudent;

        const profiles = getProfiles();
        const studentInfo = processed.studentInfo;
        let baseName = `${studentInfo.name} (${studentInfo.registration})`;
        let finalName = baseName;
        let copyNum = 1;

        const allDisplayNames = Object.values(profiles).map(p => p.displayName);

        while(allDisplayNames.includes(finalName)) {
            finalName = `${baseName} - ${copyNum++}`;
        }

        processed.displayName = finalName;
        processed.createdAt = new Date().toISOString();
        processed.lastModified = new Date().toISOString();
        const newProfileId = `profile_${Date.now()}`;
        profiles[newProfileId] = processed;
        saveProfiles(profiles);
        setActiveProfileId(newProfileId);

        processedData = processed;

        showLoadingStage('complete');
        setTimeout(() => {
          renderResults(processed);
          showLoadingStage(null);
          showToast('New profile created successfully!', 'success');
          updateProfileSwitcher(profiles, newProfileId);
        }, 1000);
      }

      function renderGpaChart() {
          if (!processedData || Object.keys(processedData.semesters).length === 0) {
              gpaChartContainer.style.display = 'none';
              return;
          }

          if (gpaChart) {
              gpaChart.destroy();
          }

          const sortedSemesters = Object.entries(processedData.semesters)
              .sort(([, a], [, b]) => a.sortKey.localeCompare(b.sortKey));

          const labels = sortedSemesters.map(([name]) => name);
          const gpaData = sortedSemesters.map(([, semester]) => formatNumber(semester.gpa, 4));

          const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
          const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
          const fontColor = isDarkMode ? 'var(--text-primary)' : 'var(--text-secondary)';

          gpaChart = new Chart(gpaTrendChartCanvas, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Semester GPA',
                      data: gpaData,
                      fill: true,
                      backgroundColor: 'rgba(122, 106, 216, 0.2)',
                      borderColor: 'rgba(122, 106, 216, 1)',
                      tension: 0.3,
                      pointBackgroundColor: 'rgba(122, 106, 216, 1)',
                      pointBorderColor: 'var(--bg-secondary)',
                      pointHoverRadius: 7,
                      pointHoverBackgroundColor: 'var(--bg-secondary)',
                      pointHoverBorderColor: 'rgba(122, 106, 216, 1)'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: {
                          beginAtZero: true,
                          suggestedMax: 4.0,
                          ticks: { color: fontColor },
                          grid: { color: gridColor }
                      },
                      x: {
                          ticks: { color: fontColor },
                          grid: { color: gridColor }
                      }
                  },
                  plugins: {
                      legend: { display: false },
                      tooltip: {
                          backgroundColor: 'var(--bg-secondary)',
                          titleColor: 'var(--text-primary)',
                          bodyColor: 'var(--text-secondary)',
                          borderColor: 'var(--border-color)',
                          borderWidth: 1,
                          padding: 10,
                          callbacks: {
                              label: context => `GPA: ${context.parsed.y.toFixed(4)}`
                          }
                      }
                  },
                  animation: {
                      duration: 1000,
                      easing: 'easeInOutQuart'
                  }
              }
          });
          gpaChartContainer.style.display = 'block';
      }

          function renderBedGpaCharts(bedSemesters, otherSemesters) {
        const bedChartContainer = document.getElementById('bedGpaChartContainer');
        const otherChartContainer = document.getElementById('otherGpaChartContainer');
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const fontColor = isDarkMode ? 'var(--text-primary)' : 'var(--text-secondary)';
        
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
              y: { beginAtZero: true, suggestedMax: 4.0, ticks: { color: fontColor }, grid: { color: gridColor } },
              x: { ticks: { color: fontColor }, grid: { color: gridColor } }
          },
          plugins: {
              legend: { display: false },
              tooltip: {
                  backgroundColor: 'var(--bg-secondary)',
                  titleColor: 'var(--text-primary)',
                  bodyColor: 'var(--text-secondary)',
                  borderColor: 'var(--border-color)',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: { label: context => `GPA: ${context.parsed.y.toFixed(4)}` }
              }
          },
          animation: { duration: 1000, easing: 'easeInOutQuart' }
        };

        // Render B.Ed. Chart
        if (bedGpaChart) bedGpaChart.destroy();
        const sortedBedSemesters = Object.entries(bedSemesters).sort(([, a], [, b]) => a.sortKey.localeCompare(b.sortKey));
        if (sortedBedSemesters.length > 0) {
            bedChartContainer.style.display = 'block';
            bedGpaChart = new Chart(document.getElementById('bedGpaTrendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedBedSemesters.map(([name]) => name),
                    datasets: [{
                        label: 'B.Ed. GPA',
                        data: sortedBedSemesters.map(([, semester]) => formatNumber(semester.gpa, 4)),
                        fill: true,
                        backgroundColor: 'rgba(122, 106, 216, 0.2)',
                        borderColor: 'rgba(122, 106, 216, 1)',
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(122, 106, 216, 1)',
                        pointBorderColor: 'var(--bg-secondary)',
                    }]
                },
                options: chartOptions
            });
        } else {
            bedChartContainer.style.display = 'none';
        }

        // Render Other Chart
        if (otherGpaChart) otherGpaChart.destroy();
        const sortedOtherSemesters = Object.entries(otherSemesters).sort(([, a], [, b]) => a.sortKey.localeCompare(b.sortKey));
        if (sortedOtherSemesters.length > 0) {
            otherChartContainer.style.display = 'block';
            otherGpaChart = new Chart(document.getElementById('otherGpaTrendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedOtherSemesters.map(([name]) => name),
                    datasets: [{
                        label: 'Other GPA',
                        data: sortedOtherSemesters.map(([, semester]) => formatNumber(semester.gpa, 4)),
                        fill: true,
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(255, 107, 107, 1)',
                        pointBorderColor: 'var(--bg-secondary)',
                    }]
                },
                options: chartOptions
            });
        } else {
            otherChartContainer.style.display = 'none';
        }
      }

function attachResultEventListeners() {
        document.querySelectorAll('.clickable-info').forEach(el => el.addEventListener('click', e => showCourseDetails(JSON.parse(e.currentTarget.dataset.course.replace(/&#39;/g, "'")))));
        
        /* --- MODIFICATION: Use new icon classes --- */
        document.querySelectorAll('.delete-semester').forEach(btn => btn.addEventListener('click', e => deleteSemester(e, e.currentTarget.dataset.semester)));
        document.querySelectorAll('.add-course-btn').forEach(btn => btn.addEventListener('click', e => openAddCourseModal(e.currentTarget.dataset.semester)));
        document.querySelectorAll('.edit-semester-name').forEach(btn => {
          btn.addEventListener('click', e => openRenameSemesterModal(e.currentTarget.dataset.semester));
        });
        /* --- End Modification --- */

        if(document.getElementById('copyDetailsIconBtn')) {
            document.getElementById('copyDetailsIconBtn').addEventListener('click', copyDetailsToClipboard);
        }
        document.querySelectorAll('.delete-course').forEach(btn => {
          const course = JSON.parse(btn.dataset.course.replace(/&#39;/g, "'"));
          btn.addEventListener('click', e => modifyCourseState(e, course, btn.dataset.semester, true));
        });
        document.querySelectorAll('.restore-course').forEach(btn => {
          const course = JSON.parse(btn.dataset.course.replace(/&#39;/g, "'"));
          btn.addEventListener('click', e => modifyCourseState(e, course, btn.dataset.semester, false));
        });
        document.querySelectorAll('.semester-card.fade-in-on-scroll:not(.is-visible)').forEach(el => {
            const observer = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting) {
                    entries[0].target.classList.add('is-visible');
                    observer.unobserve(entries[0].target);
                }
            }, { threshold: 0.1 });
            observer.observe(el);
        });
        if (window.innerWidth >= 992) {
          initDragAndDrop();
        }
      }

      function initDragAndDrop() {
          const draggables = document.querySelectorAll('.course-table tr[draggable="true"]');
          const droppables = document.querySelectorAll('.semester-card');

          draggables.forEach(draggable => {
              draggable.addEventListener('dragstart', e => {
                  e.target.classList.add('dragging');
                  const sourceSemester = e.target.closest('.semester-card').dataset.semester;
                  const courseIdentifier = e.target.dataset.courseIdentifier;
                  e.dataTransfer.setData('text/plain', JSON.stringify({ courseIdentifier, sourceSemester }));
              });
              draggable.addEventListener('dragend', e => {
                  e.target.classList.remove('dragging');
              });
          });

          droppables.forEach(droppable => {
              droppable.addEventListener('dragover', e => {
                  e.preventDefault();
                  e.currentTarget.classList.add('drag-over');
              });
              droppable.addEventListener('dragleave', e => {
                  e.currentTarget.classList.remove('drag-over');
              });
              droppable.addEventListener('drop', e => {
                  e.preventDefault();
                  e.currentTarget.classList.remove('drag-over');

                  const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                  const targetSemester = e.currentTarget.dataset.semester;

                  if (data.sourceSemester === targetSemester) {
                      return;
                  }

                  let courseToMove = null;
                  let courseIndex = -1;

                  const sourceSemesterCourses = processedData.semesters[data.sourceSemester]?.courses;
                  if (sourceSemesterCourses) {
                      courseIndex = sourceSemesterCourses.findIndex((course, index) => {
                          const identifier = `${data.sourceSemester}-${course.code}-${course.total}-${index}`;
                          return identifier === data.courseIdentifier;
                      });
                      if (courseIndex !== -1) {
                          courseToMove = sourceSemesterCourses[courseIndex];
                      }
                  }


                  if (courseToMove && courseIndex > -1) {
                      const isBedCourse = BED_COURSES.has(courseToMove.code.toUpperCase().trim());
                      const targetIsBedTab = e.currentTarget.closest('#bed-tab-content');
                      const targetIsOtherTab = e.currentTarget.closest('#other-tab-content');
                      
                      if (bedModeActive) {
                          if (isBedCourse && targetIsOtherTab) {
                              showToast(`Cannot move B.Ed. course (${courseToMove.code}) to "Other" tab.`, 'warning');
                              return;
                          }
                          if (!isBedCourse && targetIsBedTab) {
                              showToast(`Cannot move non-B.Ed. course (${courseToMove.code}) to "B.Ed." tab.`, 'warning');
                              return;
                          }
                      }

                      sourceSemesterCourses.splice(courseIndex, 1);
                      processedData.semesters[targetSemester].courses.push(courseToMove);
                      recalculateAndDisplay();
                      showToast(`Moved ${courseToMove.code} to ${targetSemester}`, 'success');
                      addStatusMessage(`Moved course ${courseToMove.code} from ${data.sourceSemester} to ${targetSemester}`, 'info');
                  } else {
                      showToast('Could not move course. Data might be out of sync.', 'error');
                      console.error('Course mismatch or not found. Identifier:', data.courseIdentifier, 'Index:', courseIndex);
                  }
              });
          });
      }

      function showCourseDetails(course) {
        let formattedSemester = course.originalSemester || 'Unknown Semester';
        formattedSemester = formattedSemester.replace(' Semester', '');
        formattedSemester = formattedSemester.replace(/(\d{4})-(\d{4})/, (match, y1, y2) => `${y1}-${y2.substring(2)}`);

        document.getElementById('courseDetailsModalTitle').textContent = `${course.code} - ${course.title || 'N/A'}`;

        const modalBody = document.getElementById('courseDetailsModalBody');
        modalBody.innerHTML = `
          <div class="mb-3 border-bottom pb-3">
            <h6 class="text-muted fw-bold small text-uppercase mb-2">Details</h6>
            <div class="row g-2">
              <div class="col-12 col-sm-6">
                <p class="mb-1 small"><i class="fa-solid fa-chalkboard-user fa-fw me-2" style="color:var(--brand-primary)"></i><strong>Teacher:</strong> ${course.teacher || 'N/A'}</p>
              </div>
              <div class="col-12 col-sm-6">
                <p class="mb-1 small"><i class="fa-solid fa-calendar-alt fa-fw me-2" style="color:var(--brand-primary)"></i><strong>Semester:</strong> ${formattedSemester}</p>
              </div>
              <div class="col-12">
                 <p class="mb-0 small"><i class="fa-solid fa-hourglass-half fa-fw me-2" style="color:var(--brand-primary)"></i><strong>Credit Hours:</strong> ${course.creditHoursDisplay || course.creditHours}</p>
              </div>
            </div>
          </div>

          <div class="mb-3 border-bottom pb-3">
            <h6 class="text-muted fw-bold small text-uppercase mb-2">Marks Breakdown</h6>
            <div class="row g-2">
              <div class="col-6 col-sm-3">
                <p class="mb-1 small text-center text-sm-start"><i class="fa-solid fa-file-pen fa-fw me-1" style="color:var(--info-primary)"></i><strong>Mid:</strong> ${course.mid || 'N/A'}</p>
              </div>
              <div class="col-6 col-sm-3">
                <p class="mb-1 small text-center text-sm-start"><i class="fa-solid fa-clipboard fa-fw me-1" style="color:var(--info-primary)"></i><strong>Assign:</strong> ${course.assignment || 'N/A'}</p>
              </div>
              <div class="col-6 col-sm-3">
                 <p class="mb-1 small text-center text-sm-start"><i class="fa-solid fa-flag-checkered fa-fw me-1" style="color:var(--info-primary)"></i><strong>Final:</strong> ${course.final || 'N/A'}</p>
              </div>
               ${course.practical && course.practical !== '0' ? `
                 <div class="col-6 col-sm-3">
                   <p class="mb-1 small text-center text-sm-start"><i class="fa-solid fa-flask-vial fa-fw me-1" style="color:var(--info-primary)"></i><strong>Prac:</strong> ${course.practical}</p>
                 </div>
               ` : ''}
            </div>
          </div>

          <div>
             <h6 class="text-muted fw-bold small text-uppercase mb-2">Result</h6>
             <div class="d-flex flex-wrap justify-content-around align-items-center rounded p-2" style="background-color: rgba(122, 106, 216, 0.05);">
                 <div class="text-center px-2">
                     <span class="small text-muted">Total Marks</span>
                     <p class="fs-5 fw-bold mb-0" style="color:var(--brand-primary)">${course.marks !== undefined ? course.marks : 'N/A'}</p>
                 </div>
                 <div class="text-center px-2">
                     <span class="small text-muted">Grade</span>
                     <p class="fs-5 mb-0"><span class="grade-badge grade-${course.grade}">${course.grade || 'N/A'}</span></p>
                 </div>
                 <div class="text-center px-2">
                     <span class="small text-muted">Quality Points</span>
                     <p class="fs-5 fw-bold mb-0" style="color:var(--brand-primary)">${course.qualityPoints !== undefined ? course.qualityPoints.toFixed(2) : 'N/A'}</p>
                 </div>
             </div>
          </div>

          ${course.isExtraEnrolled ? `<div class="alert alert-warning d-flex align-items-center mt-3 small p-2"><i class="fa-solid fa-info-circle me-2"></i> This is a repeated course attempt, and its marks are not the highest achieved. It does not count towards the CGPA calculation shown.</div>` : ''}
          ${course.isRepeated && !course.isExtraEnrolled ? `<div class="alert alert-success d-flex align-items-center mt-3 small p-2"><i class="fa-solid fa-check-circle me-2"></i> This is the highest scoring attempt for this repeated course and is used in CGPA calculation.</div>` : ''}
          ${course.isCustom ? `<div class="alert alert-info d-flex align-items-center mt-3 small p-2"><i class="fa-solid fa-pencil me-2"></i> This is a custom course added manually${course.source === 'attendance' ? ' (imported from Attendance System)' : ''}.</div>` : ''}`;

        courseDetailsModal.show();
      }

      function openAddCourseModal(semesterName) {
        document.getElementById('addCourseSemester').value = semesterName;
        addCourseForm.reset();
        addCourseModal.show();
      }

      function addCustomCourse() {
        const semesterName = document.getElementById('addCourseSemester').value;
        const courseCode = document.getElementById('courseCode').value.trim().toUpperCase();
        const courseTitle = document.getElementById('courseTitle').value.trim();
        const creditHours = parseInt(document.getElementById('creditHours').value);
        const marks = parseFloat(document.getElementById('courseMarks').value);
        if (!courseCode || !courseTitle || !creditHours || isNaN(marks)) {
          showToast('Please fill all fields correctly', 'error');
          return;
        }
        if (marks < 0 || marks > 100) {
             showToast('Marks must be between 0 and 100', 'error');
             return;
        }
        
        if (bedModeActive) {
            const isBedCourse = BED_COURSES.has(courseCode);
            const currentTab = document.querySelector('#bedTab .nav-link.active').id;
            
            if (isBedCourse && currentTab === 'other-tab') {
                showToast(`Cannot add B.Ed. course (${courseCode}) to "Other" tab.`, 'warning');
                return;
            }
            if (!isBedCourse && currentTab === 'bed-tab') {
                showToast(`Cannot add non-B.Ed. course (${courseCode}) to "B.Ed." tab.`, 'warning');
                return;
            }
        }

        const grade = calculateCustomGrade(marks, creditHours);
        const qualityPoints = calculateQualityPoints(marks, creditHours, grade);

        const newCourse = {
            code: courseCode, title: courseTitle, creditHours, creditHoursDisplay: `${creditHours}(${creditHours}-0)`, marks,
            qualityPoints: qualityPoints, grade: grade,
            semesterName, teacher: 'Custom', mid: 'N/A', assignment: 'N/A', final: marks, practical: 'N/A', total: marks,
            isExtraEnrolled: false, isRepeated: false, isDeleted: false, isCustom: true, originalSemester: semesterName
        };

        const semester = processedData.semesters[semesterName];
        if (semester && semester.courses.some(c => !c.isDeleted && c.code.toUpperCase() === newCourse.code)) {
            showToast(`Course ${newCourse.code} already exists in ${semesterName}. Edit or delete the existing one first.`, 'warning');
            return;
        }

        processedData.semesters[semesterName].courses.push(newCourse);
        recalculateAndDisplay();
        addCourseModal.hide();
        showToast(`Course ${courseCode} added`, 'success');
        addStatusMessage(`Added custom course: ${courseCode} to ${semesterName}`, 'info');
      }

      function deleteSemester(event, semesterName) {
        event.preventDefault();
        if (!processedData || !processedData.semesters[semesterName]) return;

        deletedSemesters[semesterName] = JSON.parse(JSON.stringify(processedData.semesters[semesterName]));
        delete processedData.semesters[semesterName];

        recalculateAndDisplay();

        showUndoNotification(`Semester "${semesterName}" deleted`, () => undoDeleteSemester(semesterName));
        addStatusMessage(`Deleted semester: ${semesterName}`, 'info');
      }

      function showUndoNotification(message, undoCallback) {
        document.getElementById('undo-notification-placeholder').innerHTML = `
          <div class="undo-notification" id="undo-notification">
            <span>${message}</span>
            <button class="undo-btn btn btn-sm">Undo</button>
          </div>
        `;
        const notification = document.getElementById('undo-notification');
        
        notification.querySelector('.undo-btn').onclick = () => {
            undoCallback();
            notification.remove();
        };
        setTimeout(() => notification.remove(), 5000);
      }

      function undoDeleteSemester(semesterName) {
        if (!deletedSemesters[semesterName]) return;

        processedData.semesters[semesterName] = deletedSemesters[semesterName];
        delete deletedSemesters[semesterName];

        recalculateAndDisplay();
        addStatusMessage(`Restored semester: ${semesterName}`, 'info');
      }

      function modifyCourseState(event, course, semesterName, isDeleted) {
        event.preventDefault();
        const semester = processedData.semesters[semesterName];
        if (!semester) return;

        const courseIndex = semester.courses.findIndex(c =>
            c.code === course.code &&
            c.title === course.title &&
            c.creditHours === course.creditHours &&
            c.marks === course.marks &&
            c.isCustom === course.isCustom
        );


        if (courseIndex !== -1) {
          semester.courses[courseIndex].isDeleted = isDeleted;
          recalculateAndDisplay();
          const action = isDeleted ? 'Deleted' : 'Restored';
          showToast(`Course ${course.code} ${action.toLowerCase()}`, 'info');
          addStatusMessage(`${action} course: ${course.code} from ${semesterName}`, 'info');
        } else {
          console.error("Could not find course to modify state:", course, "in semester:", semesterName);
          showToast(`Error modifying course ${course.code}`, 'error');
        }
      }


      function recalculateAndDisplay() {
        saveActiveProfile();
        renderResults(processedData);
      }

      function addForecastSemester() {
        let isForBedTab = false;
        if (bedModeActive) {
            const activeTabId = document.querySelector('#bedTab .nav-link.active').id;
            if (activeTabId === 'bed-tab') {
                isForBedTab = true;
            }
        }

        let forecastCount = 1;
        while (`Forecast ${forecastCount}` in processedData.semesters) {
            forecastCount++;
        }
        const newSemesterName = `Forecast ${forecastCount}`;
        processedData.semesters[newSemesterName] = {
            originalName: newSemesterName,
            sortKey: getSemesterOrderKey(newSemesterName),
            courses: [],
            isForecast: true,
            isBedForecast: isForBedTab
        };
        
        recalculateAndDisplay();
        showToast(`Added "${newSemesterName}"`, 'success');
        addStatusMessage(`Added forecast semester: ${newSemesterName}`, 'info');

        setTimeout(() => {
          const newCard = document.querySelector(`[data-semester="${newSemesterName}"]`);
          if (newCard) {
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            newCard.style.transition = 'background-color 0.5s ease-out, border-color 0.5s ease-out';
            newCard.style.backgroundColor = 'rgba(122, 106, 216, 0.1)';
            newCard.style.borderColor = 'var(--brand-primary)';
            setTimeout(() => {
                newCard.style.backgroundColor = '';
                newCard.style.borderColor = 'var(--border-color)';
            }, 1000);
          }
        }, 100);
      }

      function openRenameSemesterModal(oldSemesterName) {
        if (!processedData.semesters[oldSemesterName]) return;
        document.getElementById('newSemesterName').value = oldSemesterName;
        saveSemesterNameBtn.dataset.oldName = oldSemesterName;
        renameSemesterModal.show();
      }

      function renameSemester() {
        const oldSemesterName = saveSemesterNameBtn.dataset.oldName;
        const newSemesterName = document.getElementById('newSemesterName').value.trim();

        if (!newSemesterName || newSemesterName === "") {
          showToast("Semester name cannot be empty.", 'warning');
          return;
        }

        if (newSemesterName === oldSemesterName) {
          renameSemesterModal.hide();
          return;
        }

        if (processedData.semesters[newSemesterName]) {
          showToast(`Semester name "${newSemesterName}" already exists.`, 'error');
          return;
        }

        processedData.semesters[newSemesterName] = processedData.semesters[oldSemesterName];
        delete processedData.semesters[oldSemesterName];
        
        processedData.semesters[newSemesterName].originalName = newSemesterName;
        processedData.semesters[newSemesterName].sortKey = getSemesterOrderKey(newSemesterName);
        
        recalculateAndDisplay();
        renameSemesterModal.hide();
        showToast(`Semester renamed to "${newSemesterName}"`, 'success');
        addStatusMessage(`Renamed semester "${oldSemesterName}" to "${newSemesterName}"`, 'info');
      }
      
      function copyDetailsToClipboard() {
          if (!processedData) return;
          const textToCopy = `Name: ${processedData.studentInfo.name}\nRegistration: ${processedData.studentInfo.registration}\nCGPA: ${totalCgpa.textContent}\nPercentage: ${totalPercentage.textContent}`;
          navigator.clipboard.writeText(textToCopy).then(() => {
              showToast('Details copied to clipboard!', 'success');
          }, (err) => {
              showToast('Failed to copy details.', 'error');
              console.error('Clipboard copy failed: ', err);
          });
      }

      function generatePDF() {
        if (!processedData) {
            showToast('No data to download', 'error');
            return;
        }

        let dataToPrint, titleSuffix;
        if (bedModeActive) {
            const activeTabId = document.querySelector('#bedTab .nav-link.active').id;
            if (activeTabId === 'bed-tab') {
                const bedSemesters = filterSemesters(processedData.semesters, true);
                dataToPrint = { ...processedData, semesters: bedSemesters };
                titleSuffix = 'B.Ed. Program';
            } else {
                const otherSemesters = filterSemesters(processedData.semesters, false);
                dataToPrint = { ...processedData, semesters: otherSemesters };
                titleSuffix = 'Other Programs';
            }
        } else {
            dataToPrint = processedData;
            titleSuffix = 'Overall';
        }


        addStatusMessage(`Generating premium PDF report (${titleSuffix})...`, 'info');
        showLoadingStage('processing');

        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const cgpaData = calculateCGPA(dataToPrint);

            const pageMargin = 15;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const availableWidth = pageWidth - (2 * pageMargin);
            const colors = {
                primary: '#7a6ad8',
                textDark: '#1b1f24',
                textLight: '#4b5563',
                line: '#e0e0e0',
                fillLight: '#f8f9ff',
            };
            let lastY = 0;

            const drawFirstPageHeader = () => {
                pdf.setFontSize(18);
                pdf.setTextColor(colors.primary);
                pdf.setFont('helvetica', 'bold');
                pdf.text("University of Agriculture Faisalabad (UAF)", pageWidth / 2, 20, { align: 'center' });

                pdf.setFontSize(12);
                pdf.setTextColor(colors.textLight);
                pdf.setFont('helvetica', 'normal');
                
                let transcriptTitle = "Unofficial Academic Transcript";
                if (bedModeActive) {
                    transcriptTitle += ` (${titleSuffix})`;
                }
                pdf.text(transcriptTitle, pageWidth / 2, 28, { align: 'center' });

                pdf.setDrawColor(colors.primary);
                pdf.setLineWidth(0.5);
                pdf.line(pageMargin, 35, pageWidth - pageMargin, 35);
                lastY = 35;
            };

            drawFirstPageHeader();

            const topBoxY = lastY + 10;
            const boxHeight = 45;
            const gap = 5;
            const leftBoxWidth = availableWidth * 0.4;
            const rightBoxWidth = availableWidth - leftBoxWidth - gap;
            const rightBoxX = pageMargin + leftBoxWidth + gap;

            pdf.setFillColor(colors.fillLight);
            pdf.roundedRect(pageMargin, topBoxY, leftBoxWidth, boxHeight, 3, 3, 'F');
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(colors.textDark);
            pdf.text("Student Information", pageMargin + 5, topBoxY + 8);
            pdf.setDrawColor(colors.line);
            pdf.line(pageMargin + 5, topBoxY + 11, pageMargin + leftBoxWidth - 5, topBoxY + 11);

            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(colors.primary);
            pdf.text(dataToPrint.studentInfo.name, pageMargin + 5, topBoxY + 25, { maxWidth: leftBoxWidth - 10 });

            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(colors.textLight);
            pdf.text(dataToPrint.studentInfo.registration, pageMargin + 5, topBoxY + 30);

            pdf.setFillColor(colors.fillLight);
            pdf.roundedRect(rightBoxX, topBoxY, rightBoxWidth, boxHeight, 3, 3, 'F');
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(colors.textDark);
            
            pdf.text(`Academic Summary`, rightBoxX + 5, topBoxY + 8); 
            
            pdf.line(rightBoxX + 5, topBoxY + 11, rightBoxX + rightBoxWidth - 5, topBoxY + 11);

            pdf.setFontSize(22);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(colors.primary);
            pdf.text(formatNumber(cgpaData.cgpa, 4).toFixed(4), rightBoxX + 5, topBoxY + 25);
            pdf.setFontSize(8);
            pdf.setTextColor(colors.textLight);
            
            pdf.text(`Overall CGPA`, rightBoxX + 5, topBoxY + 29); 

            const statsStartX = rightBoxX + 40;
            pdf.setFont('helvetica', 'bold');
            pdf.text("Percentage:", statsStartX, topBoxY + 20);
            pdf.text("Total Credits:", statsStartX, topBoxY + 28);
            pdf.text("Total Marks:", statsStartX, topBoxY + 36);

            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(colors.textDark);
            pdf.text(`${formatNumber(cgpaData.percentage, 2).toFixed(2)}%`, statsStartX + 25, topBoxY + 20);
            pdf.text(cgpaData.totalCreditHours.toString(), statsStartX + 25, topBoxY + 28);
            pdf.text(`${cgpaData.totalMarksObtained.toFixed(0)} / ${cgpaData.totalMaxMarks}`, statsStartX + 25, topBoxY + 36);

            lastY = topBoxY + boxHeight;

            let semesterIndex = 0;
            Object.keys(dataToPrint.semesters)
                .sort((a, b) => dataToPrint.semesters[a].sortKey.localeCompare(dataToPrint.semesters[b].sortKey))
                .forEach(semesterName => {
                    semesterIndex++;
                    const semester = dataToPrint.semesters[semesterName];
                    const activeCourses = semester.courses.filter(c => !c.isDeleted);
                    if (activeCourses.length === 0) return;

                    const semesterSummary = `GPA: ${formatNumber(semester.gpa, 4).toFixed(4)}  |  Credit Hours: ${semester.totalCreditHours}  |  Marks: ${semester.totalMarksObtained.toFixed(0)}/${semester.totalMaxMarks}`;

                    if (lastY + 30 > pageHeight - 30) {
                        pdf.addPage();
                        lastY = 20;
                    }
                    const semesterHeaderY = lastY + 12;

                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(colors.primary);
                    pdf.text(`${semesterIndex}. ${semesterName}`, pageMargin, semesterHeaderY);

                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(colors.textDark);
                    pdf.text(semesterSummary, pageWidth - pageMargin, semesterHeaderY, { align: 'right' });

                    lastY = semesterHeaderY + 2;

                    const head = [['Course Code', 'Course Title', 'CH', 'Marks', 'Grade']];
                    const body = activeCourses.map(c => [
                        c.code + (c.isCustom ? '*' : ''),
                        c.title || (c.isCustom ? 'Custom Course' : 'N/A'),
                        c.creditHoursDisplay || c.creditHours,
                        c.marks.toFixed(0),
                        c.grade
                    ]);


                    pdf.autoTable({
                        head: head,
                        body: body,
                        startY: lastY,
                        margin: { left: pageMargin, right: pageMargin },
                        headStyles: { fillColor: colors.primary, textColor: '#ffffff', fontStyle: 'bold', halign: 'center', valign: 'middle' },
                        columnStyles: {
                            0: { halign: 'left', cellWidth: availableWidth * 0.18 },
                            1: { halign: 'left', cellWidth: availableWidth * 0.46, cellPadding: { left: 2 } },
                            2: { halign: 'center', cellWidth: availableWidth * 0.12 },
                            3: { halign: 'center', cellWidth: availableWidth * 0.12 },
                            4: { halign: 'center', cellWidth: availableWidth * 0.12 }
                        },
                        styles: { valign: 'middle', cellPadding: 2.2, fontSize: 9 },
                        alternateRowStyles: { fillColor: '#f8f9ff' },
                         didDrawPage: (data) => {
                             lastY = data.cursor.y;
                         }
                    });
                     lastY = pdf.lastAutoTable.finalY;


                    if (lastY < pageHeight - 30) {
                         pdf.setDrawColor(colors.line);
                         pdf.setLineWidth(0.3);
                         pdf.line(pageMargin, lastY + 6, pageWidth - pageMargin, lastY + 6);
                         lastY += 6;
                    }
                });

            const totalPages = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                pdf.setPage(i);
                pdf.setFontSize(9);
                pdf.setTextColor(colors.textLight);
                pdf.setFont('helvetica', 'italic');
                const footerY = pageHeight - 15;

                pdf.text("Generated by UAF CGPA Calculator - M Saqlain (https://uafcgpacalculator.vercel.app)", pageWidth / 2, footerY, { align: 'center' });
                pdf.text("This is an unofficial transcript. * indicates a custom course added manually.", pageWidth / 2, footerY + 5, { align: 'center' });

                pdf.setFontSize(8).setTextColor('#b0b0b0');
                pdf.text(`Page ${i} of ${totalPages}`, pageWidth - pageMargin, pageHeight - 10, { align: 'right' });
            }

            const safeSuffix = titleSuffix.replace(/ /g, '_');
            pdf.save(`UAF_Transcript_${dataToPrint.studentInfo.registration}_${safeSuffix}.pdf`);
            addStatusMessage('PDF report generated successfully', 'success');
            showToast('PDF downloaded!', 'success');
        } catch (e) {
            addStatusMessage(`Error generating PDF: ${e.message}`, 'error');
            showToast('Error generating PDF', 'error');
            console.error("PDF generation error: ", e);
        } finally {
            showLoadingStage(null);
        }
      }

    function processAttendanceData(data) {
        if (!data || !data.resultData) {
            showToast('No attendance data to process.', 'info');
            return;
        }

        addStatusMessage(`Processing ${data.resultData.length} records from Attendance System...`, 'info');

        const globalLmsCourseMap = new Map();
        Object.values(processedData.semesters).forEach(sem => {
            sem.courses.forEach(course => {
                if (!course.isDeleted && course.source !== 'attendance') {
                    const code = course.code.toUpperCase().trim();
                    const marks = parseFloat(course.marks);
                    const grade = (course.grade || 'N/A').toUpperCase().trim();
                    const key = `${marks}|${grade}`;
                    
                    if (!globalLmsCourseMap.has(code)) {
                        globalLmsCourseMap.set(code, new Set());
                    }
                    globalLmsCourseMap.get(code).add(key);
                }
            });
        });

        const allAttendanceCourses = [];
        data.resultData.forEach(attCourse => {
            const courseCode = (attCourse.CourseCode || '').toUpperCase().trim();
            const semesterName = processSemesterName(attCourse.Semester);
            const marks = parseFloat(attCourse.Totalmark || '0');
            const grade = (attCourse.Grade || 'N/A').toUpperCase().trim();
            const globalKey = `${marks}|${grade}`;

            let isDuplicate = false;

            if (globalLmsCourseMap.has(courseCode) && globalLmsCourseMap.get(courseCode).has(globalKey)) {
                isDuplicate = true;
            }

            const semesterExists = processedData.semesters[semesterName];
            if (!isDuplicate && semesterExists && semesterExists.courses.some(c => 
                    c.code.toUpperCase().trim() === courseCode && 
                    c.isCustom && 
                    c.source === 'attendance'
                )) {
                isDuplicate = true;
            }

            allAttendanceCourses.push({
                code: (attCourse.CourseCode || '').trim(),
                title: attCourse.CourseName || 'N/A',
                semester: semesterName,
                marks: marks,
                grade: (attCourse.Grade || 'N/A'),
                teacher: attCourse.TeacherName || 'N/A',
                mid: attCourse.Mid || '0',
                assignment: attCourse.Assigment || '0',
                final: attCourse.Final || '0',
                practical: attCourse.Practical || '0',
                isDuplicate: isDuplicate 
            });
        });

        if (allAttendanceCourses.length > 0) {
            const importableCount = allAttendanceCourses.filter(c => !c.isDuplicate).length;
            addStatusMessage(`${allAttendanceCourses.length} courses found, ${importableCount} are new/importable. Showing import dialog.`, 'info');
            renderAttendanceImportModal(allAttendanceCourses);
            attendanceImportModal.show();
        } else {
            showToast('No courses found in Attendance System.', 'info');
            addStatusMessage('Attendance System search returned no courses.', 'success');
        }
    }


    async function fetchAttendanceData(clickedButton) {
        if (!processedData || !processedData.studentInfo || !processedData.studentInfo.registration) {
            showToast('Please fetch results first.', 'warning');
            return;
        }
        const regNum = processedData.studentInfo.registration;
        const cacheKey = `uafAttendanceCache_${regNum}`;
        const TEN_MINUTES_MS = 10 * 60 * 1000;

        try {
            const cachedDataJSON = localStorage.getItem(cacheKey);
            if (cachedDataJSON) {
                const cachedData = JSON.parse(cachedDataJSON);
                const cacheAge = Date.now() - cachedData.timestamp;

                if (cacheAge < TEN_MINUTES_MS) {
                    addStatusMessage(`Using cached attendance data (fetched ${Math.round(cacheAge / 1000 / 60)} mins ago).`, 'info');
                    showToast('Using cached attendance data.', 'info');
                    processAttendanceData(cachedData.data);
                    return;
                } else {
                    addStatusMessage('Cached attendance data is stale (> 10 mins). Fetching new data.', 'info');
                    localStorage.removeItem(cacheKey);
                }
            }
        } catch (e) {
            console.error('Error reading cache:', e);
            localStorage.removeItem(cacheKey);
        }

        addStatusMessage(`Fetching results from Attendance System for: ${regNum}`, 'info');
        
        if (clickedButton) {
            clickedButton.disabled = true;
            clickedButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Fetching...';
        }

        try {
            const response = await fetch(`${ATTENDANCE_API_ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.message || `Server responded with status ${response.status}`);
            }
            
            addStatusMessage(`Successfully fetched ${data.resultData.length} records from Attendance System`, 'success');

            try {
                localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data: data }));
                addStatusMessage('Saved attendance data to cache.', 'info');
            } catch (e) {
                console.error('Error saving to cache:', e);
                addStatusMessage('Could not save attendance data to cache (storage might be full).', 'warning');
            }

            processAttendanceData(data);

        } catch (error) {
            console.error("Attendance Fetch Error:", error);
            let userMessage = 'Could not retrieve Attendance System results. The server may be offline or the registration number is incorrect.';
            if (error.message.includes('timed out')) {
                userMessage = 'Connection to Attendance System timed out. Please try again later.';
            } else if (error.message.includes('No results found')) {
                userMessage = error.message; 
            }
            addStatusMessage(`Error fetching from Attendance System: ${error.message}`, 'error');
            showToast(userMessage, 'error');
        } finally {
            if (importedAttendanceCourses.length === 0) {
                 setupAttendanceButton();
            }
        }
    }

function renderAttendanceImportModal(courses) {
        const listEl = document.getElementById('attendanceCourseList');
        const listElContainer = listEl.parentNode;
        let newListEl = listEl.cloneNode(false);
        
        const toggleSwitch = document.getElementById('toggleAllCourses');
        const selectAllCheckbox = document.getElementById('toggleSelectAllCourses');
        const courseCountEl = document.getElementById('attendanceCourseCount');
        const modalTitle = document.getElementById('attendanceModalTitle');
        const modalDescription = document.getElementById('attendanceModalDescription');
        
        if (courses.length === 0) {
            newListEl.innerHTML = '<p class="text-center text-muted p-3">No courses found in Attendance System.</p>';
            importAttendanceCoursesBtn.disabled = true;
            if (toggleSwitch) toggleSwitch.closest('.d-flex').style.display = 'none';
            courseCountEl.textContent = 'Total: 0';
            listElContainer.replaceChild(newListEl, listEl);
            updateAttendanceCounts();
            return;
        }

        let missingCoursesFound = false;
        
        courses.forEach((course, index) => {
            const courseId = `att-course-${index}`;
            const selectId = `att-ch-${index}`;
            const item = document.createElement('div');
            item.className = 'attendance-course-item';
            
            if (course.isDuplicate) {
                item.classList.add('duplicate-course');
                item.style.display = 'none';
            } else {
                missingCoursesFound = true;
            }

            let labelText = '';
            if (course.title && course.title.toLowerCase() !== 'n/a' && course.title.trim() !== '') {
                labelText = `${course.title} - `;
            }
            labelText += `Marks: ${course.marks}, Grade: ${course.grade}`;

            item.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${index}" id="${courseId}" 
                        ${course.isDuplicate ? 'disabled' : 'checked'}>
                    <label class="form-check-label" for="${courseId}">
                        <strong>${course.code}</strong> (${course.semester})
                        ${course.isDuplicate ? '<span class="badge rounded-pill" style="font-size: 0.7em; background-color: rgba(22, 160, 133, 0.1); color: #16a085;">In LMS</span>' : ''}
                        <small class="d-block text-muted">${labelText}</small>
                    </label>
                </div>
                <div class="import-ch-select">
                    <label for="${selectId}" class="form-label mb-0 small me-2">CH:</label>
                    <select class="form-select form-select-sm" id="${selectId}" ${course.isDuplicate ? 'disabled' : ''} style="width: 75px;">
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(ch => `<option value="${ch}" ${ch === 3 ? 'selected' : ''}>${ch}</option>`).join('')}
                    </select>
                </div>
            `;
            item.querySelector(`#${courseId}`).dataset.courseData = JSON.stringify(course);
            newListEl.appendChild(item);
        });

        listElContainer.replaceChild(newListEl, listEl);

        newListEl.addEventListener('change', (e) => {
            if (e.target.classList.contains('form-check-input')) {
                updateAttendanceCounts();
            }
        });

        if (toggleSwitch) {
            toggleSwitch.closest('.d-flex').style.display = 'flex';
            toggleSwitch.checked = false; 
            
            const newToggle = toggleSwitch.cloneNode(true);
            toggleSwitch.parentNode.replaceChild(newToggle, toggleSwitch);
            
            newToggle.addEventListener('change', (e) => {
                const showAll = e.target.checked;
                newListEl.querySelectorAll('.duplicate-course').forEach(item => {
                    item.style.display = showAll ? 'flex' : 'none'; 
                });
                updateAttendanceCounts();
            });
        }
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
            
            const newSelectAll = selectAllCheckbox.cloneNode(true);
            selectAllCheckbox.parentNode.replaceChild(newSelectAll, selectAllCheckbox);

            newSelectAll.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                newListEl.querySelectorAll('.attendance-course-item').forEach(item => {
                    if (item.style.display !== 'none') {
                        const checkbox = item.querySelector('.form-check-input:not(:disabled)');
                        if (checkbox) {
                            checkbox.checked = isChecked;
                        }
                    }
                });
                updateAttendanceCounts();
            });
        }

        courseCountEl.textContent = `Total: ${courses.length}`;
        
        if (missingCoursesFound) {
            modalTitle.innerHTML = '<i class="fa-solid fa-clipboard-user me-2"></i>Import Missing Courses';
            modalDescription.textContent = 'The following courses were found in the Attendance System but not in your main LMS results. Select courses to import and set their credit hours.';
        } else {
            modalTitle.innerHTML = '<i class="fa-solid fa-clipboard-check me-2"></i>Courses Synced';
            modalDescription.textContent = 'All courses found in the Attendance System are already present in your LMS results. You can toggle "Show All" to review them.';
        }

        importAttendanceCoursesBtn.disabled = false;
        updateAttendanceCounts();
    }


     function importSelectedAttendanceCourses() {
        importedAttendanceCourses = [];
        const selectedCheckboxes = document.querySelectorAll('#attendanceCourseList .form-check-input:checked');
        let importedCount = 0;

        selectedCheckboxes.forEach(checkbox => {
            if (checkbox.disabled) return;

            const courseData = JSON.parse(checkbox.dataset.courseData);
            const index = checkbox.value;
            const creditHoursSelect = document.getElementById(`att-ch-${index}`);
            const creditHours = parseInt(creditHoursSelect.value);

            if (!isNaN(creditHours) && creditHours > 0 && creditHours <= 10) {
                const semesterName = courseData.semester;

                if (!processedData.semesters[semesterName]) {
                    processedData.semesters[semesterName] = {
                        originalName: semesterName,
                        sortKey: getSemesterOrderKey(semesterName),
                        courses: []
                    };
                     addStatusMessage(`Created new semester entry: ${semesterName} during import`, 'info');
                }

                const marks = courseData.marks;
                const grade = calculateCustomGrade(marks, creditHours);
                const qualityPoints = calculateQualityPoints(marks, creditHours, grade);

                const newCourse = {
                    code: courseData.code,
                    title: courseData.title || 'Imported from Attendance',
                    creditHours: creditHours,
                    creditHoursDisplay: `${creditHours}(${creditHours}-0)`,
                    marks: marks,
                    qualityPoints: qualityPoints,
                    grade: grade, 
                    teacher: courseData.teacher || 'Attendance System',
                    mid: courseData.mid || 'N/A',
                    assignment: courseData.assignment || 'N/A',
                    final: courseData.final || 'N/A',
                    practical: courseData.practical || 'N/A',
                    total: marks,
                    isExtraEnrolled: false,
                    isRepeated: false,
                    isDeleted: false,
                    isCustom: true,
                    source: 'attendance',
                    originalSemester: semesterName
                };

                const semester = processedData.semesters[semesterName];
                 if (!semester.courses.some(c => !c.isDeleted && c.code.toUpperCase() === newCourse.code)) {
                     semester.courses.push(newCourse);
                     importedAttendanceCourses.push({ semester: semesterName, code: newCourse.code });
                     importedCount++;
                 } else {
                     addStatusMessage(`Skipped importing ${newCourse.code} for ${semesterName} as it already exists.`, 'warning');
                 }

            } else {
                 showToast(`Invalid Credit Hours selected for ${courseData.code}`, 'warning');
            }
        });

        if (importedCount > 0) {
            recalculateAndDisplay();
            showToast(`${importedCount} course(s) imported successfully!`, 'success');
            addStatusMessage(`Imported ${importedCount} courses from Attendance System.`, 'info');
        } else {
              showToast('No new courses were imported.', 'info');
              importedAttendanceCourses = [];
        }

        setupAttendanceButton();
        attendanceImportModal.hide();
    }



      async function fetchResult() {
        const regNum = registrationNumber.value.trim();
        if (!regNum) { showToast('Please enter a registration number', 'error'); return; }

        resultContainer.style.display = 'none';
        document.getElementById('bedResultContainer').style.display = 'none';
        showLoadingStage('connecting');
        addStatusMessage(`Fetching result for: ${regNum}`, 'info');
        semesterResults.innerHTML = '';
        gpaChartContainer.style.display = 'none';

        try {
          const response = await fetch(`${API_ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
          showLoadingStage('fetching');
          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.message || `Server responded with status ${response.status}`);
          }

          showLoadingStage('processing');

          if (data.resultData && data.resultData.length > 0) {
            addStatusMessage('Result fetched successfully from UAF LMS', 'success');
            isInitialLoad = true;
            const processed = processScrapedData(data);

            if (processed.hasBedCourses) {
              document.getElementById('bedConfirmYes').onclick = () => handleBedConfirm(true, processed);
              document.getElementById('bedConfirmNo').onclick = () => handleBedConfirm(false, processed);
              if (bedConfirmationModal) bedConfirmationModal.show();
            } else {
              handleBedConfirm(false, processed);
            }

          } else {
             throw new Error("No result records found for this registration number.");
          }
        } catch (error) {
            console.error("Fetch Error:", error);
            let userMessage, logMessage;

            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                userMessage = 'Network error. Please check your internet connection.';
                logMessage = 'Failed to fetch due to a network error. Ensure you are connected to the internet.';
            } else {
                 userMessage = `Could not retrieve results: ${error.message}`;
                 logMessage = `API/LMS Error: ${error.message}`;
            }

            addStatusMessage(logMessage, 'error');
            showToast(userMessage, 'error');
            showLoadingStage(null);
        }
      }

      // --- Event Listeners ---
      resultForm.addEventListener('submit', (e) => { e.preventDefault(); fetchResult(); });
      downloadLogBtn.addEventListener('click', downloadLog);
      clearLogBtn.addEventListener('click', clearLog);
      saveCourseBtn.addEventListener('click', addCustomCourse);
      profileSwitcher.addEventListener('change', switchProfile);
      
      saveProfileNameBtn.addEventListener('click', renameProfile); 
      
      document.getElementById('confirmationConfirmBtn').addEventListener('click', handleConfirm);

      // Main buttons
      downloadPdfBtn.addEventListener('click', generatePDF);
      addForecastSemesterBtn.addEventListener('click', addForecastSemester);

      // B.Ed. Tab buttons
      document.getElementById('bed-downloadPdfBtn').addEventListener('click', generatePDF);
      document.getElementById('bed-addForecastSemesterBtn').addEventListener('click', addForecastSemester);
      
      // Other Tab buttons
      document.getElementById('other-downloadPdfBtn').addEventListener('click', generatePDF);
      document.getElementById('other-addForecastSemesterBtn').addEventListener('click', addForecastSemester);

      setupAttendanceButton();
      importAttendanceCoursesBtn.addEventListener('click', importSelectedAttendanceCourses);

      importProfilesBtn.addEventListener('click', importProfiles);
      importProfilesBtnModal.addEventListener('click', importProfiles);
      exportProfilesBtnModal.addEventListener('click', exportSelectedProfiles);

      // Profile Manager Listeners
      openProfileManagerBtn.addEventListener('click', () => {
          renderProfileManager();
          profileManagerModal.show();
      });
      document.getElementById('selectAllProfiles').addEventListener('change', e => {
          document.querySelectorAll('.profile-checkbox').forEach(cb => cb.checked = e.target.checked);
          const anyChecked = e.target.checked;
           document.getElementById('bulkActionsBtn').disabled = !anyChecked;
           exportProfilesBtnModal.disabled = !anyChecked;
      });

        document.getElementById('profileManagerList').addEventListener('change', e => {
            if (e.target.classList.contains('profile-checkbox')) {
                const anyChecked = !!document.querySelector('.profile-checkbox:checked');
                document.getElementById('bulkActionsBtn').disabled = !anyChecked;
                exportProfilesBtnModal.disabled = !anyChecked;

                const allCheckboxes = document.querySelectorAll('.profile-checkbox');
                const allChecked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
                document.getElementById('selectAllProfiles').checked = allChecked;
                document.getElementById('selectAllProfiles').indeterminate = !allChecked && anyChecked;
            }
        });

      document.getElementById('deleteSelectedBtn').addEventListener('click', handleBulkAction);
      
      /* --- MODIFICATION: New exportProfilesBtn listener --- */
      exportProfilesBtn.addEventListener('click', () => {
        if (Object.keys(getProfiles()).length === 0) {
            showToast('No profiles available to export.', 'info');
            return;
        }
        renderProfileManager();
        profileManagerModal.show();
        showToast('Select profiles from the manager to export.', 'info');
      });

      // Initialize the application
      init();
    });

</script>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const qpTableContainer = document.getElementById('qpTableContainer');
  const qpTableImage = document.getElementById('qpTableImage');
  const lightbox = document.getElementById('imageLightbox');
  const lightboxContent = document.getElementById('lightboxContent');
  const lightboxClose = document.getElementById('lightboxClose');

  if (!qpTableContainer || !qpTableImage || !lightbox || !lightboxContent || !lightboxClose) {
      console.error("Lightbox elements not found!");
      return;
  }

  let lightboxImage = null;
  let isLightboxOpen = false;
  let isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)").matches;
  let currentTransform = { scale: 1, translateX: 0, translateY: 0 };
  let isPanning = false, isPinching = false;
  let start = { x: 0, y: 0 };
  let initialPinchDistance = 0;
  const desktopZoomLevel = 4.5;

  function applyTransform() {
    if (!lightboxImage) return;
    lightboxImage.style.transform = `translate(${currentTransform.translateX}px, ${currentTransform.translateY}px) scale(${currentTransform.scale})`;
  }

  function getDistance(p1, p2) {
    return Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY);
  }

  function getCenter(p1, p2) {
    return { x: (p1.clientX + p2.clientX) / 2, y: (p1.clientY + p2.clientY) / 2 };
  }

  function openLightbox() {
    if (isLightboxOpen) return;
    const imgClone = qpTableImage.cloneNode(true);
    imgClone.id = 'lightboxImage';
    imgClone.style.cssText = 'transform: none; transition: transform 0.15s ease-out; max-width: 95%; max-height: 95%; width: auto; height: auto;';
    lightboxContent.innerHTML = '';
    lightboxContent.appendChild(imgClone);
    lightboxImage = imgClone;

    isPanning = false; isPinching = false;
    currentTransform = { scale: 1, translateX: 0, translateY: 0 };
    applyTransform();

    lightbox.classList.add('show');
    document.body.style.overflow = 'hidden';
    isLightboxOpen = true;

    if (isDesktop) {
        setupDesktopLightboxInteraction();
    } else {
        setupMobileLightboxInteraction();
    }
  }

  function closeLightbox() {
    if (!isLightboxOpen) return;
    lightbox.classList.remove('show');
    document.body.style.overflow = '';
    isLightboxOpen = false;
    lightboxImage = null;
    removeDesktopLightboxInteraction();
    removeMobileLightboxInteraction();
  }

  const handleDesktopMouseMove = (e) => {
      if (!lightboxImage || !isLightboxOpen) return;
      const rect = lightboxImage.getBoundingClientRect();
      const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
      const yPercent = ((e.clientY - rect.top) / rect.height) * 100;
      lightboxImage.style.transformOrigin = `${xPercent}% ${yPercent}%`;
      lightboxImage.style.transform = `scale(${desktopZoomLevel})`;
  };

  const handleDesktopMouseLeave = () => {
      if (!lightboxImage || !isLightboxOpen) return;
      lightboxImage.style.transformOrigin = `center center`;
      lightboxImage.style.transform = `scale(1)`;
  };

  function setupDesktopLightboxInteraction() {
    if (!lightboxImage) return;
    lightboxContent.classList.add('desktop-zoom-active');
    lightboxImage.addEventListener('mousemove', handleDesktopMouseMove);
    lightboxImage.addEventListener('mouseleave', handleDesktopMouseLeave);
    lightboxContent.addEventListener('wheel', handleWheelZoom, { passive: false });
  }

  function removeDesktopLightboxInteraction() {
    if (lightboxImage) {
      lightboxImage.removeEventListener('mousemove', handleDesktopMouseMove);
      lightboxImage.removeEventListener('mouseleave', handleDesktopMouseLeave);
    }
    if (lightboxContent) {
      lightboxContent.classList.remove('desktop-zoom-active');
      lightboxContent.removeEventListener('wheel', handleWheelZoom);
    }
  }

  const handleTouchStart = (e) => {
    if (!lightboxImage || !isLightboxOpen) return;
    if (e.touches.length === 1 && currentTransform.scale > 1) {
      isPanning = true;
      start.x = e.touches[0].clientX - currentTransform.translateX;
      start.y = e.touches[0].clientY - currentTransform.translateY;
    } else if (e.touches.length === 2) {
      isPanning = false;
      isPinching = true;
      initialPinchDistance = getDistance(e.touches[0], e.touches[1]);
    }
  };

  const handleTouchMove = (e) => {
    if (!lightboxImage || !isLightboxOpen) return;
    e.preventDefault();
    if (isPanning && e.touches.length === 1) {
      currentTransform.translateX = e.touches[0].clientX - start.x;
      currentTransform.translateY = e.touches[0].clientY - start.y;
      applyTransform();
    } else if (isPinching && e.touches.length === 2) {
        const currentPinchDistance = getDistance(e.touches[0], e.touches[1]);
        const scaleChange = currentPinchDistance / initialPinchDistance;
        let potentialNewScale = currentTransform.scale * scaleChange;
        potentialNewScale = Math.max(1, Math.min(potentialNewScale, 10));
        const rect = lightboxImage.getBoundingClientRect();
        const touchCenterXVP = getCenter(e.touches[0], e.touches[1]).x;
        const touchCenterYVP = getCenter(e.touches[0], e.touches[1]).y;
        const originX = (touchCenterXVP - rect.left - currentTransform.translateX) / currentTransform.scale;
        const originY = (touchCenterYVP - rect.top - currentTransform.translateY) / currentTransform.scale;
        currentTransform.translateX += originX * currentTransform.scale - originX * potentialNewScale;
        currentTransform.translateY += originY * currentTransform.scale - originY * potentialNewScale;
        currentTransform.scale = potentialNewScale;
        applyTransform();
        initialPinchDistance = currentPinchDistance;
    }
  };

  const handleTouchEnd = (e) => {
    if (!lightboxImage || !isLightboxOpen) return;
    if (isPanning && e.touches.length === 0) { isPanning = false; }
    if (isPinching && e.touches.length < 2) {
      isPinching = false;
      if (currentTransform.scale <= 1.05) {
         currentTransform.scale = 1;
         currentTransform.translateX = 0;
         currentTransform.translateY = 0;
         lightboxImage.style.transition = 'transform 0.2s ease-out';
         applyTransform();
         setTimeout(() => {
              if (lightboxImage) lightboxImage.style.transition = 'transform 0.15s ease-out';
         }, 200);
      }
    }
  };

  function setupMobileLightboxInteraction() {
    if (!lightboxContent) return;
    lightboxContent.addEventListener('touchstart', handleTouchStart, { passive: false });
    lightboxContent.addEventListener('touchmove', handleTouchMove, { passive: false });
    lightboxContent.addEventListener('touchend', handleTouchEnd);
    lightboxContent.addEventListener('touchcancel', handleTouchEnd);
  }

  function removeMobileLightboxInteraction() {
    if (!lightboxContent) return;
    lightboxContent.removeEventListener('touchstart', handleTouchStart);
    lightboxContent.removeEventListener('touchmove', handleTouchMove);
    lightboxContent.removeEventListener('touchend', handleTouchEnd);
    lightboxContent.removeEventListener('touchcancel', handleTouchEnd);
  }

  const handleWheelZoom = (e) => {
      if (!lightboxImage || !isLightboxOpen) return;
      e.preventDefault();
      const rect = lightboxImage.getBoundingClientRect();
      const delta = e.deltaY > 0 ? -0.2 : 0.2;
      let potentialNewScale = currentTransform.scale + delta * currentTransform.scale;
      potentialNewScale = Math.max(1, Math.min(potentialNewScale, 10));
      const originX = (e.clientX - rect.left - currentTransform.translateX) / currentTransform.scale;
      const originY = (e.clientY - rect.top - currentTransform.translateY) / currentTransform.scale;
      currentTransform.translateX += originX * currentTransform.scale - originX * potentialNewScale;
      currentTransform.translateY += originY * currentTransform.scale - originY * potentialNewScale;
      currentTransform.scale = potentialNewScale;
      if (currentTransform.scale <= 1.05) {
          currentTransform.scale = 1;
          currentTransform.translateX = 0;
          currentTransform.translateY = 0;
      }
      applyTransform();
  };

  qpTableContainer.addEventListener('click', openLightbox);
  lightboxClose.addEventListener('click', closeLightbox);
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });
});
</script>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
  });

  async function checkServerStatuses() {
    const lmsItem = document.getElementById('lms-status-item');
    const attndItem = document.getElementById('attnd-status-item');
    const lmsDot = document.getElementById('lms-status-dot');
    const attndDot = document.getElementById('attnd-status-dot');

    if (!lmsItem || !attndItem || !lmsDot || !attndDot) return;

    try {
      const response = await fetch('/api/result-scraper?action=check_status', {
        cache: 'no-cache',
        signal: AbortSignal.timeout(15000)
      });
      
      if (!response.ok) {
        throw new Error('Status check API failed');
      }

      const data = await response.json();

      if (data.lms_status === 'online') {
        lmsDot.className = 'status-dot online';
        lmsDot.title = 'LMS is Online';
      } else {
        lmsDot.className = 'status-dot offline';
        lmsDot.title = 'LMS is Offline or Unreachable';
      }
      lmsItem.classList.add('status-loaded');

      if (data.attnd_status === 'online') {
        attndDot.className = 'status-dot online';
        attndDot.title = 'Attendance System is Online';
      } else {
        attndDot.className = 'status-dot offline';
        attndDot.title = 'Attendance System is Offline or has an Error';
      }
      attndItem.classList.add('status-loaded');

    } catch (error) {
      console.error('Failed to fetch server statuses:', error.name, error.message);
      
      lmsDot.className = 'status-dot offline';
      lmsDot.title = 'Status check failed';
      lmsItem.classList.add('status-loaded');

      attndDot.className = 'status-dot offline';
      attndDot.title = 'Status check failed';
      attndItem.classList.add('status-loaded');
    }
  }

  checkServerStatuses();
});
</script>

</body>
</html>






















